
<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Mobile Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --education: #8b5cf6;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-light: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .map-container {
            height: 100vh;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        /* App Header for Chat */
        .app-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.2rem;
            font-weight: 800;
        }
        
        .toggle-chat-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Chat Container as Side Panel */
        .chat-container {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 320px;
            height: 100vh;
            background: var(--glass);
            backdrop-filter: blur(20px);
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container.open {
            right: 0;
        }
        
        /* Chat Messages Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
        }
        
        .message {
            margin-bottom: 12px;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px 16px 16px 4px;
            padding: 12px 14px;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px 16px 4px 16px;
            padding: 12px 14px;
            font-size: 0.85rem;
            margin-left: auto;
            max-width: 85%;
        }
        
        /* Chat Input */
        .chat-input-container {
            padding: 12px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--glass-light);
        }
        
        .chat-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.85rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 80px;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
        }
        
        .send-btn {
            margin-top: 8px;
            padding: 10px 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 8px;
            width: calc(100% - 20px);
            max-width: 300px;
        }
        
        .search-box {
            flex: 1;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 14px;
            outline: none;
        }
        
        .search-btn {
            padding: 10px 12px;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
        }
        
        .location-btn, .filter-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }
        
        .home-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
            z-index: 1000;
        }
        
        /* Filter Panel */
        .filter-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 280px;
            height: 100vh;
            background: var(--glass);
            backdrop-filter: blur(20px);
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .filter-panel.open {
            right: 0;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .filter-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .filter-close-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .filter-option input {
            margin-right: 8px;
        }
        
        .filter-option label {
            font-size: 0.9rem;
        }
        
        .apply-filter-btn {
            margin-top: auto;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Property Markers */
        .property-marker {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            white-space: nowrap;
            text-align: center;
            opacity: 0.85;
            width: 60px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        .property-marker:hover {
            transform: scale(1.15);
            opacity: 1;
        }
        
        .property-marker.sale {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .property-marker.rent {
            border-color: var(--success);
            color: var(--success);
        }
        
        .property-marker.luxury {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        /* School and Hospital Markers */
        .school-marker, .hospital-marker {
            width: 28px !important;
            height: 28px !important;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .school-marker {
            background: var(--education);
        }
        
        .hospital-marker {
            background: var(--success);
        }
        
        /* Info Panels in Chat */
        .property-info, .proximity-info, .education-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .facility-list {
            margin-top: 8px;
        }
        
        .facility-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            margin: 4px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .facility-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .facility-distance {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }
        
        /* Tooltips and Popups */
        .leaflet-popup-content {
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .leaflet-popup-content p {
            margin: 4px 0;
        }
        
        .leaflet-popup-content button {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 8px 12px;
            color: var(--primary);
            font-style: italic;
            font-size: 0.8rem;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI analyzing'; }
            40% { content: 'AI analyzing.'; }
            60% { content: 'AI analyzing..'; }
            80%, 100% { content: 'AI analyzing...'; }
        }
        
        /* Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* Flash Screen Guide */
        .flash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            text-align: center;
            padding: 20px;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .flash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .flash-screen h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .flash-screen p {
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .flash-screen button {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Flash Screen Guide -->
    <div class="flash-screen" id="flashScreen">
        <h1>Welcome to PropertyIntel Kigali</h1>
        <p>Explore properties in Kigali with ease.</p>
        <p>Use the search bar to find locations, tap markers to view property details, or use the filter button to narrow down property types.</p>
        <p>Click "Ask more questions" on a property to chat with our AI for insights!</p>
        <button onclick="hideFlashScreen()">Get Started</button>
    </div>
    
    <!-- Map Container -->
    <div class="map-container">
        <!-- Map Controls -->
        <div class="map-controls">
            <div class="search-box">
                <input type="text" id="locationSearch" class="search-input" 
                       placeholder="Search in Kigali..." aria-label="Search location">
                <button id="searchBtn" class="search-btn" aria-label="Search">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <button id="locationBtn" class="location-btn" aria-label="Current location">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button id="filterBtn" class="filter-btn" aria-label="Filter properties">
                <i class="fas fa-filter"></i>
            </button>
        </div>
        
        <!-- Home Button -->
        <button id="homeBtn" class="home-btn" aria-label="Reset to home view">
            <i class="fas fa-home"></i>
        </button>
        
        <div id="map"></div>
    </div>
    
    <!-- Chat Container (Side Panel) -->
    <div class="chat-container" id="chatContainer">
        <!-- App Header -->
        <div class="app-header">
            <div class="app-title">PropertyIntel Kigali</div>
            <button class="toggle-chat-btn" onclick="closeChat()" aria-label="Close chat">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="typing-indicator" id="typingIndicator"></div>
            
            <!-- Chat Input -->
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" 
                          placeholder="Ask about this property..." 
                          rows="1" aria-label="Ask about property"></textarea>
                <button class="send-btn" id="sendBtn" aria-label="Send message">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
            <div class="filter-title">Filter Properties</div>
            <button class="filter-close-btn" onclick="closeFilterPanel()" aria-label="Close filter">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-option">
            <input type="checkbox" id="saleFilter" checked>
            <label for="saleFilter">For Sale</label>
        </div>
        <div class="filter-option">
            <input type="checkbox" id="rentFilter" checked>
            <label for="rentFilter">For Rent</label>
        </div>
        <div class="filter-option">
            <input type="checkbox" id="luxuryFilter" checked>
            <label for="luxuryFilter">Luxury</label>
        </div>
        <button class="apply-filter-btn" onclick="applyFilters()">Apply Filters</button>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class PropertyIntelSystem {
            constructor() {
                this.map = null;
                this.currentProperty = null;
                this.facilities = [];
                this.schools = [];
                this.propertyMarkers = [];
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.nearbyHospitals = [];
                this.nearbySchools = [];
                this.isSending = false;
                
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m¬≤', yearBuilt: 2022, district: 'Nyarugenge', amenities: ['Pool', 'Gym', 'Security', 'Parking'] },
                    { id: 2, lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m¬≤', yearBuilt: 2019, district: 'Nyarugenge', amenities: ['Security', 'Parking'] },
                    { id: 3, lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Garden', 'Pool', 'Security', 'Garage'] },
                    { id: 4, lat: -1.9356, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 5, lat: -1.9416, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security', 'Balcony'] },
                    { id: 6, lat: -1.9634, lng: 30.0929, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m¬≤', yearBuilt: 2017, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 7, lat: -1.9604, lng: 30.0959, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Pool', 'Garden', 'Security', 'Smart Home'] },
                    { id: 8, lat: -1.9564, lng: 30.0899, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['River View', 'Security'] },
                    { id: 9, lat: -1.9456, lng: 30.1212, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Parking', 'Security'] },
                    { id: 10, lat: -1.9486, lng: 30.1242, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Gym', 'Security', 'Parking'] },
                    { id: 11, lat: -1.9756, lng: 30.0729, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m¬≤', yearBuilt: 2019, district: 'Kicukiro', amenities: ['Garden', 'Security', 'Workshop'] },
                    { id: 12, lat: -1.9686, lng: 30.0759, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m¬≤', yearBuilt: 2016, district: 'Kicukiro', amenities: ['Parking'] },
                    { id: 13, lat: -1.9606, lng: 30.0529, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m¬≤', yearBuilt: 2018, district: 'Nyarugenge', amenities: ['Garden', 'Traditional Design'] },
                    { id: 14, lat: -1.9536, lng: 30.0499, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m¬≤', yearBuilt: 2017, district: 'Nyarugenge', amenities: ['Garden', 'Cultural Features'] },
                    { id: 15, lat: -1.9256, lng: 30.0919, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m¬≤', yearBuilt: 2024, district: 'Gasabo', amenities: ['Pool', 'Gym', 'Cinema', 'Smart Home', 'Wine Cellar'] },
                    { id: 16, lat: -1.9186, lng: 30.0889, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m¬≤', yearBuilt: 2022, district: 'Gasabo', amenities: ['View', 'Security', 'Garden'] },
                    { id: 17, lat: -1.9706, lng: 30.1059, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Study Area', 'Internet'] },
                    { id: 18, lat: -1.9636, lng: 30.1029, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 19, lat: -1.9356, lng: 30.1112, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Golf Access', 'Pool', 'Tennis Court', 'Spa'] },
                    { id: 20, lat: -1.9286, lng: 30.1082, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Golf View', 'Security', 'Gym'] }
                ];
                
                this.init();
            }
            
            async init() {
                await this.loadFacilities();
                await this.loadSchools();
                this.initializeMap();
                this.setupEventListeners();
                this.showFlashScreen();
            }
            
            async loadFacilities() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.facilities = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.lat && 
                            feature.attributes.long
                        ).map(feature => ({
                            facility_name: feature.attributes.facility_name || 'Unknown',
                            facility_type: feature.attributes.facility_type || 'Unknown',
                            lat: feature.attributes.lat,
                            long: feature.attributes.long,
                            district: feature.attributes.district || 'N/A',
                            sector: feature.attributes.sector || 'N/A',
                            ownership: feature.attributes.ownership || 'N/A'
                        }));
                    }
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                    this.facilities = [
                        { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo" },
                        { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge" },
                        { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro" }
                    ];
                }
            }
            
            async loadSchools() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.schools = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.latitude && 
                            feature.attributes.longitude
                        ).map(feature => ({
                            school_name: feature.attributes.school_nam || 'Unknown School',
                            school_type: feature.attributes.school_typ || 'Unknown',
                            school_category: feature.attributes.school_cat || 'PRE_PRIMARY',
                            school_status: feature.attributes.school_sta || 'Unknown',
                            curriculum: feature.attributes.curriculum || 'National',
                            lat: feature.attributes.latitude,
                            lng: feature.attributes.longitude,
                            established: feature.attributes.establishm || 'N/A'
                        }));
                    }
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    this.schools = [
                        { school_name: "ITETERO NURSERY SCHOOL", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9489, lng: 30.0000, established: 2009 },
                        { school_name: "Green Hills Academy", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "INTERNATIONAL", lat: -1.9556, lng: 30.1044, established: 2006 },
                        { school_name: "Kigali Parents School", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9386, lng: 30.0619, established: 2010 }
                    ];
                }
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
                
                this.addProperties();
                this.prepareHospitals();
                this.prepareSchools();
                
                this.map.on('click', this.handleMapClick.bind(this));
                
                new ResizeObserver(() => this.map.invalidateSize()).observe(document.getElementById('map'));
            }
            
            addProperties() {
                this.propertyMarkers = [];
                
                this.properties.forEach((prop) => {
                    const isLuxury = prop.type.toLowerCase().includes('luxury');
                    const markerClass = `property-marker ${prop.status} ${isLuxury ? 'luxury' : ''}`;
                    
                    const priceLabel = prop.price.replace(' RWF', '').replace('M', '');
                    
                    const marker = L.marker([prop.lat, prop.lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: priceLabel,
                            iconSize: [60, 24],
                            iconAnchor: [30, 12],
                            popupAnchor: [0, -12]
                        })
                    });
                    
                    const popupContent = `
                        <div>
                            <h3>${prop.name}</h3>
                            <p><strong>Type:</strong> ${prop.type}</p>
                            <p><strong>Price:</strong> ${prop.price}</p>
                            <p><strong>Bedrooms:</strong> ${prop.bedrooms}</p>
                            <p><strong>Bathrooms:</strong> ${prop.bathrooms}</p>
                            <p><strong>Area:</strong> ${prop.area}</p>
                            <p><strong>District:</strong> ${prop.district}</p>
                            <p><strong>Amenities:</strong> ${prop.amenities.join(', ')}</p>
                            <button onclick="propertyIntel.openChat(${prop.id})">Ask more questions</button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    
                    marker.addTo(this.map);
                    
                    this.propertyMarkers.push({
                        marker: marker,
                        property: prop
                    });
                });
            }
            
            prepareHospitals() {
                this.hospitalMarkers = this.facilities.map(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: 'üè•',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üè• ${facility.facility_name}</div>
                        <div style="margin-bottom: 2px;">üìã ${facility.facility_type}</div>
                        <div>üìç ${facility.district}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    return marker;
                });
            }
            
            prepareSchools() {
                this.schoolMarkers = this.schools.map(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: 'üéì',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üéì ${school.school_name}</div>
                        <div style="margin-bottom: 2px;">üìö ${school.school_status} School</div>
                        <div style="margin-bottom: 2px;">üìñ ${school.curriculum} Curriculum</div>
                        <div>üìÖ Est. ${school.established}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    return marker;
                });
            }
            
            showFlashScreen() {
                const flashScreen = document.getElementById('flashScreen');
                setTimeout(() => {
                    flashScreen.classList.add('hidden');
                }, 5000); // Hide after 5 seconds
            }
            
            openChat(id) {
                const prop = this.properties.find(p => p.id === id);
                if (!prop) return;
                
                this.currentProperty = prop;
                this.analyzeProperty(prop);
                this.map.closePopup();
                this.map.setView([prop.lat, prop.lng], 15);
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.classList.add('open');
                
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = `Ask about ${prop.name}...`;
                chatInput.focus();
            }
            
            analyzeProperty(property) {
                this.clearNearbyMarkers();
                this.analyzeProximity(property);
                this.displayPropertyAnalysis(property);
                this.showNearbyFacilities(property);
            }
            
            clearNearbyMarkers() {
                this.hospitalMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) this.map.removeLayer(marker);
                });
                this.schoolMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) this.map.removeLayer(marker);
                });
            }
            
            showNearbyFacilities(property) {
                this.nearbyHospitals.forEach((hospital, index) => {
                    this.hospitalMarkers[index].addTo(this.map);
                });
                this.nearbySchools.forEach((school, index) => {
                    this.schoolMarkers[index].addTo(this.map);
                });
            }
            
            analyzeProximity(property) {
                this.nearbyHospitals = this.facilities
                    .map(facility => ({
                        ...facility,
                        distance: L.latLng(property.lat, property.lng).distanceTo([facility.lat, facility.long]) / 1000
                    }))
                    .filter(f => f.distance <= 3)
                    .sort((a, b) => a.distance - b.distance);
                
                this.nearbySchools = this.schools
                    .map(school => ({
                        ...school,
                        distance: L.latLng(property.lat, property.lng).distanceTo([school.lat, school.lng]) / 1000
                    }))
                    .filter(s => s.distance <= 2)
                    .sort((a, b) => a.distance - b.distance);
            }
            
            displayPropertyAnalysis(property) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                let propertyHtml = `
                    <div class="property-info">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">${property.name}</h3>
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> ${property.type}</div>
                        <div style="margin-bottom: 6px;"><strong>Price:</strong> ${property.price}</div>
                        <div style="margin-bottom: 6px;"><strong>Size:</strong> ${property.bedrooms}BR ‚Ä¢ ${property.bathrooms}BA ‚Ä¢ ${property.area}</div>
                        <div style="margin-bottom: 6px;"><strong>Built:</strong> ${property.yearBuilt}</div>
                        <div style="margin-bottom: 6px;"><strong>District:</strong> ${property.district}</div>
                        <div><strong>Amenities:</strong> ${property.amenities ? property.amenities.join(', ') : 'Standard'}</div>
                    </div>`;
                
                messagesContainer.innerHTML += propertyHtml;
                
                if (this.nearbySchools.length > 0) {
                    let schoolHtml = `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">üéì Education Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbySchools.length} schools within 2km</p>
                            <div class="facility-list">`;
                    
                    this.nearbySchools.slice(0, 5).forEach(school => {
                        schoolHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${school.lat}, ${school.lng})">
                                <div class="facility-name">${school.school_name}</div>
                                <div class="facility-distance">${(school.distance * 1000).toFixed(0)}m</div>
                            </div>`;
                    });
                    
                    schoolHtml += `</div></div>`;
                    messagesContainer.innerHTML += schoolHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Education Access</h4>
                            <p>No schools within 2km walking distance.</p>
                        </div>`;
                }
                
                if (this.nearbyHospitals.length > 0) {
                    let hospitalHtml = `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">üè• Healthcare Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbyHospitals.length} health facilities within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbyHospitals.slice(0, 5).forEach(hospital => {
                        hospitalHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${hospital.lat}, ${hospital.long})">
                                <div class="facility-name">${hospital.facility_name}</div>
                                <div class="facility-distance">${hospital.distance.toFixed(1)}km</div>
                            </div>`;
                    });
                    
                    hospitalHtml += `</div></div>`;
                    messagesContainer.innerHTML += hospitalHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Healthcare Access</h4>
                            <p>No hospitals within 3km radius.</p>
                        </div>`;
                }
                
                this.scrollToBottom();
            }
            
            focusLocation(lat, lng) {
                this.map.setView([lat, lng], 16);
                document.getElementById('chatContainer').classList.remove('open');
            }
            
            handleMapClick(e) {
                this.clearNearbyMarkers();
                document.getElementById('filterPanel').classList.remove('open');
            }
            
            resetMapView() {
                this.map.setView([-1.9441, 30.0619], 11);
                this.clearNearbyMarkers();
                this.applyFilters();
            }
            
            applyFilters() {
                const saleFilter = document.getElementById('saleFilter').checked;
                const rentFilter = document.getElementById('rentFilter').checked;
                const luxuryFilter = document.getElementById('luxuryFilter').checked;
                
                this.propertyMarkers.forEach(({ marker, property }) => {
                    const isLuxury = property.type.toLowerCase().includes('luxury');
                    const showMarker = 
                        (saleFilter && property.status === 'sale' && !isLuxury) ||
                        (rentFilter && property.status === 'rent' && !isLuxury) ||
                        (luxuryFilter && isLuxury);
                    
                    if (showMarker && !this.map.hasLayer(marker)) {
                        marker.addTo(this.map);
                    } else if (!showMarker && this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                
                document.getElementById('filterPanel').classList.remove('open');
            }
            
            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const locationSearch = document.getElementById('locationSearch');
                const searchBtn = document.getElementById('searchBtn');
                const locationBtn = document.getElementById('locationBtn');
                const homeBtn = document.getElementById('homeBtn');
                const filterBtn = document.getElementById('filterBtn');
                
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
                
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                
                locationSearch.addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.performLocationSearch();
                });
                
                searchBtn.addEventListener('click', () => this.performLocationSearch());
                locationBtn.addEventListener('click', () => this.useCurrentLocation());
                homeBtn.addEventListener('click', () => this.resetMapView());
                filterBtn.addEventListener('click', () => {
                    document.getElementById('filterPanel').classList.toggle('open');
                });
            }
            
            async performLocationSearch() {
                const locationSearch = document.getElementById('locationSearch');
                const location = locationSearch.value.trim();
                if (!location) return;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const { lat, lon } = results[0];
                        this.map.setView([lat, lon], 16);
                    } else {
                        alert('Location not found in Kigali');
                    }
                } catch (error) {
                    alert('Search failed. Please try again.');
                }
            }
            
            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        this.map.setView([lat, lng], 15);
                    },
                    error => {
                        alert('Unable to get location');
                    }
                );
            }
            
            sendMessage() {
                if (this.isSending || !this.currentProperty) return;
                this.isSending = true;
                
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message) {
                    this.isSending = false;
                    return;
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.generateAIResponse(message, this.currentProperty);
                    this.isSending = false;
                }, 1500);
                
                this.scrollToBottom();
            }
            
            generateAIResponse(question, property) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('school') || lowerQuestion.includes('education')) {
                    response = this.generateSchoolResponse(property);
                } else if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                    response = this.generateHealthResponse(property);
                } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('investment')) {
                    response = this.generatePriceResponse(property);
                } else if (lowerQuestion.includes('family') || lowerQuestion.includes('children')) {
                    response = this.generateFamilyResponse(property);
                } else {
                    response = this.generateGeneralResponse(property);
                }
                
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                
                this.scrollToBottom();
            }
            
            generateSchoolResponse(property) {
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>üéì Education Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbySchools.length > 0) {
                    response += `Found <strong>${this.nearbySchools.length} schools</strong> within 2km:<br><br>`;
                    
                    this.nearbySchools.slice(0, 3).forEach(school => {
                        const walkTime = Math.round(school.distance * 12);
                        response += `üìö <strong>${school.school_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${school.school_status} (${school.curriculum})<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${(school.distance * 1000).toFixed(0)}m (~${walkTime} min walk)<br><br>`;
                    });
                } else {
                    response += `No schools within 2km.<br><br>`;
                    response += `<strong>Recommendations:</strong><br>‚Ä¢ Consider transport for school.`;
                }
                
                return response;
            }
            
            generateHealthResponse(property) {
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>üè• Healthcare Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbyHospitals.length > 0) {
                    response += `<strong>${this.nearbyHospitals.length} facilities</strong> within 3km:<br><br>`;
                    
                    this.nearbyHospitals.slice(0, 3).forEach(hospital => {
                        response += `üè• <strong>${hospital.facility_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${hospital.facility_type}<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${hospital.distance.toFixed(1)}km<br><br>`;
                    });
                } else {
                    response += `No facilities within 3km.<br><br>`;
                    response += `<strong>Considerations:</strong><br>‚Ä¢ Emergency response may be slower.`;
                }
                
                return response;
            }
            
            generatePriceResponse(property) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                let response = `<h4>üí∞ Investment Analysis</h4><br>`;
                
                response += `<strong>Price:</strong> ${property.price}<br>`;
                response += `<strong>Per m¬≤:</strong> ${Math.round(priceValue * 1000000 / parseInt(property.area))} RWF/m¬≤<br><br>`;
                
                let investmentScore = 60 + Math.min(this.nearbySchools.length * 5, 15) + Math.min(this.nearbyHospitals.length * 3, 10);
                response += `<strong>Score: ${Math.min(investmentScore, 100)}/100</strong><br><br>`;
                
                if (property.status === 'sale') {
                    const estimatedRent = Math.round(priceValue * 0.5);
                    response += `Estimated monthly rent: ${estimatedRent}K RWF<br>`;
                }
                
                return response;
            }
            
            generateFamilyResponse(property) {
                let response = `<h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Suitability</h4><br>`;
                
                let familyScore = 50 + (property.bedrooms >= 3 ? 15 : 10) + (this.nearbySchools.length >= 1 ? 10 : 0) + (this.nearbyHospitals.length >= 1 ? 5 : 0);
                response += `<strong>Score: ${Math.min(familyScore, 100)}/100</strong><br><br>`;
                
                response += `Space: ${property.bedrooms}BR, ${property.area}<br>`;
                response += `Schools: ${this.nearbySchools.length} nearby<br>`;
                response += `Health: ${this.nearbyHospitals.length} facilities<br>`;
                
                return response;
            }
            
            generateGeneralResponse(property) {
                let response = `<h4>üè† Overview</h4><br>`;
                
                response += `Ask about: education, healthcare, price, or family suitability.<br><br>`;
                response += `Quick Facts:<br>‚Ä¢ Location: ${property.district}<br>‚Ä¢ Built: ${property.yearBuilt}`;
                
                return response;
            }
            
            showTyping() {
                document.getElementById('typingIndicator').classList.add('show');
            }
            
            hideTyping() {
                document.getElementById('typingIndicator').classList.remove('show');
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        }
        
        let propertyIntel = null;
        
        function closeChat() {
            document.getElementById('chatContainer').classList.remove('open');
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            propertyIntel.clearNearbyMarkers();
        }
        
        function closeFilterPanel() {
            document.getElementById('filterPanel').classList.remove('open');
        }
        
        function applyFilters() {
            propertyIntel.applyFilters();
        }
        
        function hideFlashScreen() {
            document.getElementById('flashScreen').classList.add('hidden');
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            propertyIntel = new PropertyIntelSystem();
        });
    </script>
</body>
</html>
