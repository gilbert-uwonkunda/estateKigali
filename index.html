<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Find Your Perfect Home Near Schools</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #1a1a2e;
            color: #fff;
        }

        #map {
            flex: 3;
            height: 100%;
            background: #162447;
            transition: all 0.3s ease;
        }

        #map.fullscreen {
            flex: 1 !important;
            width: 100% !important;
        }

        #chatPanel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            max-width: 400px;
        }

        #chatPanel.collapsed {
            max-width: 50px;
            min-width: 50px;
        }

        #chatPanel.collapsed #chatContent {
            display: none;
        }

        #chatHeader {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        #chatMessages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user {
            background: #667eea;
            align-self: flex-end;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.15);
            align-self: flex-start;
        }

        .message-content {
            word-wrap: break-word;
        }

        #chatInputContainer {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        #chatInput {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            resize: none;
            font-size: 14px;
        }

        #chatInput:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        #sendButton {
            margin-top: 10px;
            padding: 10px;
            width: 100%;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        #sendButton:disabled {
            background: #4b5a8a;
            cursor: not-allowed;
        }

        #sendButton:hover:not(:disabled) {
            background: #5468d6;
        }

        #typingIndicator {
            display: none;
            font-style: italic;
            color: #aaa;
            margin-left: 15px;
        }

        #controlPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 300px;
            width: 100%;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .control-group select,
        .control-group input[type="range"],
        .control-group input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .control-group input[type="range"] {
            padding: 0;
        }

        #priceRangeValue {
            font-size: 12px;
            margin-top: 5px;
            color: #ccc;
        }

        .map-control-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 5px;
            padding: 10px;
            color: #fff;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.3s;
        }

        .map-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .layer-control {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
        }

        .layer-control label {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-bottom: 8px;
            color: #fff;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 8px;
        }

        .stats-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            max-width: 300px;
        }

        .stats-panel p {
            margin: 5px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #map {
                flex: 1;
                height: 60%;
            }

            #chatPanel {
                flex: none;
                height: 40%;
                max-width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            #controlPanel {
                max-width: 100%;
                left: 0;
                top: 0;
                border-radius: 0 0 10px 10px;
            }

            .stats-panel {
                bottom: 50px;
                left: 0;
                max-width: 100%;
                border-radius: 10px 10px 0 0;
            }
        }

        .property-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            max-width: 200px;
        }

        .hospital-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            max-width: 200px;
        }

        .school-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            max-width: 200px;
        }

        .property-marker.sale {
            animation: glowSale 2s infinite;
        }

        .property-marker.rent {
            animation: glowRent 2s infinite;
        }

        .property-marker.luxury {
            animation: glowLuxury 2s infinite;
        }

        @keyframes glowSale {
            0% {
                box-shadow: 0 0 5px #667eea;
            }
            50% {
                box-shadow: 0 0 15px #667eea;
            }
            100% {
                box-shadow: 0 0 5px #667eea;
            }
        }

        @keyframes glowRent {
            0% {
                box-shadow: 0 0 5px #00ff88;
            }
            50% {
                box-shadow: 0 0 15px #00ff88;
            }
            100% {
                box-shadow: 0 0 5px #00ff88;
            }
        }

        @keyframes glowLuxury {
            0% {
                box-shadow: 0 0 5px #ff6b6b;
            }
            50% {
                box-shadow: 0 0 15px #ff6b6b;
            }
            100% {
                box-shadow: 0 0 5px #ff6b6b;
            }
        }

        .school-marker {
            animation: flashSchool 3s ease-in-out;
        }

        @keyframes flashSchool {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="map-control-btn" onclick="toggleFullscreen()" aria-label="Toggle fullscreen">
        <i class="fas fa-expand" id="fullscreenIcon"></i>
    </button>
    <button class="map-control-btn" style="top: 60px;" onclick="switchMapStyle()" aria-label="Switch map style">
        <i class="fas fa-layer-group" id="mapStyleIcon"></i>
    </button>
    <button class="map-control-btn" style="top: 110px;" onclick="getUserLocation()" aria-label="Get my location">
        <i class="fas fa-map-marker-alt"></i>
    </button>
    <div class="layer-control">
        <label><input type="checkbox" id="hospitalsLayer" checked onchange="spatialSystem.toggleLayer('hospitals')"> Hospitals</label>
        <label><input type="checkbox" id="schoolsLayer" checked onchange="spatialSystem.toggleLayer('schools')"> Schools</label>
        <label><input type="checkbox" id="heatmapLayer" onchange="spatialSystem.toggleLayer('heatmap')"> Heatmap</label>
        <label><input type="checkbox" id="transportLayer" onchange="spatialSystem.toggleLayer('transport')"> Transport</label>
    </div>
    <div id="controlPanel">
        <div class="control-group">
            <label for="propertyStatus">Property Status</label>
            <select id="propertyStatus" onchange="spatialSystem.filterProperties()">
                <option value="all">All</option>
                <option value="sale">For Sale</option>
                <option value="rent">For Rent</option>
            </select>
        </div>
        <div class="control-group">
            <label for="propertyType">Property Type</label>
            <select id="propertyType" onchange="spatialSystem.filterProperties()">
                <option value="all">All</option>
                <option value="villa">Villa</option>
                <option value="apartment">Apartment</option>
                <option value="house">House</option>
                <option value="luxury">Luxury</option>
            </select>
        </div>
        <div class="control-group">
            <label for="priceRange">Price Range (RWF)</label>
            <input type="range" id="priceRange" min="500000" max="50000000" value="50000000" step="500000" oninput="spatialSystem.updatePriceRange()">
            <div id="priceRangeValue">Up to 50M RWF</div>
        </div>
        <div class="control-group">
            <label for="locationSearch">Search Location</label>
            <input type="text" id="locationSearch" placeholder="Enter a landmark or address" oninput="spatialSystem.debounceSearchLocation()">
        </div>
    </div>
    <div class="stats-panel">
        <p><i class="fas fa-home"></i> Properties: <span id="propertyCount">0</span></p>
        <p><i class="fas fa-hospital"></i> Hospitals: <span id="hospitalCount">0</span></p>
        <p><i class="fas fa-graduation-cap"></i> Schools: <span id="schoolCount">0</span></p>
        <p><i class="fas fa-money-bill-wave"></i> Avg Price: <span id="avgPrice">0</span> RWF</p>
    </div>
    <div id="chatPanel">
        <div id="chatHeader">
            <span>PropertyIntel AI</span>
            <button onclick="toggleChatPanel()" aria-label="Toggle chat panel">
                <i class="fas fa-chevron-right" id="chatToggleIcon"></i>
            </button>
        </div>
        <div id="chatContent">
            <div id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Welcome to PropertyIntel Kigali! üèôÔ∏è<br><br>
                        I‚Äôm here to help you find the perfect property in Kigali, with insights on proximity to schools, healthcare, and more. Click on a property marker to analyze it or ask me about schools, family suitability, or investment potential!
                    </div>
                </div>
            </div>
            <div id="chatInputContainer">
                <textarea id="chatInput" rows="1" placeholder="Ask about the selected property..." disabled></textarea>
                <button id="sendButton" onclick="spatialSystem.sendMessage()" disabled>Send</button>
                <div id="typingIndicator">AI is typing...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        class SpatialIntelligenceSystem {
            constructor() {
                this.map = null;
                this.markerCluster = null;
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, type: 'villa', status: 'sale', price: '25M RWF', district: 'Gasabo', bedrooms: 4, bathrooms: 3 },
                    { id: 2, lat: -1.935, lng: 30.08, type: 'apartment', status: 'rent', price: '800K RWF/month', district: 'Nyarugenge', bedrooms: 2, bathrooms: 1 },
                    { id: 3, lat: -1.95, lng: 30.1, type: 'house', status: 'sale', price: '18M RWF', district: 'Kicukiro', bedrooms: 3, bathrooms: 2 },
                    { id: 4, lat: -1.93, lng: 30.05, type: 'luxury', status: 'sale', price: '45M RWF', district: 'Gasabo', bedrooms: 5, bathrooms: 4 },
                ];
                this.facilities = [
                    { facility_name: 'King Faisal Hospital', facility_type: 'Hospital', lat: -1.9366, long: 30.0597 },
                    { facility_name: 'CHUK', facility_type: 'Hospital', lat: -1.9556, long: 30.0602 },
                    { facility_name: 'Kibagabaga Hospital', facility_type: 'Hospital', lat: -1.9361, long: 30.0914 }
                ];
                this.schools = [];
                this.currentProperty = null;
                this.isSending = false;
                this.isMapFullscreen = false;
                this.isChatCollapsed = false;
                this.currentMapStyle = 'street';
                this.layerVisibility = {
                    hospitals: true,
                    schools: true,
                    heatmap: false,
                    transport: false
                };
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.routeLayers = {
                    driving: null,
                    walking: null
                };
                this.orsApiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjM1OGE4ZTYyMWRjMzQ4OWJhNTAxZTUxMTZjNWQzZDdkIiwiaCI6Im11cm11cjY0In0=';
                this.searchTimeout = null;
                this.destinationCoords = null;
            }

            async init() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 13);
                this.markerCluster = L.markerClusterGroup();
                this.addMapLayer();
                this.addProperties();
                await this.loadFacilities();
                await this.loadSchools();
                this.addHospitals();
                this.addSchools();
                this.updateStats();
                this.map.addLayer(this.markerCluster);
                this.setupEventListeners();
            }

            addMapLayer() {
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                });
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
                });
                if (this.currentMapStyle === 'street') {
                    streetLayer.addTo(this.map);
                } else {
                    satelliteLayer.addTo(this.map);
                }
            }

            switchMapStyle() {
                this.currentMapStyle = this.currentMapStyle === 'street' ? 'satellite' : 'street';
                this.map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) {
                        this.map.removeLayer(layer);
                    }
                });
                this.addMapLayer();
                document.getElementById('mapStyleIcon').className = this.currentMapStyle === 'street' ? 'fas fa-layer-group' : 'fas fa-satellite';
            }

            addProperties() {
                this.properties.forEach(property => {
                    const marker = L.marker([property.lat, property.lng], {
                        icon: L.divIcon({
                            className: `property-marker ${property.status}`,
                            html: `<div style="width: 20px; height: 20px; background: ${property.status === 'sale' ? '#667eea' : property.status === 'rent' ? '#00ff88' : '#ff6b6b'}; border: 3px solid white; border-radius: 50%;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    const tooltipContent = `
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #fff;">
                            ${property.type.charAt(0).toUpperCase() + property.type.slice(1)} ${property.status === 'sale' ? 'for Sale' : 'for Rent'}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="opacity: 0.9;">Price:</span>
                            <span style="font-weight: 500;">${property.price}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="opacity: 0.9;">District:</span>
                            <span>${property.district}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="opacity: 0.9;">Bedrooms:</span>
                            <span>${property.bedrooms}</span>
                        </div>
                    `;
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        className: 'property-tooltip',
                        permanent: false,
                        sticky: true
                    });
                    marker.on('click', () => this.analyzeProperty(property));
                    this.markerCluster.addLayer(marker);
                });
            }

            async loadFacilities() {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/codeforrwanda/health-facilities/main/health_facilities.json');
                    this.facilities = await response.json();
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                }
                console.log(`Loaded ${this.facilities.length} facilities`);
            }

            async loadSchools() {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/codeforrwanda/school-mapping/main/Pre_Primary.json');
                    this.schools = await response.json();
                } catch (error) {
                    console.error('Failed to load schools:', error);
                }
                console.log(`Loaded ${this.schools.length} schools`);
            }

            addHospitals() {
                this.hospitalMarkers = [];
                this.facilities.forEach(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: `<div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00ff88, #00cc6a); border: 3px solid white; border-radius: 50%;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    const tooltipContent = `
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #fff;">
                            <i class="fas fa-hospital" style="margin-right: 6px; color: #00ff88;"></i>
                            ${facility.facility_name}
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="opacity: 0.9;">Type:</span>
                            <span style="font-weight: 500;">${facility.facility_type}</span>
                        </div>
                    `;
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        className: 'hospital-tooltip',
                        permanent: false,
                        sticky: true
                    });
                    if (this.layerVisibility.hospitals) {
                        marker.addTo(this.map);
                    }
                    this.hospitalMarkers.push(marker);
                });
                console.log(`Added ${this.hospitalMarkers.length} hospital markers`);
            }

            addSchools() {
                this.schoolMarkers = [];
                this.schools.forEach(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: `<div style="width: 22px; height: 22px; background: linear-gradient(135deg, #4CAF50, #2E7D32); border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px;">üéì</div>`,
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        })
                    });
                    const tooltipContent = `
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #fff;">
                            <i class="fas fa-graduation-cap" style="margin-right: 6px; color: #4CAF50;"></i>
                            ${school.school_name}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="opacity: 0.9;">Type:</span>
                            <span style="font-weight: 500;">${school.school_type}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="opacity: 0.9;">Status:</span>
                            <span>${school.school_status}</span>
                        </div>
                    `;
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        className: 'school-tooltip',
                        permanent: false,
                        sticky: true
                    });
                    if (this.layerVisibility.schools) {
                        marker.addTo(this.map);
                    }
                    this.schoolMarkers.push(marker);
                });
                console.log(`Added ${this.schoolMarkers.length} school markers`);
            }

            toggleLayer(layer) {
                this.layerVisibility[layer] = !this.layerVisibility[layer];
                if (layer === 'hospitals') {
                    this.hospitalMarkers.forEach(marker => {
                        if (this.layerVisibility.hospitals) {
                            marker.addTo(this.map);
                        } else {
                            this.map.removeLayer(marker);
                        }
                    });
                } else if (layer === 'schools') {
                    this.schoolMarkers.forEach(marker => {
                        if (this.layerVisibility.schools) {
                            marker.addTo(this.map);
                        } else {
                            this.map.removeLayer(marker);
                        }
                    });
                } else if (layer === 'heatmap') {
                    alert('Heatmap layer is not implemented yet.');
                } else if (layer === 'transport') {
                    alert('Transport layer is not implemented yet.');
                }
            }

            filterProperties() {
                const status = document.getElementById('propertyStatus').value;
                const type = document.getElementById('propertyType').value;
                const maxPrice = parseInt(document.getElementById('priceRange').value);
                this.markerCluster.clearLayers();
                this.properties.forEach(property => {
                    const priceValue = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('month') ? 1000 : 1000000);
                    if ((status === 'all' || property.status === status) &&
                        (type === 'all' || property.type === type) &&
                        priceValue <= maxPrice) {
                        const marker = L.marker([property.lat, property.lng], {
                            icon: L.divIcon({
                                className: `property-marker ${property.status}`,
                                html: `<div style="width: 20px; height: 20px; background: ${property.status === 'sale' ? '#667eea' : property.status === 'rent' ? '#00ff88' : '#ff6b6b'}; border: 3px solid white; border-radius: 50%;"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        });
                        const tooltipContent = `
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #fff;">
                                ${property.type.charAt(0).toUpperCase() + property.type.slice(1)} ${property.status === 'sale' ? 'for Sale' : 'for Rent'}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="opacity: 0.9;">Price:</span>
                                <span style="font-weight: 500;">${property.price}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="opacity: 0.9;">District:</span>
                                <span>${property.district}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="opacity: 0.9;">Bedrooms:</span>
                                <span>${property.bedrooms}</span>
                            </div>
                        `;
                        marker.bindTooltip(tooltipContent, { 
                            direction: 'top', 
                            offset: [0, -15],
                            className: 'property-tooltip',
                            permanent: false,
                            sticky: true
                        });
                        marker.on('click', () => this.analyzeProperty(property));
                        this.markerCluster.addLayer(marker);
                    }
                });
                this.updateStats();
            }

            updatePriceRange() {
                const priceRange = document.getElementById('priceRange').value;
                document.getElementById('priceRangeValue').textContent = `Up to ${Math.round(priceRange / 1000000)}M RWF`;
                this.filterProperties();
            }

            updateStats() {
                const status = document.getElementById('propertyStatus').value;
                const type = document.getElementById('propertyType').value;
                const maxPrice = parseInt(document.getElementById('priceRange').value);
                const filteredProperties = this.properties.filter(property => {
                    const priceValue = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('month') ? 1000 : 1000000);
                    return (status === 'all' || property.status === status) &&
                           (type === 'all' || property.type === type) &&
                           priceValue <= maxPrice;
                });
                document.getElementById('propertyCount').textContent = filteredProperties.length;
                document.getElementById('hospitalCount').textContent = this.facilities.length;
                document.getElementById('schoolCount').textContent = this.schools.length;
                const avgPrice = filteredProperties.length
                    ? filteredProperties.reduce((sum, p) => sum + parseInt(p.price.replace(/[^0-9]/g, '')) * (p.price.includes('month') ? 1000 : 1000000), 0) / filteredProperties.length
                    : 0;
                document.getElementById('avgPrice').textContent = Math.round(avgPrice / 1000000) + 'M';
            }

            analyzeProperty(property) {
                this.currentProperty = property;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">
                            Analyzing property at ${property.district}...<br><br>
                            <strong>${property.type.charAt(0).toUpperCase() + property.type.slice(1)} ${property.status === 'sale' ? 'for Sale' : 'for Rent'}</strong><br>
                            Price: ${property.price}<br>
                            District: ${property.district}<br>
                            Bedrooms: ${property.bedrooms}<br>
                            Bathrooms: ${property.bathrooms}<br><br>
                            ${this.analyzeSchoolProximity(property)}<br>
                            ${this.analyzeHospitalProximity(property)}<br>
                            ${this.analyzeFamilySuitability(property)}<br>
                            ${this.analyzeWalkability(property)}<br>
                            ${this.analyzeInvestmentPotential(property)}<br><br>
                            Ask me for more details about this property, schools, or anything else!
                        </div>
                    </div>`;
                this.scrollToBottom();
                if (this.destinationCoords) {
                    this.calculateRoutes(property);
                }
            }

            analyzeSchoolProximity(property) {
                const nearbySchools = this.schools.filter(school => {
                    const distance = this.calculateDistance(property.lat, property.lng, school.lat, school.lng);
                    return distance <= 1.5;
                });
                nearbySchools.forEach(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: `<div style="width: 22px; height: 22px; background: linear-gradient(135deg, #4CAF50, #2E7D32); border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px;">üéì</div>`,
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        })
                    });
                    marker.addTo(this.map);
                    setTimeout(() => {
                        this.map.removeLayer(marker);
                    }, 3000);
                });
                return `<strong>School Proximity:</strong> ${nearbySchools.length} school${nearbySchools.length !== 1 ? 's' : ''} within 1.5km.`;
            }

            analyzeHospitalProximity(property) {
                const nearbyHospitals = this.facilities.filter(facility => {
                    const distance = this.calculateDistance(property.lat, property.lng, facility.lat, facility.long);
                    return distance <= 2;
                });
                nearbyHospitals.forEach(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: `<div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00ff88, #00cc6a); border: 3px solid white; border-radius: 50%;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    marker.addTo(this.map);
                    setTimeout(() => {
                        this.map.removeLayer(marker);
                    }, 3000);
                });
                return `<strong>Healthcare Proximity:</strong> ${nearbyHospitals.length} hospital${nearbyHospitals.length !== 1 ? 's' : ''} within 2km.`;
            }

            analyzeFamilySuitability(property) {
                const schoolScore = this.schools.filter(school => 
                    this.calculateDistance(property.lat, property.lng, school.lat, school.lng) <= 1.5
                ).length * 20;
                const hospitalScore = this.facilities.filter(facility => 
                    this.calculateDistance(property.lat, property.lng, facility.lat, facility.long) <= 2
                ).length * 15;
                const bedroomScore = property.bedrooms * 10;
                const totalScore = Math.min(100, schoolScore + hospitalScore + bedroomScore);
                return `<strong>Family Suitability:</strong> ${totalScore}/100 (based on schools, hospitals, and bedrooms).`;
            }

            analyzeWalkability(property) {
                const nearbyPOIs = this.schools.length + this.facilities.length;
                const walkabilityScore = Math.min(100, nearbyPOIs * 5);
                return `<strong>Walkability:</strong> ${walkabilityScore}/100 (based on nearby amenities).`;
            }

            analyzeInvestmentPotential(property) {
                const districtScores = { Gasabo: 90, Nyarugenge: 85, Kicukiro: 80 };
                const baseScore = districtScores[property.district] || 70;
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('month') ? 1000 : 1000000);
                const priceScore = priceValue < 20000000 ? 20 : priceValue < 40000000 ? 10 : 0;
                const totalScore = Math.min(100, baseScore + priceScore);
                return `<strong>Investment Potential:</strong> ${totalScore}/100 (based on district and price).`;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            debounceSearchLocation() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => this.performLocationSearch(), 500);
            }

            async performLocationSearch() {
                const query = document.getElementById('locationSearch').value.trim();
                if (!query) return;
                try {
                    const response = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${this.orsApiKey}&text=${encodeURIComponent(query)}&boundary.country=RWA`);
                    const data = await response.json();
                    if (data.features && data.features.length > 0) {
                        const { coordinates } = data.features[0].geometry;
                        this.destinationCoords = [coordinates[1], coordinates[0]];
                        this.map.setView(this.destinationCoords, 15);
                        L.marker(this.destinationCoords, {
                            icon: L.divIcon({
                                className: 'destination-marker',
                                html: `<div style="width: 20px; height: 20px; background: #ff5555; border: 3px solid white; border-radius: 50%;"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(this.map);
                        if (this.currentProperty) {
                            this.calculateRoutes(this.currentProperty);
                        }
                    } else {
                        alert('Location not found in Kigali. Try another landmark or address.');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    alert('Failed to search location. Please try again.');
                }
            }

            async calculateRoutes(property) {
                if (!this.destinationCoords) return;
                const coords = [[property.lng, property.lat], [this.destinationCoords[1], this.destinationCoords[0]]];
                const profiles = ['driving-car', 'foot-walking'];
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">
                            Calculating routes from ${property.district} to ${document.getElementById('locationSearch').value}...<br><br>
                        </div>
                    </div>`;
                this.scrollToBottom();

                // Remove existing route layers
                if (this.routeLayers.driving) this.map.removeLayer(this.routeLayers.driving);
                if (this.routeLayers.walking) this.map.removeLayer(this.routeLayers.walking);

                for (const profile of profiles) {
                    try {
                        const response = await fetch('https://api.openrouteservice.org/v2/directions/' + profile + '/geojson', {
                            method: 'POST',
                            headers: {
                                'Authorization': this.orsApiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                coordinates: coords,
                                units: 'km',
                                geometry: true
                            })
                        });
                        const data = await response.json();
                        if (data.features && data.features.length > 0) {
                            const route = data.features[0];
                            const distance = route.properties.summary.distance;
                            const duration = route.properties.summary.duration / 60; // Convert to minutes
                            const polyline = L.geoJSON(route.geometry, {
                                style: {
                                    color: profile === 'driving-car' ? '#667eea' : '#00ff88',
                                    weight: 5,
                                    opacity: 0.7
                                }
                            }).addTo(this.map);
                            this.routeLayers[profile === 'driving-car' ? 'driving' : 'walking'] = polyline;
                            messagesContainer.innerHTML += `
                                <div class="message ai">
                                    <div class="message-content">
                                        <strong>${profile === 'driving-car' ? 'Driving' : 'Walking'} Route:</strong><br>
                                        Distance: ${distance.toFixed(1)} km<br>
                                        Time: ${duration.toFixed(1)} minutes
                                    </div>
                                </div>`;
                            this.scrollToBottom();
                        }
                    } catch (error) {
                        console.error(`Failed to calculate ${profile} route:`, error);
                        messagesContainer.innerHTML += `
                            <div class="message ai">
                                <div class="message-content">
                                    Failed to calculate ${profile === 'driving-car' ? 'driving' : 'walking'} route. Please try again.
                                </div>
                            </div>`;
                        this.scrollToBottom();
                    }
                }
            }

            getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            this.map.setView([latitude, longitude], 15);
                            L.marker([latitude, longitude], {
                                icon: L.divIcon({
                                    className: 'user-location',
                                    html: `<div style="width: 20px; height: 20px; background: #ff5555; border: 3px solid white; border-radius: 50%;"></div>`,
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                })
                            }).addTo(this.map);
                        },
                        error => {
                            console.error('Geolocation error:', error);
                            alert('Unable to retrieve your location.');
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser.');
                }
            }

            toggleFullscreen() {
                this.isMapFullscreen = !this.isMapFullscreen;
                const map = document.getElementById('map');
                const fullscreenIcon = document.getElementById('fullscreenIcon');
                map.classList.toggle('fullscreen', this.isMapFullscreen);
                fullscreenIcon.className = this.isMapFullscreen ? 'fas fa-compress' : 'fas fa-expand';
                this.map.invalidateSize();
            }

            toggleChatPanel() {
                this.isChatCollapsed = !this.isChatCollapsed;
                const chatPanel = document.getElementById('chatPanel');
                const chatToggleIcon = document.getElementById('chatToggleIcon');
                chatPanel.classList.toggle('collapsed', this.isChatCollapsed);
                chatToggleIcon.className = this.isChatCollapsed ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
                this.map.invalidateSize();
            }

            sendMessage() {
                if (this.isSending) return;
                this.isSending = true;
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message) {
                    this.isSending = false;
                    return;
                }
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                chatInput.value = '';
                chatInput.style.height = 'auto';
                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.generateAIResponse(message, this.currentProperty);
                    this.isSending = false;
                }, 1500);
                this.scrollToBottom();
            }

            showTyping() {
                document.getElementById('typingIndicator').style.display = 'block';
                this.scrollToBottom();
            }

            hideTyping() {
                document.getElementById('typingIndicator').style.display = 'none';
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            generateAIResponse(message, property) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                if (!property) {
                    response = 'Please select a property to analyze.';
                } else {
                    const lowerMessage = message.toLowerCase();
                    if (lowerMessage.includes('school')) {
                        response = this.analyzeSchoolProximity(property);
                    } else if (lowerMessage.includes('health') || lowerMessage.includes('hospital')) {
                        response = this.analyzeHospitalProximity(property);
                    } else if (lowerMessage.includes('family')) {
                        response = this.analyzeFamilySuitability(property);
                    } else if (lowerMessage.includes('walk')) {
                        response = this.analyzeWalkability(property);
                    } else if (lowerMessage.includes('investment')) {
                        response = this.analyzeInvestmentPotential(property);
                    } else if (lowerMessage.includes('route') || lowerMessage.includes('driving') || lowerMessage.includes('walking')) {
                        if (this.destinationCoords) {
                            response = `Calculating routes to ${document.getElementById('locationSearch').value}. Please wait...`;
                            this.calculateRoutes(property);
                        } else {
                            response = 'Please search for a destination first to calculate routes.';
                        }
                    } else {
                        response = `
                            I can provide insights on:<br>
                            - Schools nearby<br>
                            - Healthcare proximity<br>
                            - Family suitability<br>
                            - Walkability<br>
                            - Investment potential<br>
                            - Driving or walking routes to a destination<br>
                            Please ask about one of these topics for the selected property in ${property.district}.
                        `;
                    }
                }
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                this.scrollToBottom();
            }

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            setupEventListeners() {
                document.getElementById('chatInput').addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = `${this.scrollHeight}px`;
                });
            }
        }

        const spatialSystem = new SpatialIntelligenceSystem();
        spatialSystem.init();

        function toggleFullscreen() {
            spatialSystem.toggleFullscreen();
        }

        function switchMapStyle() {
            spatialSystem.switchMapStyle();
        }

        function getUserLocation() {
            spatialSystem.getUserLocation();
        }

        function toggleChatPanel() {
            spatialSystem.toggleChatPanel();
        }
    </script>
</body>
</html>
