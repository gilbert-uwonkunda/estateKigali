
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Location Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --education: #8b5cf6;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-light: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        .chat-container {
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-light);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }
        
        .chat-container.collapsed {
            width: 60px;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        .app-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-bottom: 1px solid var(--glass-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .toggle-chat-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-chat-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }
        
        .filter-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-light);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        
        .filter-select option {
            background: var(--dark);
            color: #fff;
        }
        
        .filter-summary {
            margin-top: 8px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(15, 23, 42, 0.4);
            min-height: 150px;
            max-height: calc(100vh - 300px);
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px 16px 16px 4px;
            padding: 16px 18px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px 16px 4px 16px;
            padding: 16px 18px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 85%;
        }
        
        .chat-input-container {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--glass-light);
        }
        
        .chat-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .map-search-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
            min-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .location-btn, .home-btn, .basemap-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .location-btn:hover, .home-btn:hover, .basemap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .data-panels {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .data-panel {
            background: var(--glass);
            border: 1px solid var(--glass-light);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            min-width: 140px;
            max-width: 200px;
        }
        
        .panel-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .panel-subtitle {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .panel-breakdown {
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        .breakdown-sale {
            color: var(--danger);
            font-weight: 600;
        }
        
        .breakdown-rent {
            color: var(--success);
            font-weight: 600;
        }
        
        .breakdown-type {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .properties-panel .panel-title {
            color: var(--primary);
        }
        
        .property-marker {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
            opacity: 0.85;
            width: 60px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        .property-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            opacity: 1;
            z-index: 1000;
        }
        
        .property-marker.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            opacity: 1;
            z-index: 1001;
        }
        
        .property-marker.sale {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .property-marker.sale.selected {
            background: var(--danger);
            color: white;
        }
        
        .property-marker.sale::after {
            content: 'SALE';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.rent {
            border-color: var(--success);
            color: var(--success);
        }
        
        .property-marker.rent.selected {
            background: var(--success);
            color: white;
        }
        
        .property-marker.rent::after {
            content: 'RENT';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--success);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.luxury {
            border-color: var(--warning);
            color: var(--warning);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            background: linear-gradient(135deg, #fff, #fffbeb);
        }
        
        .property-marker.luxury.selected {
            background: var(--warning);
            color: white;
        }
        
        .property-marker.luxury::before {
            content: '‚≠ê';
            position: absolute;
            top: -6px;
            left: -6px;
            background: var(--warning);
            color: white;
            font-size: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .school-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--education);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .school-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        .hospital-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--success);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .hospital-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }
        
        .property-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .proximity-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--success);
        }
        
        .education-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(124, 58, 237, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--education);
        }
        
        .facility-list {
            margin-top: 12px;
        }
        
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .facility-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        .facility-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .facility-distance {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .leaflet-tooltip.compact-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 6px !important;
            color: #ffffff !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            padding: 6px 8px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            max-width: 200px !important;
        }
        
        .leaflet-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-container {
                width: 100%;
                height: 45vh;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--glass-light);
            }
            
            .chat-container.collapsed {
                height: 60px;
            }
            
            .map-container {
                height: 55vh;
                order: 1;
            }
            
            .data-panels {
                flex-direction: column;
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }
            
            .data-panel {
                padding: 10px 12px;
                min-width: 120px;
                max-width: 160px;
            }
            
            .map-search-controls {
                top: 10px;
                right: 10px;
                left: unset;
                flex-direction: column;
                gap: 8px;
            }
            
            .search-box {
                min-width: unset;
            }
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .welcome-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 20px;
            color: var(--primary);
            font-style: italic;
            font-size: 0.85rem;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI analyzing'; }
            40% { content: 'AI analyzing.'; }
            60% { content: 'AI analyzing..'; }
            80%, 100% { content: 'AI analyzing...'; }
        }
        
        .layer-selector {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .basemap-btn {
            background: white;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            padding: 8px 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .basemap-btn:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container" id="chatContainer">
            <div class="app-header">
                <div class="app-title">PropertyIntel Kigali</div>
                <button class="toggle-chat-btn" onclick="toggleChat()" aria-label="Toggle chat">
                    <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </button>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Property Filters
                </div>
                <div class="filter-grid">
                    <select id="statusFilter" class="filter-select" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                    </select>
                    
                    <select id="priceFilter" class="filter-select" aria-label="Filter by price">
                        <option value="">All Prices</option>
                        <option value="0-50">Under 50M RWF</option>
                        <option value="50-100">50M - 100M RWF</option>
                        <option value="100-200">100M - 200M RWF</option>
                        <option value="200+">Above 200M RWF</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-title">Welcome to PropertyIntel!</div>
                        Click on any property marker to see detailed analysis including nearby schools and hospitals.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Select a property to start asking questions..." 
                              rows="1" disabled aria-label="Ask about property"></textarea>
                    <button class="send-btn" id="sendBtn" disabled aria-label="Send message">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div class="map-search-controls">
                <div class="search-box">
                    <input type="text" id="locationSearch" class="search-input" 
                           placeholder="Search location in Kigali..." aria-label="Search location">
                    <button id="searchBtn" class="search-btn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button id="locationBtn" class="location-btn" aria-label="Use current location">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button id="homeBtn" class="home-btn" aria-label="Reset to home view">
                    <i class="fas fa-home"></i>
                </button>
            </div>
            
            <div class="data-panels">
                <div class="data-panel properties-panel">
                    <div class="panel-title">
                        <i class="fas fa-home"></i> Properties
                    </div>
                    <div class="panel-value" id="propertiesCount">0</div>
                    <div class="panel-subtitle">Available listings</div>
                    <div class="panel-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-sale">For Sale:</span>
                            <span id="forSaleCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-rent">For Rent:</span>
                            <span id="forRentCount">0</span>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0; padding-top: 4px;">
                            <div class="breakdown-item">
                                <span class="breakdown-type">Apartments:</span>
                                <span id="apartmentCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Houses:</span>
                                <span id="houseCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Villas:</span>
                                <span id="villaCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Luxury:</span>
                                <span id="luxuryCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="layer-selector">
                <button id="basemapBtn" aria-label="Toggle basemap">Map</button>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class PropertyIntelSystem {
            constructor() {
                this.map = null;
                this.currentProperty = null;
                this.selectedMarker = null;
                this.facilities = [];
                this.schools = [];
                this.propertyMarkers = [];
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.nearbyHospitals = [];
                this.nearbySchools = [];
                this.filteredProperties = [];
                this.isSending = false;
                this.properties = [];
                this.baseLayers = {};
                this.currentBaseLayer = 'street';
                this.bufferCircle = null;
                this.tempLine = null;
                
                this.init();
            }
            
            async init() {
                await this.loadProperties();
                await this.loadFacilities();
                await this.loadSchools();
                this.initializeMap();
                this.setupEventListeners();
                this.updateStats();
                this.updateFilterSummary();
                // Force map refresh after initialization
                setTimeout(() => {
                    if (this.map) {
                        this.map.invalidateSize();
                        this.addProperties();
                    }
                }, 500);
            }
            
            async loadProperties() {
                try {
                    const response = await fetch('http://localhost:3001/api/properties', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    // Transform API data to match frontend format
                    this.properties = data.map(property => {
                        const normalizedType = this.normalizePropertyType(property.type);
                        return {
                            id: property.id || Math.random().toString(36).substr(2, 9),
                            lat: parseFloat(property.latitude) || 0,
                            lng: parseFloat(property.longitude) || 0,
                            name: property.name || 'Unnamed Property',
                            type: normalizedType,
                            price: this.formatPrice(property.price),
                            status: (property.status || 'sale').toLowerCase(),
                            bedrooms: parseInt(property.bedrooms) || 0,
                            bathrooms: parseInt(property.bathrooms) || 0,
                            area: property.area ? `${parseInt(property.area)}m¬≤` : 'N/A',
                            yearBuilt: property.year_built || 'N/A',
                            district: property.district || 'Unknown',
                            amenities: property.amenities ? property.amenities.split(',').map(item => item.trim()) : []
                        };
                    }).filter(prop => {
                        const valid = prop.lat !== 0 && prop.lng !== 0 && !isNaN(prop.lat) && !isNaN(prop.lng);
                        if (!valid) {
                            console.warn(`Invalid coordinates for property ${prop.name}: lat=${prop.lat}, lng=${prop.lng}`);
                        }
                        return valid;
                    });
                    
                    console.log('Processed properties:', this.properties.length, this.properties);
                    
                    // Fallback to provided sample data if no properties are loaded
                    if (this.properties.length === 0) {
                        console.warn('No properties loaded from API, using fallback data');
                        this.properties = [
                            {
                                id: '1',
                                lat: -1.9454393203203149,
                                lng: 30.090843600629185,
                                name: 'Kacyiru Executive Apartments',
                                type: 'Apartment',
                                price: '400K RWF',
                                status: 'sale',
                                bedrooms: 4,
                                bathrooms: 3,
                                area: '200m¬≤',
                                yearBuilt: 2015,
                                district: 'Gasabo',
                                amenities: ['Garden', 'Security']
                            },
                            {
                                id: '2',
                                lat: -1.94278564698374,
                                lng: 30.090095476955412,
                                name: 'Pedro Apartments',
                                type: 'Apartment',
                                price: '350K RWF',
                                status: 'rent',
                                bedrooms: 2,
                                bathrooms: 1,
                                area: '100m¬≤',
                                yearBuilt: 2018,
                                district: 'Gasabo',
                                amenities: ['Parking']
                            },
                            {
                                id: '3',
                                lat: -1.9515638960060595,
                                lng: 30.059049686506583,
                                name: 'Altis Apartments',
                                type: 'Apartment',
                                price: '500K RWF',
                                status: 'rent',
                                bedrooms: 2,
                                bathrooms: 1,
                                area: '100m¬≤',
                                yearBuilt: 2018,
                                district: 'Nyarugenge',
                                amenities: ['Parking']
                            },
                            {
                                id: '4',
                                lat: -1.9495749673401483,
                                lng: 30.078914337931103,
                                name: 'Rubangura Luxury Apartments',
                                type: 'Luxury Apartment',
                                price: '500K RWF',
                                status: 'rent',
                                bedrooms: 2,
                                bathrooms: 1,
                                area: '100m¬≤',
                                yearBuilt: 2018,
                                district: 'Gasabo',
                                amenities: ['Parking']
                            },
                            {
                                id: '5',
                                lat: -1.9582643574784928,
                                lng: 30.095969639942403,
                                name: 'Palm Apartments',
                                type: 'Apartment',
                                price: '500K RWF',
                                status: 'rent',
                                bedrooms: 2,
                                bathrooms: 1,
                                area: '100m¬≤',
                                yearBuilt: 2018,
                                district: 'Gasabo',
                                amenities: ['Parking']
                            }
                        ];
                    }
                    
                    this.filteredProperties = [...this.properties];
                    
                } catch (error) {
                    console.error('Failed to load properties:', error);
                    // Fallback to provided sample data
                    this.properties = [
                        {
                            id: '1',
                            lat: -1.9454393203203149,
                            lng: 30.090843600629185,
                            name: 'Kacyiru Executive Apartments',
                            type: 'Apartment',
                            price: '400K RWF',
                            status: 'sale',
                            bedrooms: 4,
                            bathrooms: 3,
                            area: '200m¬≤',
                            yearBuilt: 2015,
                            district: 'Gasabo',
                            amenities: ['Garden', 'Security']
                        },
                        {
                            id: '2',
                            lat: -1.94278564698374,
                            lng: 30.090095476955412,
                            name: 'Pedro Apartments',
                            type: 'Apartment',
                            price: '350K RWF',
                            status: 'rent',
                            bedrooms: 2,
                            bathrooms: 1,
                            area: '100m¬≤',
                            yearBuilt: 2018,
                            district: 'Gasabo',
                            amenities: ['Parking']
                        },
                        {
                            id: '3',
                            lat: -1.9515638960060595,
                            lng: 30.059049686506583,
                            name: 'Altis Apartments',
                            type: 'Apartment',
                            price: '500K RWF',
                            status: 'rent',
                            bedrooms: 2,
                            bathrooms: 1,
                            area: '100m¬≤',
                            yearBuilt: 2018,
                            district: 'Nyarugenge',
                            amenities: ['Parking']
                        },
                        {
                            id: '4',
                            lat: -1.9495749673401483,
                            lng: 30.078914337931103,
                            name: 'Rubangura Luxury Apartments',
                            type: 'Luxury Apartment',
                            price: '500K RWF',
                            status: 'rent',
                            bedrooms: 2,
                            bathrooms: 1,
                            area: '100m¬≤',
                            yearBuilt: 2018,
                            district: 'Gasabo',
                            amenities: ['Parking']
                        },
                        {
                            id: '5',
                            lat: -1.9582643574784928,
                            lng: 30.095969639942403,
                            name: 'Palm Apartments',
                            type: 'Apartment',
                            price: '500K RWF',
                            status: 'rent',
                            bedrooms: 2,
                            bathrooms: 1,
                            area: '100m¬≤',
                            yearBuilt: 2018,
                            district: 'Gasabo',
                            amenities: ['Parking']
                        }
                    ];
                    this.filteredProperties = [...this.properties];
                    console.log('Using fallback properties:', this.properties);
                }
            }
            
            normalizePropertyType(type) {
                if (!type) return 'House';
                const lowerType = type.toLowerCase();
                if (lowerType.includes('luxury')) return 'Luxury ' + (lowerType.includes('villa') ? 'Villa' : lowerType.includes('apartment') ? 'Apartment' : 'House');
                if (lowerType.includes('villa')) return 'Villa';
                if (lowerType.includes('apartment')) return 'Apartment';
                return 'House';
            }
            
            formatPrice(price) {
                if (!price || isNaN(parseFloat(price))) return 'N/A';
                const priceValue = parseFloat(price);
                if (priceValue >= 1000000) {
                    return `${Math.round(priceValue / 1000000)}M RWF`;
                }
                return `${Math.round(priceValue / 1000)}K RWF`;
            }
            
            async loadFacilities() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.facilities = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.lat && 
                            feature.attributes.long
                        ).map(feature => ({
                            facility_name: feature.attributes.facility_name || 'Unknown',
                            facility_type: feature.attributes.facility_type || 'Unknown',
                            lat: feature.attributes.lat,
                            lng: feature.attributes.long,
                            district: feature.attributes.district || 'N/A',
                            sector: feature.attributes.sector || 'N/A',
                            ownership: feature.attributes.ownership || 'N/A'
                        }));
                        console.log('Loaded health facilities:', this.facilities.length);
                    }
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                    this.facilities = [
                        { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, lng: 30.0951, district: "Gasabo" },
                        { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, lng: 30.0604, district: "Nyarugenge" },
                        { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, lng: 30.1678, district: "Kicukiro" }
                    ];
                    console.log('Using fallback facilities:', this.facilities);
                }
            }
            
            async loadSchools() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.schools = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.latitude && 
                            feature.attributes.longitude
                        ).map(feature => ({
                            school_name: feature.attributes.school_nam || 'Unknown School',
                            school_type: feature.attributes.school_typ || 'Unknown',
                            school_category: feature.attributes.school_cat || 'PRE_PRIMARY',
                            school_status: feature.attributes.school_sta || 'Unknown',
                            curriculum: feature.attributes.curriculum || 'National',
                            lat: feature.attributes.latitude,
                            lng: feature.attributes.longitude,
                            established: feature.attributes.establishm || 'N/A'
                        }));
                        console.log('Loaded schools:', this.schools.length);
                    }
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    this.schools = [
                        { school_name: "ITETERO NURSERY SCHOOL", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9489, lng: 30.0000, established: 2009 },
                        { school_name: "Green Hills Academy", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "INTERNATIONAL", lat: -1.9556, lng: 30.1044, established: 2006 },
                        { school_name: "Kigali Parents School", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9386, lng: 30.0619, established: 2010 }
                    ];
                    console.log('Using fallback schools:', this.schools);
                }
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 11);
                
                // Define basemaps
                this.baseLayers = {
                    street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }),
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                        maxZoom: 19
                    })
                };
                
                // Add default street layer
                this.baseLayers.street.addTo(this.map);
                
                setTimeout(() => {
                    this.map.invalidateSize();
                    console.log('Map initialized and refreshed');
                }, 100);
                
                this.addProperties();
                this.prepareHospitals();
                this.prepareSchools();
                
                this.map.on('click', this.handleMapClick.bind(this));
                
                new ResizeObserver(() => {
                    this.map.invalidateSize();
                    console.log('Map resized');
                }).observe(document.getElementById('map'));
            }
            
            toggleBasemap() {
                const basemapBtn = document.getElementById('basemapBtn');
                if (this.currentBaseLayer === 'street') {
                    this.map.removeLayer(this.baseLayers.street);
                    this.baseLayers.satellite.addTo(this.map);
                    this.currentBaseLayer = 'satellite';
                    basemapBtn.textContent = 'Satellite';
                } else {
                    this.map.removeLayer(this.baseLayers.satellite);
                    this.baseLayers.street.addTo(this.map);
                    this.currentBaseLayer = 'street';
                    basemapBtn.textContent = 'Map';
                }
                this.map.invalidateSize();
            }
            
            addProperties() {
                console.log('Adding properties to map:', this.filteredProperties.length);
                
                // Clear existing markers
                this.propertyMarkers.forEach(item => {
                    if (this.map.hasLayer(item.marker)) {
                        this.map.removeLayer(item.marker);
                    }
                });
                this.propertyMarkers = [];
                
                // Add new markers
                this.filteredProperties.forEach((prop) => {
                    if (!prop.lat || !prop.lng || isNaN(prop.lat) || isNaN(prop.lng)) {
                        console.warn(`Skipping property ${prop.name} due to invalid coordinates: lat=${prop.lat}, lng=${prop.lng}`);
                        return;
                    }
                    
                    const isLuxury = prop.type.toLowerCase().includes('luxury');
                    const markerClass = `property-marker ${prop.status} ${isLuxury ? 'luxury' : ''}`;
                    const markerIcon = prop.type.toLowerCase().includes('apartment') ? 'üè¢' : 'üè†';
                    
                    const priceLabel = prop.price.replace(' RWF', '').replace('M', '');
                    
                    const marker = L.marker([prop.lat, prop.lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: `${markerIcon} ${priceLabel}`,
                            iconSize: [60, 24],
                            iconAnchor: [30, 24],
                            popupAnchor: [0, -24]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">${prop.name}</div>
                        <div style="margin-bottom: 2px; font-size: 12px;">üìç ${prop.district} ‚Ä¢ ${prop.bedrooms}BR</div>
                        <div style="font-weight: 600; color: #6366f1; font-size: 13px;">üí∞ ${prop.price}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -24],
                        permanent: false,
                        sticky: false,
                        className: 'compact-tooltip'
                    });
                    
                    marker.on('click', () => this.selectProperty(prop, marker));
                    marker.addTo(this.map);
                    
                    this.propertyMarkers.push({
                        marker: marker,
                        property: prop,
                        visible: true
                    });
                    
                    console.log(`Added marker for ${prop.name} at [${prop.lat}, ${prop.lng}]`);
                });
                
                console.log('Total markers added:', this.propertyMarkers.length);
                this.updateStats();
                this.updateFilterSummary();
                this.map.invalidateSize();
            }
            
            prepareHospitals() {
                this.hospitalMarkers = [];
                this.facilities.forEach(facility => {
                    if (!facility.lat || !facility.lng || isNaN(facility.lat) || isNaN(facility.lng)) {
                        console.warn(`Skipping hospital ${facility.facility_name} due to invalid coordinates`);
                        return;
                    }
                    
                    const marker = L.marker([facility.lat, facility.lng], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: 'üè•',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üè• ${facility.facility_name}</div>
                        <div style="margin-bottom: 2px;">üìã ${facility.facility_type}</div>
                        <div>üìç ${facility.district}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.hospitalMarkers.push(marker);
                });
                console.log('Prepared hospital markers:', this.hospitalMarkers.length);
            }
            
            prepareSchools() {
                this.schoolMarkers = [];
                this.schools.forEach(school => {
                    if (!school.lat || !school.lng || isNaN(school.lat) || isNaN(school.lng)) {
                        console.warn(`Skipping school ${school.school_name} due to invalid coordinates`);
                        return;
                    }
                    
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: 'üéì',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üéì ${school.school_name}</div>
                        <div style="margin-bottom: 2px;">üìö ${school.school_status} School</div>
                        <div style="margin-bottom: 2px;">üìñ ${school.curriculum} Curriculum</div>
                        <div>üìÖ Est. ${school.established}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.schoolMarkers.push(marker);
                });
                console.log('Prepared school markers:', this.schoolMarkers.length);
            }
            
            selectProperty(property, marker) {
                if (this.selectedMarker) {
                    const prevElement = this.selectedMarker.getElement();
                    if (prevElement) {
                        prevElement.classList.remove('selected');
                    }
                }
                
                this.currentProperty = property;
                this.selectedMarker = marker;
                
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
                
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('chatInput').placeholder = `Ask about ${property.name}...`;
                
                this.analyzeProperty(property);
                this.map.setView([property.lat, property.lng], 15);
            }
            
            analyzeProperty(property) {
                this.clearNearbyMarkers();
                this.removeBuffer();
                this.removeTempLine();
                this.analyzeProximity(property);
                this.displayPropertyAnalysis(property);
                this.addBuffer(property);
                this.showNearbyFacilities(property);
            }
            
            addBuffer(property) {
                this.bufferCircle = L.circle([property.lat, property.lng], {
                    color: '#6366f1',
                    fillColor: '#6366f1',
                    fillOpacity: 0.1,
                    radius: 3000
                }).addTo(this.map);
            }
            
            removeBuffer() {
                if (this.bufferCircle) {
                    this.map.removeLayer(this.bufferCircle);
                    this.bufferCircle = null;
                }
            }
            
            showConnectionLine(origin, dest, distance, name) {
                this.removeTempLine();
                
                this.tempLine = L.polyline([[origin.lat, origin.lng], [dest.lat, dest.lng]], {
                    color: '#6366f1',
                    weight: 3,
                    dashArray: '5, 5'
                }).addTo(this.map);
                
                const walkingSpeed = 5; // km/h
                const drivingSpeed = 30; // km/h
                const timeWalk = Math.round((distance / walkingSpeed) * 60);
                const timeDrive = Math.round((distance / drivingSpeed) * 60);
                
                const tooltipContent = `
                    ${name}<br>
                    Distance: ${distance.toFixed(1)} km<br>
                    Walking: ~${timeWalk} min<br>
                    Driving: ~${timeDrive} min
                `;
                
                this.tempLine.bindTooltip(tooltipContent, {
                    direction: 'right',
                    sticky: true,
                    permanent: false
                }).openTooltip();
            }
            
            removeTempLine() {
                if (this.tempLine) {
                    this.map.removeLayer(this.tempLine);
                    this.tempLine = null;
                }
            }
            
            clearNearbyMarkers() {
                this.hospitalMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                
                this.schoolMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
            }
            
            showNearbyFacilities(property) {
                this.nearbyHospitals.forEach(hospital => {
                    const marker = this.hospitalMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - hospital.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - hospital.lng) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                        marker.on('mouseover', () => {
                            this.showConnectionLine(property, hospital, hospital.distance, `üè• ${hospital.facility_name}`);
                        });
                        marker.on('mouseout', () => {
                            this.removeTempLine();
                        });
                    }
                });
                
                this.nearbySchools.forEach(school => {
                    const marker = this.schoolMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - school.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - school.lng) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                        marker.on('mouseover', () => {
                            this.showConnectionLine(property, school, school.distance, `üéì ${school.school_name}`);
                        });
                        marker.on('mouseout', () => {
                            this.removeTempLine();
                        });
                    }
                });
            }
            
            analyzeProximity(property) {
                this.nearbyHospitals = [];
                this.facilities.forEach(facility => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.lng]) / 1000;
                    
                    if (distance <= 3) {
                        this.nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                    }
                });
                this.nearbyHospitals.sort((a, b) => a.distance - b.distance);
                
                this.nearbySchools = [];
                this.schools.forEach(school => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([school.lat, school.lng]) / 1000;
                    
                    if (distance <= 3) {
                        this.nearbySchools.push({
                            ...school,
                            distance: distance
                        });
                    }
                });
                this.nearbySchools.sort((a, b) => a.distance - b.distance);
            }
            
            displayPropertyAnalysis(property) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                let propertyHtml = `
                    <div class="property-info">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">${property.name}</h3>
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> ${property.type}</div>
                        <div style="margin-bottom: 6px;"><strong>Price:</strong> ${property.price}</div>
                        <div style="margin-bottom: 6px;"><strong>Size:</strong> ${property.bedrooms}BR ‚Ä¢ ${property.bathrooms}BA ‚Ä¢ ${property.area}</div>
                        <div style="margin-bottom: 6px;"><strong>Built:</strong> ${property.yearBuilt}</div>
                        <div style="margin-bottom: 6px;"><strong>District:</strong> ${property.district}</div>
                        <div><strong>Amenities:</strong> ${property.amenities ? property.amenities.join(', ') : 'Standard'}</div>
                    </div>`;
                
                messagesContainer.innerHTML += propertyHtml;
                
                if (this.nearbySchools.length > 0) {
                    let schoolHtml = `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">üéì Education Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbySchools.length} schools within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbySchools.slice(0, 5).forEach(school => {
                        schoolHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${school.lat}, ${school.lng})">
                                <div class="facility-name">${school.school_name}</div>
                                <div class="facility-distance">${(school.distance * 1000).toFixed(0)}m</div>
                            </div>`;
                    });
                    
                    schoolHtml += `</div></div>`;
                    messagesContainer.innerHTML += schoolHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Education Access</h4>
                            <p>No schools within 3km walking distance. Consider transportation needs for school-age children.</p>
                        </div>`;
                }
                
                if (this.nearbyHospitals.length > 0) {
                    let hospitalHtml = `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">üè• Healthcare Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbyHospitals.length} health facilities within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbyHospitals.slice(0, 5).forEach(hospital => {
                        hospitalHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${hospital.lat}, ${hospital.lng})">
                                <div class="facility-name">${hospital.facility_name}</div>
                                <div class="facility-distance">${hospital.distance.toFixed(1)}km</div>
                            </div>`;
                    });
                    
                    hospitalHtml += `</div></div>`;
                    messagesContainer.innerHTML += hospitalHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Healthcare Access</h4>
                            <p>No hospitals within 3km radius. Emergency services may take longer to reach this location.</p>
                        </div>`;
                }
                
                this.scrollToBottom();
            }
            
            focusLocation(lat, lng) {
                this.map.setView([lat, lng], 16);
            }
            
            resetToHomeView() {
                this.map.setView([-1.9441, 30.0619], 11);
            }
            
            handleMapClick(e) {
                this.clearNearbyMarkers();
                this.removeBuffer();
                this.removeTempLine();
                
                if (this.selectedMarker) {
                    const prevElement = this.selectedMarker.getElement();
                    if (prevElement) {
                        prevElement.classList.remove('selected');
                    }
                    this.selectedMarker = null;
                }
                
                this.currentProperty = null;
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('chatInput').placeholder = "Select a property to start asking questions...";
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-title">Welcome to PropertyIntel!</div>
                        Click on any property marker to see detailed analysis including nearby schools and hospitals.
                    </div>`;
            }
            
            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const locationSearch = document.getElementById('locationSearch');
                const searchBtn = document.getElementById('searchBtn');
                const locationBtn = document.getElementById('locationBtn');
                const homeBtn = document.getElementById('homeBtn');
                const basemapBtn = document.getElementById('basemapBtn');
                const statusFilter = document.getElementById('statusFilter');
                const typeFilter = document.getElementById('typeFilter');
                const priceFilter = document.getElementById('priceFilter');
                
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                
                locationSearch.addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.performLocationSearch();
                });
                
                searchBtn.addEventListener('click', () => this.performLocationSearch());
                locationBtn.addEventListener('click', () => this.useCurrentLocation());
                homeBtn.addEventListener('click', () => this.resetToHomeView());
                basemapBtn.addEventListener('click', () => this.toggleBasemap());
                
                statusFilter.addEventListener('change', () => this.applyFilters());
                typeFilter.addEventListener('change', () => this.applyFilters());
                priceFilter.addEventListener('change', () => this.applyFilters());
            }
            
            async performLocationSearch() {
                const locationSearch = document.getElementById('locationSearch');
                const location = locationSearch.value.trim();
                if (!location) return;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const { lat, lon } = results[0];
                        this.map.setView([lat, lon], 16);
                    } else {
                        alert('Location not found in Kigali');
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    alert('Search failed. Please try again.');
                }
            }
            
            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported by this browser');
                    return;
                }
                
                navigator.geolocation.getCurrentLocation(
                    position => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        this.map.setView([lat, lng], 15);
                    },
                    error => {
                        alert('Unable to get your location');
                    }
                );
            }
            
            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priceFilter = document.getElementById('priceFilter').value;
                
                this.filteredProperties = this.properties.filter(property => {
                    if (statusFilter && property.status !== statusFilter) return false;
                    
                    if (typeFilter) {
                        const propType = property.type.toLowerCase();
                        if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                        if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                        if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                        if (typeFilter === 'house' && !propType.includes('house')) return false;
                    }
                    
                    if (priceFilter) {
                        const price = parseInt(property.price.replace(/[^0-9]/g, ''));
                        if (priceFilter === '0-50' && price >= 50) return false;
                        if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                        if (priceFilter === '100-200' && (price < 100 || price >= 200)) return false;
                        if (priceFilter === '200+' && price < 200) return false;
                    }
                    
                    return true;
                });
                
                console.log('Filtered properties:', this.filteredProperties.length);
                this.updatePropertyVisibility();
                this.updateFilterSummary();
                this.updateStats();
            }
            
            updatePropertyVisibility() {
                this.propertyMarkers.forEach(item => {
                    const isVisible = this.filteredProperties.includes(item.property);
                    if (isVisible && !item.visible) {
                        item.marker.addTo(this.map);
                        item.visible = true;
                        console.log(`Showing marker for ${item.property.name}`);
                    } else if (!isVisible && item.visible) {
                        this.map.removeLayer(item.marker);
                        item.visible = false;
                        console.log(`Hiding marker for ${item.property.name}`);
                    }
                });
            }
            
            updateFilterSummary() {
                const filterSummary = document.getElementById('filterSummary');
                const total = this.properties.length;
                const shown = this.filteredProperties.length;
                
                filterSummary.textContent = shown === total ? 
                    `Showing all ${total} properties` : 
                    `Showing ${shown} of ${total} properties`;
            }
            
            updateStats() {
                const forSale = this.filteredProperties.filter(p => p.status === 'sale').length;
                const forRent = this.filteredProperties.filter(p => p.status === 'rent').length;
                
                const apartments = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('apartment')).length;
                const houses = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('house')).length;
                const villas = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('villa') && !p.type.toLowerCase().includes('luxury')).length;
                const luxury = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('luxury')).length;
                
                document.getElementById('propertiesCount').textContent = this.filteredProperties.length;
                document.getElementById('forSaleCount').textContent = forSale;
                document.getElementById('forRentCount').textContent = forRent;
                document.getElementById('apartmentCount').textContent = apartments;
                document.getElementById('houseCount').textContent = houses;
                document.getElementById('villaCount').textContent = villas;
                document.getElementById('luxuryCount').textContent = luxury;
            }
            
            sendMessage() {
                if (this.isSending) return;
                this.isSending = true;
                
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message || !this.currentProperty) {
                    this.isSending = false;
                    return;
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.generateAIResponse(message, this.currentProperty);
                    this.isSending = false;
                }, 1500);
                
                this.scrollToBottom();
            }
            
            generateAIResponse(question, property) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('school') || lowerQuestion.includes('education')) {
                    response = this.generateSchoolResponse(property);
                } else if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                    response = this.generateHealthResponse(property);
                } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('investment')) {
                    response = this.generatePriceResponse(property);
                } else if (lowerQuestion.includes('family') || lowerQuestion.includes('children')) {
                    response = this.generateFamilyResponse(property);
                } else {
                    response = this.generateGeneralResponse(property);
                }
                
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                
                this.scrollToBottom();
            }
            
            generateSchoolResponse(property) {
                let response = `<h4>üéì Education Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbySchools.length > 0) {
                    response += `Great news for families! Found <strong>${this.nearbySchools.length} schools</strong> within 3km:<br><br>`;
                    
                    this.nearbySchools.slice(0, 3).forEach(school => {
                        const walkTime = Math.round(school.distance * 12);
                        response += `üìö <strong>${school.school_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${school.school_status} (${school.curriculum})<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${(school.distance * 1000).toFixed(0)}m (~${walkTime} min walk)<br><br>`;
                    });
                    
                    response += `This property offers excellent educational access for families with children!<br><br>Hover over school markers on the map to see connection lines and estimated travel times.`;
                } else {
                    response += `No schools found within 3km of this property.<br><br>`;
                    response += `<strong>Recommendations:</strong><br>`;
                    response += `‚Ä¢ Consider school transport services<br>`;
                    response += `‚Ä¢ Look into private school bus routes<br>`;
                    response += `‚Ä¢ Factor in daily commute time for school runs`;
                }
                
                return response;
            }
            
            generateHealthResponse(property) {
                let response = `<h4>üè• Healthcare Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbyHospitals.length > 0) {
                    response += `Excellent healthcare coverage! <strong>${this.nearbyHospitals.length} health facilities</strong> within 3km:<br><br>`;
                    
                    this.nearbyHospitals.slice(0, 3).forEach(hospital => {
                        response += `üè• <strong>${hospital.facility_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${hospital.facility_type}<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${hospital.distance.toFixed(1)}km<br><br>`;
                    });
                    
                    response += `Emergency response time: approximately 5-15 minutes depending on traffic.<br><br>Hover over hospital markers on the map to see connection lines and estimated travel times.`;
                } else {
                    response += `Limited healthcare access - no major facilities within 3km.<br><br>`;
                    response += `<strong>Important considerations:</strong><br>`;
                    response += `‚Ä¢ Emergency response may take 20+ minutes<br>`;
                    response += `‚Ä¢ Consider proximity to main roads for ambulance access<br>`;
                    response += `‚Ä¢ Keep emergency contact numbers and first aid supplies ready`;
                }
                
                return response;
            }
            
            generatePriceResponse(property) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                let response = `<h4>üí∞ Investment Analysis for ${property.name}</h4><br>`;
                
                response += `<strong>Current Price:</strong> ${property.price}<br>`;
                const areaNum = parseInt(property.area);
                response += `<strong>Price per m¬≤:</strong> ${areaNum ? Math.round(priceValue * 1000 / areaNum) + ' RWF/m¬≤' : 'N/A'}<br><br>`;
                
                let investmentScore = 60;
                if (property.district === 'Gasabo') investmentScore += 15;
                else if (property.district === 'Nyarugenge') investmentScore += 10;
                else investmentScore += 5;
                
                investmentScore += Math.min(this.nearbySchools.length * 5, 15);
                investmentScore += Math.min(this.nearbyHospitals.length * 3, 10);
                
                response += `<strong>Investment Score: ${Math.min(investmentScore, 100)}/100</strong><br><br>`;
                
                if (property.status === 'sale') {
                    const estimatedRent = Math.round(priceValue * 0.5);
                    response += `<strong>Rental Potential:</strong><br>`;
                    response += `‚Ä¢ Estimated monthly rent: ${estimatedRent}K RWF<br>`;
                    response += `‚Ä¢ Annual yield: ~6%<br><br>`;
                }
                
                response += `<strong>Value Drivers:</strong><br>`;
                response += `‚Ä¢ ${this.nearbySchools.length} schools nearby<br>`;
                response += `‚Ä¢ ${this.nearbyHospitals.length} health facilities<br>`;
                response += `‚Ä¢ ${property.district} district location<br>`;
                response += `‚Ä¢ Built in ${property.yearBuilt} (${new Date().getFullYear() - parseInt(property.yearBuilt)} years old)`;
                
                return response;
            }
            
            generateFamilyResponse(property) {
                let response = `<h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Suitability Analysis</h4><br>`;
                
                let familyScore = 50;
                
                if (property.bedrooms >= 4) familyScore += 20;
                else if (property.bedrooms >= 3) familyScore += 15;
                else if (property.bedrooms >= 2) familyScore += 10;
                
                if (this.nearbySchools.length >= 3) familyScore += 20;
                else if (this.nearbySchools.length >= 1) familyScore += 10;
                
                if (this.nearbyHospitals.length >= 2) familyScore += 10;
                else if (this.nearbyHospitals.length >= 1) familyScore += 5;
                
                response += `<strong>Family Score: ${Math.min(familyScore, 100)}/100</strong><br><br>`;
                
                response += `<strong>Space Assessment:</strong><br>`;
                response += `‚Ä¢ ${property.bedrooms} bedrooms, ${property.bathrooms} bathrooms<br>`;
                response += `‚Ä¢ Total area: ${property.area}<br>`;
                response
            }
            
            generateGeneralResponse(property) {
                let response = `<h4>üè† Complete Property Overview</h4><br>`;
                
                response += `I can provide detailed insights about <strong>${property.name}</strong>:<br><br>`;
                
                response += `<strong>Available Analysis:</strong><br>`;
                response += `‚Ä¢ üéì <strong>Education:</strong> ${this.nearbySchools.length} schools within 2km<br>`;
                response += `‚Ä¢ üè• <strong>Healthcare:</strong> ${this.nearbyHospitals.length} health facilities within 3km<br>`;
                response += `‚Ä¢ üí∞ <strong>Investment potential</strong> and pricing analysis<br>`;
                response += `‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <strong>Family suitability</strong> assessment<br>`;
                response += `‚Ä¢ üöó <strong>Transportation</strong> and accessibility<br><br>`;
                
                response += `<strong>Quick Facts:</strong><br>`;
                response += `‚Ä¢ Location: ${property.district} District<br>`;
                response += `‚Ä¢ Size: ${property.bedrooms}BR, ${property.bathrooms}BA, ${property.area}<br>`;
                response += `‚Ä¢ Year Built: ${property.yearBuilt}<br>`;
                response += `‚Ä¢ Status: ${property.status === 'sale' ? 'For Sale' : 'For Rent'}<br><br>`;
                
                response += `What specific aspect would you like me to analyze in detail?`;
                
                return response;
            }
            
            showTyping() {
                document.getElementById('typingIndicator').classList.add('show');
            }
            
            hideTyping() {
                document.getElementById('typingIndicator').classList.remove('show');
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        }
        
        let propertyIntel = null;
        
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            chatContainer.classList.toggle('collapsed');
            
            if (chatContainer.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
            }
            
            if (propertyIntel) propertyIntel.map.invalidateSize();
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            propertyIntel = new PropertyIntelSystem();
        });
    </script>
</body>
</html>
