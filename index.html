
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Location Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --education: #8b5cf6;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-light: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Chat Container - Simplified */
        .chat-container {
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-light);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }
        
        .chat-container.collapsed {
            width: 60px;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        /* App Header */
        .app-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-bottom: 1px solid var(--glass-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .toggle-chat-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-chat-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }
        
        /* Filter Section */
        .filter-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-light);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        
        .filter-select option {
            background: var(--dark);
            color: #fff;
        }
        
        .filter-summary {
            margin-top: 8px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        
        /* Chat Messages Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(15, 23, 42, 0.4);
            min-height: 150px;
            max-height: calc(100vh - 300px);
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px 16px 16px 4px;
            padding: 16px 18px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px 16px 4px 16px;
            padding: 16px 18px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 85%;
        }
        
        /* Chat Input */
        .chat-input-container {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--glass-light);
        }
        
        .chat-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Map Controls */
        .map-search-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
            min-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .location-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        /* Map Data Panels */
        .data-panels {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .facilities-panels {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .data-panel {
            background: var(--glass);
            border: 1px solid var(--glass-light);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            min-width: 140px;
            max-width: 200px;
        }
        
        .panel-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .panel-subtitle {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .panel-breakdown {
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        .breakdown-sale {
            color: var(--danger);
            font-weight: 600;
        }
        
        .breakdown-rent {
            color: var(--success);
            font-weight: 600;
        }
        
        .breakdown-type {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .properties-panel .panel-title {
            color: var(--primary);
        }
        
        .schools-panel .panel-title {
            color: var(--education);
        }
        
        .hospitals-panel .panel-title {
            color: var(--success);
        }
        
        /* Property Markers */
        .property-marker {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
            opacity: 0.85;
            width: 60px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        .property-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            opacity: 1;
            z-index: 1000;
        }
        
        .property-marker.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            opacity: 1;
            z-index: 1001;
        }
        
        /* Status Indicators */
        .property-marker.sale {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .property-marker.sale.selected {
            background: var(--danger);
            color: white;
        }
        
        .property-marker.sale::after {
            content: 'SALE';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.rent {
            border-color: var(--success);
            color: var(--success);
        }
        
        .property-marker.rent.selected {
            background: var(--success);
            color: white;
        }
        
        .property-marker.rent::after {
            content: 'RENT';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--success);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.luxury {
            border-color: var(--warning);
            color: var(--warning);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            background: linear-gradient(135deg, #fff, #fffbeb);
        }
        
        .property-marker.luxury.selected {
            background: var(--warning);
            color: white;
        }
        
        .property-marker.luxury::before {
            content: '⭐';
            position: absolute;
            top: -6px;
            left: -6px;
            background: var(--warning);
            color: white;
            font-size: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* Reduce visual noise when zoomed out */
        .property-marker.distant {
            opacity: 0.6;
            font-size: 10px;
            padding: 3px 6px;
        }
        
        .property-marker.distant:hover {
            opacity: 1;
        }
        
        /* School Markers */
        .school-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--education);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .school-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        /* Hospital Markers */
        .hospital-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--success);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .hospital-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }
        
        /* Info Panels in Chat */
        .property-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .proximity-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--success);
        }
        
        .education-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(124, 58, 237, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--education);
        }
        
        .facility-list {
            margin-top: 12px;
        }
        
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .facility-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        .facility-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .facility-distance {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Tooltips */
        .leaflet-tooltip.compact-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 6px !important;
            color: #ffffff !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            padding: 6px 8px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            max-width: 200px !important;
        }
        
        .leaflet-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-container {
                width: 100%;
                height: 45vh;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--glass-light);
            }
            
            .chat-container.collapsed {
                height: 60px;
            }
            
            .map-container {
                height: 55vh;
                order: 1;
            }
            
            .data-panels {
                flex-direction: column;
                bottom: 10px;
                left: 10px;
                gap: 6px;
            }
            
            .facilities-panels {
                flex-direction: column;
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }
            
            .data-panel {
                padding: 10px 12px;
                min-width: 120px;
                max-width: 160px;
            }
            
            .map-search-controls {
                top: 10px;
                right: 10px;
                left: unset;
                flex-direction: column;
                gap: 8px;
            }
            
            .search-box {
                min-width: unset;
            }
        }
        
        /* Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .welcome-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 10px 20px;
            color: var(--primary);
            font-style: italic;
            font-size: 0.85rem;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI analyzing'; }
            40% { content: 'AI analyzing.'; }
            60% { content: 'AI analyzing..'; }
            80%, 100% { content: 'AI analyzing...'; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Clean Chat Container -->
        <div class="chat-container" id="chatContainer">
            <!-- App Header -->
            <div class="app-header">
                <div class="app-title">PropertyIntel Kigali</div>
                <button class="toggle-chat-btn" onclick="toggleChat()" aria-label="Toggle chat">
                    <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </button>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Property Filters
                </div>
                <div class="filter-grid">
                    <select id="statusFilter" class="filter-select" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                    </select>
                    
                    <select id="priceFilter" class="filter-select" aria-label="Filter by price">
                        <option value="">All Prices</option>
                        <option value="0-50">Under 50M RWF</option>
                        <option value="50-100">50M - 100M RWF</option>
                        <option value="100-200">100M - 200M RWF</option>
                        <option value="200+">Above 200M RWF</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-title">Welcome to PropertyIntel!</div>
                        Click on any property marker to see detailed analysis including nearby schools and hospitals.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <!-- Chat Input -->
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Select a property to start asking questions..." 
                              rows="1" disabled aria-label="Ask about property"></textarea>
                    <button class="send-btn" id="sendBtn" disabled aria-label="Send message">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <!-- Map Search Controls -->
            <div class="map-search-controls">
                <div class="search-box">
                    <input type="text" id="locationSearch" class="search-input" 
                           placeholder="Search location in Kigali..." aria-label="Search location">
                    <button id="searchBtn" class="search-btn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button id="locationBtn" class="location-btn" aria-label="Use current location">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
            
            <!-- Data Panels -->
            <div class="data-panels">
                <div class="data-panel properties-panel">
                    <div class="panel-title">
                        <i class="fas fa-home"></i> Properties
                    </div>
                    <div class="panel-value" id="propertiesCount">20</div>
                    <div class="panel-subtitle">Available listings</div>
                    <div class="panel-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-sale">For Sale:</span>
                            <span id="forSaleCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-rent">For Rent:</span>
                            <span id="forRentCount">0</span>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0; padding-top: 4px;">
                            <div class="breakdown-item">
                                <span class="breakdown-type">Apartments:</span>
                                <span id="apartmentCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Houses:</span>
                                <span id="houseCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Villas:</span>
                                <span id="villaCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Luxury:</span>
                                <span id="luxuryCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Facilities Panels -->
            <div class="facilities-panels">
                <div class="data-panel schools-panel">
                    <div class="panel-title">
                        <i class="fas fa-graduation-cap"></i> Schools
                    </div>
                    <div class="panel-value" id="schoolsCount">0</div>
                    <div class="panel-subtitle">Educational facilities</div>
                </div>
                
                <div class="data-panel hospitals-panel">
                    <div class="panel-title">
                        <i class="fas fa-hospital"></i> Hospitals
                    </div>
                    <div class="panel-value" id="hospitalsCount">0</div>
                    <div class="panel-subtitle">Health facilities</div>
                </div>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Enhanced PropertyIntel System
        class PropertyIntelSystem {
            constructor() {
                this.map = null;
                this.currentProperty = null;
                this.selectedMarker = null;
                this.facilities = [];
                this.schools = [];
                this.propertyMarkers = [];
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.nearbyHospitals = [];
                this.nearbySchools = [];
                this.filteredProperties = [];
                this.isSending = false;
                
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m²', yearBuilt: 2022, district: 'Nyarugenge', amenities: ['Pool', 'Gym', 'Security', 'Parking'] },
                    { id: 2, lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m²', yearBuilt: 2019, district: 'Nyarugenge', amenities: ['Security', 'Parking'] },
                    { id: 3, lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m²', yearBuilt: 2021, district: 'Gasabo', amenities: ['Garden', 'Pool', 'Security', 'Garage'] },
                    { id: 4, lat: -1.9356, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m²', yearBuilt: 2018, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 5, lat: -1.9416, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m²', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security', 'Balcony'] },
                    { id: 6, lat: -1.9634, lng: 30.0929, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m²', yearBuilt: 2017, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 7, lat: -1.9604, lng: 30.0959, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m²', yearBuilt: 2023, district: 'Gasabo', amenities: ['Pool', 'Garden', 'Security', 'Smart Home'] },
                    { id: 8, lat: -1.9564, lng: 30.0899, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m²', yearBuilt: 2019, district: 'Gasabo', amenities: ['River View', 'Security'] },
                    { id: 9, lat: -1.9456, lng: 30.1212, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m²', yearBuilt: 2020, district: 'Gasabo', amenities: ['Parking', 'Security'] },
                    { id: 10, lat: -1.9486, lng: 30.1242, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m²', yearBuilt: 2021, district: 'Gasabo', amenities: ['Gym', 'Security', 'Parking'] },
                    { id: 11, lat: -1.9756, lng: 30.0729, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m²', yearBuilt: 2019, district: 'Kicukiro', amenities: ['Garden', 'Security', 'Workshop'] },
                    { id: 12, lat: -1.9686, lng: 30.0759, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m²', yearBuilt: 2016, district: 'Kicukiro', amenities: ['Parking'] },
                    { id: 13, lat: -1.9606, lng: 30.0529, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m²', yearBuilt: 2018, district: 'Nyarugenge', amenities: ['Garden', 'Traditional Design'] },
                    { id: 14, lat: -1.9536, lng: 30.0499, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m²', yearBuilt: 2017, district: 'Nyarugenge', amenities: ['Garden', 'Cultural Features'] },
                    { id: 15, lat: -1.9256, lng: 30.0919, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m²', yearBuilt: 2024, district: 'Gasabo', amenities: ['Pool', 'Gym', 'Cinema', 'Smart Home', 'Wine Cellar'] },
                    { id: 16, lat: -1.9186, lng: 30.0889, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m²', yearBuilt: 2022, district: 'Gasabo', amenities: ['View', 'Security', 'Garden'] },
                    { id: 17, lat: -1.9706, lng: 30.1059, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m²', yearBuilt: 2018, district: 'Gasabo', amenities: ['Study Area', 'Internet'] },
                    { id: 18, lat: -1.9636, lng: 30.1029, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m²', yearBuilt: 2019, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 19, lat: -1.9356, lng: 30.1112, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m²', yearBuilt: 2023, district: 'Gasabo', amenities: ['Golf Access', 'Pool', 'Tennis Court', 'Spa'] },
                    { id: 20, lat: -1.9286, lng: 30.1082, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m²', yearBuilt: 2021, district: 'Gasabo', amenities: ['Golf View', 'Security', 'Gym'] }
                ];
                
                this.init();
            }
            
            async init() {
                await this.loadFacilities();
                await this.loadSchools();
                this.initializeMap();
                this.setupEventListeners();
                this.updateStats(); // This will now show the breakdown
            }
            
            async loadFacilities() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.facilities = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.lat && 
                            feature.attributes.long
                        ).map(feature => ({
                            facility_name: feature.attributes.facility_name || 'Unknown',
                            facility_type: feature.attributes.facility_type || 'Unknown',
                            lat: feature.attributes.lat,
                            long: feature.attributes.long,
                            district: feature.attributes.district || 'N/A',
                            sector: feature.attributes.sector || 'N/A',
                            ownership: feature.attributes.ownership || 'N/A'
                        }));
                        console.log('Loaded health facilities:', this.facilities.length);
                    }
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                    // Fallback data
                    this.facilities = [
                        { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo" },
                        { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge" },
                        { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro" }
                    ];
                }
                
                document.getElementById('hospitalsCount').textContent = this.facilities.length;
            }
            
            async loadSchools() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.schools = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.latitude && 
                            feature.attributes.longitude
                        ).map(feature => ({
                            school_name: feature.attributes.school_nam || 'Unknown School',
                            school_type: feature.attributes.school_typ || 'Unknown',
                            school_category: feature.attributes.school_cat || 'PRE_PRIMARY',
                            school_status: feature.attributes.school_sta || 'Unknown',
                            curriculum: feature.attributes.curriculum || 'National',
                            lat: feature.attributes.latitude,
                            lng: feature.attributes.longitude,
                            established: feature.attributes.establishm || 'N/A'
                        }));
                        console.log('Loaded schools:', this.schools.length);
                    }
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    // Sample fallback data
                    this.schools = [
                        { school_name: "ITETERO NURSERY SCHOOL", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9489, lng: 30.0000, established: 2009 },
                        { school_name: "Green Hills Academy", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "INTERNATIONAL", lat: -1.9556, lng: 30.1044, established: 2006 },
                        { school_name: "Kigali Parents School", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9386, lng: 30.0619, established: 2010 }
                    ];
                }
                
                document.getElementById('schoolsCount').textContent = this.schools.length;
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
                
                // Only add properties to map initially
                this.addProperties();
                
                // Prepare hospitals and schools markers but don't add to map
                this.prepareHospitals();
                this.prepareSchools();
                
                this.map.on('click', this.handleMapClick.bind(this));
                
                new ResizeObserver(() => this.map.invalidateSize()).observe(document.getElementById('map'));
            }
            
            addProperties() {
                this.propertyMarkers = [];
                this.filteredProperties = [...this.properties];
                
                this.properties.forEach((prop) => {
                    const isLuxury = prop.type.toLowerCase().includes('luxury');
                    const markerClass = `property-marker ${prop.status} ${isLuxury ? 'luxury' : ''}`;
                    
                    // Simplify price label - remove "M RWF" for cleaner look
                    const priceLabel = prop.price.replace(' RWF', '').replace('M', '');
                    
                    const marker = L.marker([prop.lat, prop.lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: priceLabel,
                            iconSize: [60, 24], // Fixed size
                            iconAnchor: [30, 12], // Center the marker properly
                            popupAnchor: [0, -12] // Position popup correctly
                        })
                    });
                    
                    // Simplified tooltip with key info only
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">${prop.name}</div>
                        <div style="margin-bottom: 2px; font-size: 12px;">📍 ${prop.district} • ${prop.bedrooms}BR</div>
                        <div style="font-weight: 600; color: #6366f1; font-size: 13px;">💰 ${prop.price}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: false,
                        className: 'compact-tooltip'
                    });
                    
                    marker.on('click', () => this.selectProperty(prop, marker));
                    marker.addTo(this.map);
                    
                    this.propertyMarkers.push({
                        marker: marker,
                        property: prop,
                        visible: true
                    });
                });
                
                // Add zoom-based styling
                this.map.on('zoomend', () => {
                    const zoom = this.map.getZoom();
                    this.propertyMarkers.forEach(item => {
                        const element = item.marker.getElement();
                        if (element) {
                            if (zoom < 12) {
                                element.classList.add('distant');
                            } else {
                                element.classList.remove('distant');
                            }
                        }
                    });
                });
                
                this.updateFilterSummary();
            }
            
            prepareHospitals() {
                this.hospitalMarkers = [];
                // Create hospital markers but don't add to map initially
                this.facilities.forEach(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: '🏥',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">🏥 ${facility.facility_name}</div>
                        <div style="margin-bottom: 2px;">📋 ${facility.facility_type}</div>
                        <div>📍 ${facility.district}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    // Store marker but don't add to map
                    this.hospitalMarkers.push(marker);
                });
            }
            
            prepareSchools() {
                this.schoolMarkers = [];
                // Create school markers but don't add to map initially
                this.schools.forEach(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: '🎓',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">🎓 ${school.school_name}</div>
                        <div style="margin-bottom: 2px;">📚 ${school.school_status} School</div>
                        <div style="margin-bottom: 2px;">📖 ${school.curriculum} Curriculum</div>
                        <div>📅 Est. ${school.established}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    // Store marker but don't add to map
                    this.schoolMarkers.push(marker);
                });
            }
            
            selectProperty(property, marker) {
                // Remove previous selection
                if (this.selectedMarker) {
                    const prevElement = this.selectedMarker.getElement();
                    if (prevElement) {
                        prevElement.classList.remove('selected');
                    }
                }
                
                this.currentProperty = property;
                this.selectedMarker = marker;
                
                // Add selection class
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
                
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('chatInput').placeholder = `Ask about ${property.name}...`;
                
                this.analyzeProperty(property);
                this.map.setView([property.lat, property.lng], 15);
            }
            
            analyzeProperty(property) {
                // Clear any existing markers first
                this.clearNearbyMarkers();
                
                this.analyzeProximity(property);
                this.displayPropertyAnalysis(property);
                this.showNearbyFacilities(property);
            }
            
            clearNearbyMarkers() {
                // Remove any existing nearby facility markers
                this.hospitalMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                
                this.schoolMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
            }
            
            showNearbyFacilities(property) {
                // Show nearby hospitals
                this.nearbyHospitals.forEach(hospital => {
                    const marker = this.hospitalMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - hospital.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - hospital.long) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
                
                // Show nearby schools
                this.nearbySchools.forEach(school => {
                    const marker = this.schoolMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - school.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - school.lng) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
            }
            
            analyzeProximity(property) {
                // Analyze hospitals
                this.nearbyHospitals = [];
                this.facilities.forEach(facility => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= 3) { // 3km for hospitals
                        this.nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                    }
                });
                this.nearbyHospitals.sort((a, b) => a.distance - b.distance);
                
                // Analyze schools
                this.nearbySchools = [];
                this.schools.forEach(school => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([school.lat, school.lng]) / 1000;
                    
                    if (distance <= 2) { // 2km for schools
                        this.nearbySchools.push({
                            ...school,
                            distance: distance
                        });
                    }
                });
                this.nearbySchools.sort((a, b) => a.distance - b.distance);
            }
            
            displayPropertyAnalysis(property) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                // Property Info
                let propertyHtml = `
                    <div class="property-info">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">${property.name}</h3>
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> ${property.type}</div>
                        <div style="margin-bottom: 6px;"><strong>Price:</strong> ${property.price}</div>
                        <div style="margin-bottom: 6px;"><strong>Size:</strong> ${property.bedrooms}BR • ${property.bathrooms}BA • ${property.area}</div>
                        <div style="margin-bottom: 6px;"><strong>Built:</strong> ${property.yearBuilt}</div>
                        <div style="margin-bottom: 6px;"><strong>District:</strong> ${property.district}</div>
                        <div><strong>Amenities:</strong> ${property.amenities ? property.amenities.join(', ') : 'Standard'}</div>
                    </div>`;
                
                messagesContainer.innerHTML += propertyHtml;
                
                // Education Analysis
                if (this.nearbySchools.length > 0) {
                    let schoolHtml = `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">🎓 Education Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbySchools.length} schools within 2km</p>
                            <div class="facility-list">`;
                    
                    this.nearbySchools.slice(0, 5).forEach(school => {
                        schoolHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${school.lat}, ${school.lng})">
                                <div class="facility-name">${school.school_name}</div>
                                <div class="facility-distance">${(school.distance * 1000).toFixed(0)}m</div>
                            </div>`;
                    });
                    
                    schoolHtml += `</div></div>`;
                    messagesContainer.innerHTML += schoolHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">⚠️ Education Access</h4>
                            <p>No schools within 2km walking distance. Consider transportation needs for school-age children.</p>
                        </div>`;
                }
                
                // Healthcare Analysis
                if (this.nearbyHospitals.length > 0) {
                    let hospitalHtml = `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">🏥 Healthcare Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbyHospitals.length} health facilities within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbyHospitals.slice(0, 5).forEach(hospital => {
                        hospitalHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${hospital.lat}, ${hospital.long})">
                                <div class="facility-name">${hospital.facility_name}</div>
                                <div class="facility-distance">${hospital.distance.toFixed(1)}km</div>
                            </div>`;
                    });
                    
                    hospitalHtml += `</div></div>`;
                    messagesContainer.innerHTML += hospitalHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">⚠️ Healthcare Access</h4>
                            <p>No hospitals within 3km radius. Emergency services may take longer to reach this location.</p>
                        </div>`;
                }
                
                this.scrollToBottom();
            }
            
            focusLocation(lat, lng) {
                this.map.setView([lat, lng], 16);
            }
            
            handleMapClick(e) {
                // Clear nearby facility markers when clicking on empty map
                this.clearNearbyMarkers();
                
                if (!this.currentProperty) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-title">Welcome to PropertyIntel!</div>
                            Click on any property marker to see detailed analysis including nearby schools and hospitals.
                        </div>`;
                }
            }
            
            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const locationSearch = document.getElementById('locationSearch');
                const searchBtn = document.getElementById('searchBtn');
                const locationBtn = document.getElementById('locationBtn');
                const statusFilter = document.getElementById('statusFilter');
                const typeFilter = document.getElementById('typeFilter');
                const priceFilter = document.getElementById('priceFilter');
                
                // Chat input
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Search
                locationSearch.addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.performLocationSearch();
                });
                
                searchBtn.addEventListener('click', () => this.performLocationSearch());
                locationBtn.addEventListener('click', () => this.useCurrentLocation());
                
                // Filters
                statusFilter.addEventListener('change', () => this.applyFilters());
                typeFilter.addEventListener('change', () => this.applyFilters());
                priceFilter.addEventListener('change', () => this.applyFilters());
            }
            
            async performLocationSearch() {
                const locationSearch = document.getElementById('locationSearch');
                const location = locationSearch.value.trim();
                if (!location) return;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const { lat, lon } = results[0];
                        this.map.setView([lat, lon], 16);
                    } else {
                        alert('Location not found in Kigali');
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    alert('Search failed. Please try again.');
                }
            }
            
            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported by this browser');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        this.map.setView([lat, lng], 15);
                    },
                    error => {
                        alert('Unable to get your location');
                    }
                );
            }
            
            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priceFilter = document.getElementById('priceFilter').value;
                
                this.filteredProperties = this.properties.filter(property => {
                    if (statusFilter && property.status !== statusFilter) return false;
                    
                    if (typeFilter) {
                        const propType = property.type.toLowerCase();
                        if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                        if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                        if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                        if (typeFilter === 'house' && !propType.includes('house')) return false;
                    }
                    
                    if (priceFilter) {
                        const price = parseInt(property.price.replace(/[^0-9]/g, ''));
                        if (priceFilter === '0-50' && price >= 50) return false;
                        if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                        if (priceFilter === '100-200' && (price < 100 || price >= 200)) return false;
                        if (priceFilter === '200+' && price < 200) return false;
                    }
                    
                    return true;
                });
                
                this.updatePropertyVisibility();
                this.updateFilterSummary();
                this.updateStats();
            }
            
            updatePropertyVisibility() {
                this.propertyMarkers.forEach(item => {
                    const isVisible = this.filteredProperties.includes(item.property);
                    if (isVisible && !item.visible) {
                        item.marker.addTo(this.map);
                        item.visible = true;
                    } else if (!isVisible && item.visible) {
                        this.map.removeLayer(item.marker);
                        item.visible = false;
                    }
                });
            }
            
            updateFilterSummary() {
                const filterSummary = document.getElementById('filterSummary');
                const total = this.properties.length;
                const shown = this.filteredProperties.length;
                
                filterSummary.textContent = shown === total ? 
                    `Showing all ${total} properties` : 
                    `Showing ${shown} of ${total} properties`;
            }
            
            updateStats() {
                const forSale = this.filteredProperties.filter(p => p.status === 'sale').length;
                const forRent = this.filteredProperties.filter(p => p.status === 'rent').length;
                
                // Count by property type
                const apartments = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('apartment')).length;
                const houses = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('house')).length;
                const villas = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('villa') && !p.type.toLowerCase().includes('luxury')).length;
                const luxury = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('luxury')).length;
                
                // Update all counters
                document.getElementById('propertiesCount').textContent = this.filteredProperties.length;
                document.getElementById('forSaleCount').textContent = forSale;
                document.getElementById('forRentCount').textContent = forRent;
                document.getElementById('apartmentCount').textContent = apartments;
                document.getElementById('houseCount').textContent = houses;
                document.getElementById('villaCount').textContent = villas;
                document.getElementById('luxuryCount').textContent = luxury;
            }
            
            sendMessage() {
                if (this.isSending) return;
                this.isSending = true;
                
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message || !this.currentProperty) {
                    this.isSending = false;
                    return;
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.generateAIResponse(message, this.currentProperty);
                    this.isSending = false;
                }, 1500);
                
                this.scrollToBottom();
            }
            
            generateAIResponse(question, property) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('school') || lowerQuestion.includes('education')) {
                    response = this.generateSchoolResponse(property);
                } else if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                    response = this.generateHealthResponse(property);
                } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('investment')) {
                    response = this.generatePriceResponse(property);
                } else if (lowerQuestion.includes('family') || lowerQuestion.includes('children')) {
                    response = this.generateFamilyResponse(property);
                } else {
                    response = this.generateGeneralResponse(property);
                }
                
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                
                this.scrollToBottom();
            }
            
            generateSchoolResponse(property) {
                // Show schools when user asks about education
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>🎓 Education Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbySchools.length > 0) {
                    response += `Great news for families! Found <strong>${this.nearbySchools.length} schools</strong> within 2km:<br><br>`;
                    
                    this.nearbySchools.slice(0, 3).forEach(school => {
                        const walkTime = Math.round(school.distance * 12);
                        response += `📚 <strong>${school.school_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;• Type: ${school.school_status} (${school.curriculum})<br>`;
                        response += `&nbsp;&nbsp;&nbsp;• Distance: ${(school.distance * 1000).toFixed(0)}m (~${walkTime} min walk)<br><br>`;
                    });
                    
                    response += `This property offers excellent educational access for families with children!`;
                } else {
                    response += `No schools found within 2km of this property.<br><br>`;
                    response += `<strong>Recommendations:</strong><br>`;
                    response += `• Consider school transport services<br>`;
                    response += `• Look into private school bus routes<br>`;
                    response += `• Factor in daily commute time for school runs`;
                }
                
                return response;
            }
            
            generateHealthResponse(property) {
                // Show hospitals when user asks about healthcare
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>🏥 Healthcare Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbyHospitals.length > 0) {
                    response += `Excellent healthcare coverage! <strong>${this.nearbyHospitals.length} health facilities</strong> within 3km:<br><br>`;
                    
                    this.nearbyHospitals.slice(0, 3).forEach(hospital => {
                        response += `🏥 <strong>${hospital.facility_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;• Type: ${hospital.facility_type}<br>`;
                        response += `&nbsp;&nbsp;&nbsp;• Distance: ${hospital.distance.toFixed(1)}km<br><br>`;
                    });
                    
                    response += `Emergency response time: approximately 5-15 minutes depending on traffic.`;
                } else {
                    response += `Limited healthcare access - no major facilities within 3km.<br><br>`;
                    response += `<strong>Important considerations:</strong><br>`;
                    response += `• Emergency response may take 20+ minutes<br>`;
                    response += `• Consider proximity to main roads for ambulance access<br>`;
                    response += `• Keep emergency contact numbers and first aid supplies ready`;
                }
                
                return response;
            }
            
            generatePriceResponse(property) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                let response = `<h4>💰 Investment Analysis for ${property.name}</h4><br>`;
                
                response += `<strong>Current Price:</strong> ${property.price}<br>`;
                response += `<strong>Price per m²:</strong> ${Math.round(priceValue * 1000000 / parseInt(property.area))} RWF/m²<br><br>`;
                
                // Calculate scores based on amenities
                let investmentScore = 60; // Base score
                
                // Location premium
                if (property.district === 'Gasabo') investmentScore += 15;
                else if (property.district === 'Nyarugenge') investmentScore += 10;
                else investmentScore += 5;
                
                // School proximity
                investmentScore += Math.min(this.nearbySchools.length * 5, 15);
                
                // Hospital proximity  
                investmentScore += Math.min(this.nearbyHospitals.length * 3, 10);
                
                response += `<strong>Investment Score: ${Math.min(investmentScore, 100)}/100</strong><br><br>`;
                
                if (property.status === 'sale') {
                    const estimatedRent = Math.round(priceValue * 0.5); // 0.5% monthly return
                    response += `<strong>Rental Potential:</strong><br>`;
                    response += `• Estimated monthly rent: ${estimatedRent}K RWF<br>`;
                    response += `• Annual yield: ~6%<br><br>`;
                }
                
                response += `<strong>Value Drivers:</strong><br>`;
                response += `• ${this.nearbySchools.length} schools nearby<br>`;
                response += `• ${this.nearbyHospitals.length} health facilities<br>`;
                response += `• ${property.district} district location<br>`;
                response += `• Built in ${property.yearBuilt} (${2025 - property.yearBuilt} years old)`;
                
                return response;
            }
            
            generateFamilyResponse(property) {
                let response = `<h4>👨‍👩‍👧‍👦 Family Suitability Analysis</h4><br>`;
                
                let familyScore = 50; // Base score
                
                // Space assessment
                if (property.bedrooms >= 4) familyScore += 20;
                else if (property.bedrooms >= 3) familyScore += 15;
                else if (property.bedrooms >= 2) familyScore += 10;
                
                // Education access
                if (this.nearbySchools.length >= 3) familyScore += 20;
                else if (this.nearbySchools.length >= 1) familyScore += 10;
                
                // Healthcare access
                if (this.nearbyHospitals.length >= 2) familyScore += 10;
                else if (this.nearbyHospitals.length >= 1) familyScore += 5;
                
                response += `<strong>Family Score: ${Math.min(familyScore, 100)}/100</strong><br><br>`;
                
                response += `<strong>Space Assessment:</strong><br>`;
                response += `• ${property.bedrooms} bedrooms, ${property.bathrooms} bathrooms<br>`;
                response += `• Total area: ${property.area}<br>`;
                response += `• Suitable for ${property.bedrooms <= 2 ? 'small families' : property.bedrooms <= 4 ? 'medium families' : 'large families'}<br><br>`;
                
                response += `<strong>Child-Friendly Features:</strong><br>`;
                response += `• Education: ${this.nearbySchools.length} schools within 2km<br>`;
                response += `• Healthcare: ${this.nearbyHospitals.length} health facilities within 3km<br>`;
                response += `• Safety: ${property.amenities && property.amenities.includes('Security') ? 'Secured compound' : 'Check security measures'}<br>`;
                response += `• Recreation: ${property.amenities && property.amenities.includes('Garden') ? 'Garden space available' : 'Limited outdoor space'}<br><br>`;
                
                if (familyScore >= 80) {
                    response += `<strong>Verdict:</strong> 🏆 Excellent choice for families with children!`;
                } else if (familyScore >= 60) {
                    response += `<strong>Verdict:</strong> 👍 Good option for families with some planning.`;
                } else {
                    response += `<strong>Verdict:</strong> 💼 Better suited for professionals or couples without children.`;
                }
                
                return response;
            }
            
            generateGeneralResponse(property) {
                let response = `<h4>🏠 Complete Property Overview</h4><br>`;
                
                response += `I can provide detailed insights about <strong>${property.name}</strong>:<br><br>`;
                
                response += `<strong>Available Analysis:</strong><br>`;
                response += `• 🎓 <strong>Education:</strong> ${this.nearbySchools.length} schools within 2km<br>`;
                response += `• 🏥 <strong>Healthcare:</strong> ${this.nearbyHospitals.length} health facilities within 3km<br>`;
                response += `• 💰 <strong>Investment potential</strong> and pricing analysis<br>`;
                response += `• 👨‍👩‍👧‍👦 <strong>Family suitability</strong> assessment<br>`;
                response += `• 🚗 <strong>Transportation</strong> and accessibility<br><br>`;
                
                response += `<strong>Quick Facts:</strong><br>`;
                response += `• Location: ${property.district} District<br>`;
                response += `• Size: ${property.bedrooms}BR, ${property.bathrooms}BA, ${property.area}<br>`;
                response += `• Year Built: ${property.yearBuilt}<br>`;
                response += `• Status: ${property.status === 'sale' ? 'For Sale' : 'For Rent'}<br><br>`;
                
                response += `What specific aspect would you like me to analyze in detail?`;
                
                return response;
            }
            
            showTyping() {
                document.getElementById('typingIndicator').classList.add('show');
            }
            
            hideTyping() {
                document.getElementById('typingIndicator').classList.remove('show');
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        }
        
        // Global functions for button handlers
        let propertyIntel = null;
        
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            chatContainer.classList.toggle('collapsed');
            
            if (chatContainer.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
            }
            
            if (propertyIntel) propertyIntel.map.invalidateSize();
        }
        
        // Initialize the system when page loads
        window.addEventListener('DOMContentLoaded', () => {
            propertyIntel = new PropertyIntelSystem();
        });
    </script>
</body>
</html>
