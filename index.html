<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: #ffffff;
            height: 100vh;
        }
        .main-container {
            display: flex;
            height: 100vh;
            background: #16213e;
        }
        .chat-container {
            width: 400px;
            background: rgba(15, 15, 25, 0.95);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            background: #667eea;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .chat-header small {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .search-controls {
            padding: 15px;
            background: rgba(10, 10, 15, 0.8);
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            outline: none;
        }
        .search-input:focus {
            border-color: #667eea;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .control-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: #667eea;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .control-btn:hover {
            background: #764ba2;
        }
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
        }
        .message {
            margin-bottom: 15px;
        }
        .message.ai .message-content {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px 12px 12px 4px;
            padding: 12px;
            font-size: 0.9rem;
        }
        .message.user .message-content {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px 12px 4px 12px;
            padding: 12px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 80%;
        }
        .chat-input-container {
            padding: 15px;
            background: rgba(10, 10, 15, 0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
        }
        .chat-input:focus {
            border-color: #667eea;
        }
        .send-btn {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: #667eea;
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        .send-btn:hover {
            background: #764ba2;
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 12px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .property-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }
        .property-marker.sale {
            background: #ff6b6b;
        }
        .property-marker.rent {
            background: #667eea;
        }
        .property-marker.special {
            background: #ffd700;
        }
        .location-info {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        .location-info .status-sale { color: #ff6b6b; font-weight: bold; }
        .location-info .status-rent { color: #667eea; font-weight: bold; }
        .location-info .status-special { color: #ffd700; font-weight: bold; }
        .buffer-school { fill: rgba(0, 255, 136, 0.2); stroke: #00ff88; }
        .buffer-hospital { fill: rgba(102, 126, 234, 0.2); stroke: #667eea; }
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .chat-container { width: 100%; height: 50vh; }
            .map-container { height: 50vh; margin: 0; }
            .control-buttons { flex-direction: column; }
        }
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                PropertyIntel Kigali <small>AI Real Estate Advisor</small>
            </div>
            <div class="search-controls">
                <input type="text" class="search-input" id="searchInput" placeholder="Search Kigali locations...">
                <div class="control-buttons">
                    <button class="control-btn" id="locationBtn"><i class="fas fa-location-arrow"></i> My Location</button>
                    <button class="control-btn" id="randomBtn"><i class="fas fa-dice"></i> Random Property</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask about this property..." rows="1" disabled></textarea>
                <button class="send-btn" id="sendBtn" disabled>Send</button>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentLocation, bufferLayers = [];
        const ai = {
            identifyNeighborhood(lat, lng) {
                if (lat > -1.93 && lat < -1.92 && lng > 30.10 && lng < 30.12) return 'Kimihurura';
                if (lat > -1.96 && lat < -1.94 && lng > 30.09 && lng < 30.11) return 'Remera';
                if (lat > -1.95 && lat < -1.93 && lng > 30.05 && lng < 30.08) return 'City Center';
                if (lat > -1.97 && lat < -1.95 && lng > 30.05 && lng < 30.08) return 'Nyamirambo';
                if (lat > -1.91 && lat < -1.89 && lng > 30.12 && lng < 30.15) return 'Nyarutarama';
                return 'Kigali Area';
            },
            generateSpatialContext(lat, lng) {
                const neighborhood = this.identifyNeighborhood(lat, lng);
                const data = {
                    'Kimihurura': { priceRange: '80M-200M RWF', appreciation: '3-5%' },
                    'Nyarutarama': { priceRange: '100M-300M RWF', appreciation: '5-8%' },
                    'Remera': { priceRange: '30M-80M RWF', appreciation: '4-6%' },
                    'Nyamirambo': { priceRange: '20M-60M RWF', appreciation: '6-10%' },
                    'Kigali Area': { priceRange: '20M-80M RWF', appreciation: '4-7%' }
                }[neighborhood] || { priceRange: '20M-80M RWF', appreciation: '4-7%' };
                return {
                    neighborhood,
                    coordinates: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                    priceRange: data.priceRange,
                    appreciation: data.appreciation,
                    infrastructure: Math.round(Math.random() * 40 + 60),
                    amenities: Math.round(Math.random() * 40 + 60)
                };
            },
            getSpatialInsights(spatialContext) {
                return `**${spatialContext.neighborhood} Analysis**
- Price Range: ${spatialContext.priceRange}
- Annual Appreciation: ${spatialContext.appreciation}
- Infrastructure: ${spatialContext.infrastructure}/100
- Amenities: ${spatialContext.amenities}/100
- Investment Tip: ${spatialContext.appreciation.includes('6-10%') ? 'High growth potential, negotiate hard.' : 'Stable market, verify infrastructure.'}`;
            }
        };

        // Sample JSON data for schools and hospitals
        const facilities = {
            schools: [
                { name: "Kigali Primary", lat: -1.9500, lng: 30.1000 },
                { name: "Green Hills Academy", lat: -1.9200, lng: 30.1100 },
                { name: "International School", lat: -1.9400, lng: 30.0900 }
            ],
            hospitals: [
                { name: "King Faisal Hospital", lat: -1.9300, lng: 30.1200 },
                { name: "CHUK Hospital", lat: -1.9600, lng: 30.0800 }
            ]
        };

        function initializeMap() {
            map = L.map('map').setView([-1.9441, 30.0619], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            addSampleProperties();
            map.on('click', e => handleMapClick(e.latlng));
        }

        function addSampleProperties() {
            const properties = [
                { lat: -1.9286, lng: 30.1044, name: 'Sunset Villa', type: 'Villa', price: '120M RWF', status: 'sale' },
                { lat: -1.9506, lng: 30.0939, name: 'City View Apt', type: 'Apartment', price: '45M RWF', status: 'rent' },
                { lat: -1.9634, lng: 30.1029, name: 'Green Hills House', type: 'House', price: '65M RWF', status: 'sale' },
                { lat: -1.9456, lng: 30.0612, name: 'Golden Villa', type: 'Suspicious Villa', price: '250M RWF', status: 'sale' }
            ];
            properties.forEach(prop => {
                const isSpecial = prop.type === 'Suspicious Villa';
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${isSpecial ? 'special' : prop.status}`,
                        html: `<div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                marker.bindTooltip(`${prop.name}<br>${prop.price}<br>${prop.status.charAt(0).toUpperCase() + prop.status.slice(1)}`, {
                    direction: 'top'
                });
                marker.on('click', () => handleMapClick(L.latLng(prop.lat, prop.lng), prop));
            });
        }

        function addFacilityBuffers(lat, lng) {
            bufferLayers.forEach(layer => map.removeLayer(layer));
            bufferLayers = [];

            facilities.schools.forEach(school => {
                const distance = L.latLng(lat, lng).distanceTo([school.lat, school.lng]) / 1000;
                if (distance <= 2) {
                    bufferLayers.push(L.circle([school.lat, school.lng], {
                        radius: 2000,
                        className: 'buffer-school',
                        fillOpacity: 0.2,
                        color: '#00ff88'
                    }).addTo(map));
                }
            });

            facilities.hospitals.forEach(hospital => {
                const distance = L.latLng(lat, lng).distanceTo([hospital.lat, hospital.lng]) / 1000;
                if (distance <= 5) {
                    bufferLayers.push(L.circle([hospital.lat, hospital.lng], {
                        radius: 5000,
                        className: 'buffer-hospital',
                        fillOpacity: 0.2,
                        color: '#667eea'
                    }).addTo(map));
                }
            });
        }

        function getProximityAnalysis(lat, lng) {
            let analysis = '**Proximity Analysis**\n';
            const nearbySchools = facilities.schools
                .filter(school => L.latLng(lat, lng).distanceTo([school.lat, school.lng]) / 1000 <= 2)
                .map(school => `${school.name} (${(L.latLng(lat, lng).distanceTo([school.lat, school.lng]) / 1000).toFixed(1)} km)`);
            const nearbyHospitals = facilities.hospitals
                .filter(hospital => L.latLng(lat, lng).distanceTo([hospital.lat, hospital.lng]) / 1000 <= 5)
                .map(hospital => `${hospital.name} (${(L.latLng(lat, lng).distanceTo([hospital.lat, hospital.lng]) / 1000).toFixed(1)} km)`);
            analysis += nearbySchools.length ? `Schools within 2 km:\n- ${nearbySchools.join('\n- ')}\n` : 'No schools within 2 km.\n';
            analysis += nearbyHospitals.length ? `Hospitals within 5 km:\n- ${nearbyHospitals.join('\n- ')}` : 'No hospitals within 5 km.';
            return analysis;
        }

        async function handleMapClick(latlng, propertyData = null) {
            currentLocation = latlng;
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            const spatialContext = ai.generateSpatialContext(latlng.lat, latlng.lng);
            addLocationMessage(spatialContext, propertyData);
            addFacilityBuffers(latlng.lat, latlng.lng);
            messagesContainer.innerHTML += `<div class="message ai"><div class="message-content">${ai.getSpatialInsights(spatialContext)}</div></div>`;
            messagesContainer.innerHTML += `<div class="message ai"><div class="message-content">${getProximityAnalysis(latlng.lat, latlng.lng)}</div></div>`;
            scrollToBottom();
        }

        function addLocationMessage(spatialContext, propertyData) {
            const messagesContainer = document.getElementById('chatMessages');
            const statusClass = propertyData ? (propertyData.type === 'Suspicious Villa' ? 'status-special' : propertyData.status === 'sale' ? 'status-sale' : 'status-rent') : '';
            messagesContainer.innerHTML += `
                <div class="location-info">
                    <strong>📍 ${spatialContext.neighborhood}</strong><br>
                    ${propertyData ? `
                        Name: ${propertyData.name}<br>
                        Type: ${propertyData.type}<br>
                        Price: ${propertyData.price}<br>
                        <span class="${statusClass}">Status: ${propertyData.status.charAt(0).toUpperCase() + prop.status.slice(1)}</span><br>
                    ` : ''}
                    Coordinates: ${spatialContext.coordinates}
                </div>`;
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const searchInput = document.getElementById('searchInput');
            const locationBtn = document.getElementById('locationBtn');
            const randomBtn = document.getElementById('randomBtn');

            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 80) + 'px';
            });
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            sendBtn.addEventListener('click', sendMessage);
            searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            locationBtn.addEventListener('click', useCurrentLocation);
            randomBtn.addEventListener('click', selectRandomProperty);
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || !currentLocation) return;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `<div class="message user"><div class="message-content">${message}</div></div>`;
            chatInput.value = '';
            chatInput.style.height = 'auto';
            const spatialContext = ai.generateSpatialContext(currentLocation.lat, currentLocation.lng);
            const response = ai.getSpatialInsights(spatialContext);
            messagesContainer.innerHTML += `<div class="message ai"><div class="message-content">${response}</div></div>`;
            scrollToBottom();
        }

        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const location = searchInput.value.trim();
            if (!location) return alert('Enter a location');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                const results = await response.json();
                if (results.length) {
                    const { lat, lon } = results[0];
                    map.setView([lat, lon], 16);
                    handleMapClick(L.latLng(lat, lon));
                } else {
                    alert('Location not found');
                }
            } catch (error) {
                alert('Search failed');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) return alert('Geolocation not supported');
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude: lat, longitude: lng } = position.coords;
                    if (lat < -2.2 || lat > -1.7 || lng < 29.8 || lng > 30.3) {
                        alert('Location outside Kigali');
                        return;
                    }
                    map.setView([lat, lng], 16);
                    handleMapClick(L.latLng(lat, lng));
                },
                () => alert('Unable to get location')
            );
        }

        function selectRandomProperty() {
            const properties = [
                { lat: -1.9286, lng: 30.1044 },
                { lat: -1.9506, lng: 30.0939 },
                { lat: -1.9634, lng: 30.1029 },
                { lat: -1.9456, lng: 30.0612 }
            ];
            const random = properties[Math.floor(Math.random() * properties.length)];
            map.setView([random.lat, random.lng], 16);
            handleMapClick(L.latLng(random.lat, random.lng));
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            setupEventListeners();
        });
    </script>
</body>
</html>
