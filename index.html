<script>
    class SpatialIntelligenceSystem {
        constructor() {
            this.map = null;
            this.currentProperty = null;
            this.selectedMarker = null;
            this.properties = [];
            this.hospitals = [];
            this.schools = [];
            this.nearbyHospitals = [];
            this.nearbySchools = [];
            this.hospitalMarkers = [];
            this.schoolMarkers = [];
            this.filteredProperties = [];
            this.markerCluster = null;
            this.init();
        }
        async init() {
            await this.loadData();
            this.initializeMap();
            this.setupEventListeners();
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                this.map.invalidateSize(); // Ensure map refreshes after loading
            }, 1000);
        }
        async loadData() {
            const cacheKey = 'propertyIntelData';
            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const data = JSON.parse(cachedData);
                    if (this.validateData(data)) {
                        this.properties = data.properties || [];
                        this.hospitals = data.hospitals || [];
                        this.schools = data.schools || [];
                        console.log('Loaded from cache:', this.properties.length, 'properties');
                        return;
                    } else {
                        console.warn('Invalid cached data. Clearing cache.');
                        localStorage.removeItem(cacheKey);
                    }
                } catch (error) {
                    console.error('Failed to parse cached data:', error);
                    localStorage.removeItem(cacheKey);
                }
            }
            try {
                const [propRes, hospRes, schoolRes] = await Promise.all([
                    fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_RealEstate_Properties.json'),
                    fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json'),
                    fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json')
                ]);
                if (!propRes.ok) throw new Error(`Properties fetch failed: ${propRes.status}`);
                if (!hospRes.ok) throw new Error(`Hospitals fetch failed: ${hospRes.status}`);
                if (!schoolRes.ok) throw new Error(`Schools fetch failed: ${schoolRes.status}`);
                const [propData, hospData, schoolData] = await Promise.all([
                    propRes.json(),
                    hospRes.json(),
                    schoolRes.json()
                ]);
                // Validate and parse properties
                this.properties = this.parseProperties(propData);
                this.hospitals = this.parseHospitals(hospData);
                this.schools = this.parseSchools(schoolData);
                // Cache validated data
                localStorage.setItem(cacheKey, JSON.stringify({
                    properties: this.properties,
                    hospitals: this.hospitals,
                    schools: this.schools
                }));
                console.log('Loaded from server:', this.properties.length, 'properties');
            } catch (error) {
                console.error('Data load failed:', error.message);
                // Fallback to sample data
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, name: 'City Center Apartment', type: 'Apartment', price: '80M RWF', status: 'sale', bedrooms: 2, bathrooms: 2, area: '100m²', district: 'Nyarugenge' }
                ];
                this.hospitals = [
                    { facility_name: 'King Faisal Hospital', facility_type: 'Hospital', lat: -1.9439, long: 30.0951 }
                ];
                this.schools = [
                    { school_name: 'Green Hills Academy', lat: -1.9556, lng: 30.1044 }
                ];
                alert('Failed to load data. Using sample data. Check console for details.');
            }
        }
        validateData(data) {
            return (
                Array.isArray(data.properties) &&
                Array.isArray(data.hospitals) &&
                Array.isArray(data.schools) &&
                data.properties.every(p => p.lat && p.lng && p.id)
            );
        }
        parseProperties(data) {
            if (!data || !Array.isArray(data.features)) {
                console.error('Invalid properties JSON structure. Expected "features" array.');
                return [];
            }
            const properties = data.features
                .filter(f => f.attributes && f.attributes.lat && f.attributes.lng)
                .map(f => ({
                    id: f.attributes.PropertyID || `prop_${Math.random().toString(36).slice(2)}`,
                    lat: parseFloat(f.attributes.lat),
                    lng: parseFloat(f.attributes.lng),
                    name: f.attributes.Name || 'Unnamed Property',
                    type: f.attributes.PropertyType || 'Unknown',
                    price: f.attributes.Price || 'N/A',
                    status: f.attributes.Status?.toLowerCase() || 'unknown',
                    bedrooms: f.attributes.Bedrooms || 0,
                    bathrooms: f.attributes.Bathrooms || 0,
                    area: f.attributes.Area || 'N/A',
                    district: f.attributes.District || 'Unknown'
                }))
                .filter(p => !isNaN(p.lat) && !isNaN(p.lng));
            if (properties.length === 0) {
                console.warn('No valid properties found in JSON data.');
            }
            return properties;
        }
        parseHospitals(data) {
            if (!data || !Array.isArray(data.features)) {
                console.error('Invalid hospitals JSON structure. Expected "features" array.');
                return [];
            }
            return data.features
                .filter(f => f.attributes && f.attributes.lat && f.attributes.long)
                .map(f => ({
                    facility_name: f.attributes.facility_name || 'Unknown',
                    facility_type: f.attributes.facility_type || 'Unknown',
                    lat: parseFloat(f.attributes.lat),
                    long: parseFloat(f.attributes.long)
                }))
                .filter(h => !isNaN(h.lat) && !isNaN(h.long));
        }
        parseSchools(data) {
            if (!data || !Array.isArray(data.features)) {
                console.error('Invalid schools JSON structure. Expected "features" array.');
                return [];
            }
            return data.features
                .filter(f => f.attributes && f.attributes.latitude && f.attributes.longitude)
                .map(f => ({
                    school_name: f.attributes.school_nam || 'Unknown School',
                    lat: parseFloat(f.attributes.latitude),
                    lng: parseFloat(f.attributes.longitude)
                }))
                .filter(s => !isNaN(s.lat) && !isNaN(s.lng));
        }
        initializeMap() {
            this.map = L.map('map').setView([-1.9441, 30.0619], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(this.map);
            this.addProperties();
            this.map.on('click', () => this.clearSelection());
            new ResizeObserver(() => this.map.invalidateSize()).observe(document.getElementById('map'));
        }
        addProperties() {
            if (this.properties.length === 0) {
                console.warn('No properties to display on the map.');
                document.getElementById('chatMessages').innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            No properties loaded. Please check the data source or try again later.
                        </div>
                    </div>`;
                return;
            }
            this.filteredProperties = [...this.properties];
            this.markerCluster = L.markerClusterGroup({
                iconCreateFunction: cluster => L.divIcon({
                    html: `<div style="background: var(--primary); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${cluster.getChildCount()}</div>`,
                    className: 'marker-cluster',
                    iconSize: [36, 36]
                })
            });
            this.filteredProperties.forEach(prop => {
                if (!prop.lat || !prop.lng) {
                    console.warn(`Invalid coordinates for property: ${prop.name}`);
                    return;
                }
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${prop.status}`,
                        html: `<div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                });
                marker.bindTooltip(`
                    <strong>${this.sanitizeHTML(prop.name)}</strong><br>
                    Type: ${this.sanitizeHTML(prop.type)}<br>
                    Price: ${this.sanitizeHTML(prop.price)}<br>
                    ${prop.bedrooms ? `${prop.bedrooms}BR • ${prop.bathrooms}BA` : ''}
                `, { direction: 'top', offset: [0, -10] });
                marker.on('click', () => this.selectProperty(prop, marker));
                this.markerCluster.addLayer(marker);
            });
            this.map.addLayer(this.markerCluster);
            this.updateFilterSummary();
            this.map.invalidateSize(); // Ensure map renders markers
        }
        // ... (rest of the class methods remain unchanged)
        selectProperty(property, marker) {
            if (this.selectedMarker) {
                this.selectedMarker.getElement()?.classList.remove('selected');
            }
            this.currentProperty = property;
            this.selectedMarker = marker;
            marker.getElement()?.classList.add('selected');
            this.analyzeProximity(property);
            this.map.setView([property.lat, property.lng], 15);
        }
        clearSelection() {
            if (this.selectedMarker) {
                this.selectedMarker.getElement()?.classList.remove('selected');
            }
            this.currentProperty = null;
            this.selectedMarker = null;
            this.clearMarkers();
            document.getElementById('chatMessages').innerHTML = `
                <div class="message ai">
                    <div class="message-content">
                        Click a property to view details and nearby amenities.
                    </div>
                </div>`;
        }
        analyzeProximity(property) {
            this.clearMarkers();
            this.nearbyHospitals = [];
            this.nearbySchools = [];
            this.hospitals.forEach(h => {
                const distance = L.latLng(property.lat, property.lng).distanceTo([h.lat, h.long]) / 1000;
                if (distance <= 2) {
                    this.nearbyHospitals.push({ ...h, distance });
                    const marker = L.marker([h.lat, h.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: `<div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(this.map);
                    marker.bindTooltip(`${h.facility_name}<br>${distance.toFixed(1)}km`, { direction: 'top', offset: [0, -10] });
                    this.hospitalMarkers.push(marker);
                }
            });
            this.schools.forEach(s => {
                const distance = L.latLng(property.lat, property.lng).distanceTo([s.lat, s.lng]) / 1000;
                if (distance <= 1.5) {
                    this.nearbySchools.push({ ...s, distance });
                    const marker = L.marker([s.lat, s.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: `<div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(this.map);
                    marker.bindTooltip(`${s.school_name}<br>${distance.toFixed(1)}km`, { direction: 'top', offset: [0, -10] });
                    this.schoolMarkers.push(marker);
                }
            });
            this.displayPropertyDetails(property);
        }
        clearMarkers() {
            this.hospitalMarkers.forEach(m => this.map.removeLayer(m));
            this.schoolMarkers.forEach(m => this.map.removeLayer(m));
            this.hospitalMarkers = [];
            this.schoolMarkers = [];
        }
        displayPropertyDetails(property) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="location-info">
                    <strong>${this.sanitizeHTML(property.name)}</strong><br>
                    Type: ${this.sanitizeHTML(property.type)}<br>
                    Price: ${this.sanitizeHTML(property.price)}<br>
                    ${property.bedrooms ? `Details: ${property.bedrooms}BR • ${property.bathrooms}BA • ${this.sanitizeHTML(property.area)}<br>` : `Area: ${this.sanitizeHTML(property.area)}<br>`}
                    District: ${this.sanitizeHTML(property.district)}
                </div>`;
            if (this.nearbySchools.length > 0) {
                let schoolHtml = `
                    <div class="school-proximity">
                        <strong>Nearby Schools</strong><br>
                        <small>${this.nearbySchools.length} within 1.5km</small>
                        <div class="facility-list">`;
                this.nearbySchools.slice(0, 3).forEach(s => {
                    schoolHtml += `
                        <div class="facility-item school-item" onclick="spatialSystem.focusLocation(${s.lat}, ${s.lng})">
                            <div class="facility-name">${this.sanitizeHTML(s.school_name)}</div>
                            <div class="facility-distance">${(s.distance * 1000).toFixed(0)}m</div>
                        </div>`;
                });
                schoolHtml += `</div></div>`;
                messagesContainer.innerHTML += schoolHtml;
            } else {
                messagesContainer.innerHTML += `
                    <div class="school-proximity">
                        <strong>No Schools Nearby</strong><br>
                        No schools within 1.5km.
                    </div>`;
            }
            if (this.nearbyHospitals.length > 0) {
                let hospitalHtml = `
                    <div class="proximity-analysis">
                        <strong>Nearby Healthcare</strong><br>
                        <small>${this.nearbyHospitals.length} within 2km</small>
                        <div class="facility-list">`;
                this.nearbyHospitals.slice(0, 3).forEach(h => {
                    hospitalHtml += `
                        <div class="facility-item hospital-item" onclick="spatialSystem.focusLocation(${h.lat}, ${h.long})">
                            <div class="facility-name">${this.sanitizeHTML(h.facility_name)}</div>
                            <div class="facility-distance">${h.distance.toFixed(1)}km</div>
                        </div>`;
                });
                hospitalHtml += `</div></div>`;
                messagesContainer.innerHTML += hospitalHtml;
            } else {
                messagesContainer.innerHTML += `
                    <div class="proximity-analysis">
                        <strong>No Healthcare Nearby</strong><br>
                        No hospitals within 2km.
                    </div>`;
            }
            this.scrollToBottom();
        }
        focusLocation(lat, lng) {
            this.map.setView([lat, lng], 16);
        }
        scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        sanitizeHTML(str) {
            return String(str).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[m]);
        }
        applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            this.filteredProperties = this.properties.filter(p => {
                if (statusFilter && p.status !== statusFilter) return false;
                if (priceFilter) {
                    const price = parseInt(p.price.replace(/[^0-9]/g, '')) || 0;
                    if (priceFilter === '0-50' && price >= 50) return false;
                    if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                    if (priceFilter === '100+' && price < 100) return false;
                }
                return true;
            });
            this.markerCluster.clearLayers();
            this.filteredProperties.forEach(p => {
                if (!p.lat || !p.lng) {
                    console.warn(`Invalid coordinates for filtered property: ${p.name}`);
                    return;
                }
                const marker = L.marker([p.lat, p.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${p.status}`,
                        html: `<div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                });
                marker.bindTooltip(`
                    <strong>${this.sanitizeHTML(p.name)}</strong><br>
                    Type: ${this.sanitizeHTML(p.type)}<br>
                    Price: ${this.sanitizeHTML(p.price)}<br>
                    ${p.bedrooms ? `${p.bedrooms}BR • ${p.bathrooms}BA` : ''}
                `, { direction: 'top', offset: [0, -10] });
                marker.on('click', () => this.selectProperty(p, marker));
                this.markerCluster.addLayer(marker);
            });
            this.map.addLayer(this.markerCluster);
            this.updateFilterSummary();
            this.map.invalidateSize();
        }
        updateFilterSummary() {
            const filterSummary = document.getElementById('filterSummary');
            filterSummary.textContent = `Showing ${this.filteredProperties.length} of ${this.properties.length} properties`;
        }
        setupEventListeners() {
            const locationSearch = document.getElementById('locationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const statusFilter = document.getElementById('statusFilter');
            const priceFilter = document.getElementById('priceFilter');
            locationSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') this.performLocationSearch();
            });
            searchBtn.addEventListener('click', () => this.performLocationSearch());
            statusFilter.addEventListener('change', () => this.applyFilters());
            priceFilter.addEventListener('change', () => this.applyFilters());
        }
        async performLocationSearch() {
            const location = document.getElementById('locationSearch').value.trim();
            if (!location) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                const results = await response.json();
                if (results.length > 0) {
                    this.map.setView([results[0].lat, results[0].lon], 15);
                } else {
                    alert('Location not found in Kigali');
                }
            } catch (error) {
                alert('Search failed. Please try again.');
            }
        }
        useCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation not supported');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => this.map.setView([pos.coords.latitude, pos.coords.longitude], 15),
                () => alert('Unable to get location')
            );
        }
    }
    function toggleChat() {
        const chatContainer = document.getElementById('chatContainer');
        const toggleIcon = document.getElementById('toggleIcon');
        chatContainer.classList.toggle('collapsed');
        toggleIcon.className = chatContainer.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
        spatialSystem.map.invalidateSize();
    }
    function toggleFullscreen() {
        const mapContainer = document.querySelector('.map-container');
        const icon = document.getElementById('fullscreenIcon');
        mapContainer.classList.toggle('fullscreen');
        icon.className = mapContainer.classList.contains('fullscreen') ? 'fas fa-compress' : 'fas fa-expand';
        spatialSystem.map.invalidateSize();
    }
    function locateMe() {
        spatialSystem.useCurrentLocation();
    }
    function analyzeEducation() {
        if (!spatialSystem.currentProperty) {
            alert('Please select a property first');
            return;
        }
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div class="message ai">
                <div class="message-content">
                    <strong>Nearby Schools</strong><br>
                    ${spatialSystem.nearbySchools.length > 0 ? 
                        `${spatialSystem.nearbySchools.length} schools within 1.5km:<br><br>` + 
                        spatialSystem.nearbySchools.slice(0, 3).map(s => 
                            `<div class="facility-item school-item" onclick="spatialSystem.focusLocation(${s.lat}, ${s.lng})">
                                <div class="facility-name">${spatialSystem.sanitizeHTML(s.school_name)}</div>
                                <div class="facility-distance">${(s.distance * 1000).toFixed(0)}m</div>
                            </div>`
                        ).join('') : 
                        'No schools within 1.5km.'}
                </div>
            </div>`;
        spatialSystem.scrollToBottom();
    }
    function analyzeHealthcare() {
        if (!spatialSystem.currentProperty) {
            alert('Please select a property first');
            return;
        }
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div class="message ai">
                <div class="message-content">
                    <strong>Nearby Healthcare</strong><br>
                    ${spatialSystem.nearbyHospitals.length > 0 ? 
                        `${spatialSystem.nearbyHospitals.length} facilities within 2km:<br><br>` + 
                        spatialSystem.nearbyHospitals.slice(0, 3).map(h => 
                            `<div class="facility-item hospital-item" onclick="spatialSystem.focusLocation(${h.lat}, ${h.long})">
                                <div class="facility-name">${spatialSystem.sanitizeHTML(h.facility_name)}</div>
                                <div class="facility-distance">${h.distance.toFixed(1)}km</div>
                            </div>`
                        ).join('') : 
                        'No hospitals within 2km.'}
                </div>
            </div>`;
        spatialSystem.scrollToBottom();
    }
    let spatialSystem = null;
    window.addEventListener('DOMContentLoaded', () => {
        spatialSystem = new SpatialIntelligenceSystem();
    });
</script>
