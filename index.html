
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Location Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --education: #8b5cf6;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-light: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        .chat-container {
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-light);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }
        
        .chat-container.collapsed {
            width: 60px;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        .app-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-bottom: 1px solid var(--glass-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .toggle-chat-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-chat-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }
        
        .filter-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-light);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        
        .filter-select option {
            background: var(--dark);
            color: #fff;
        }
        
        .filter-summary {
            margin-top: 8px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(15, 23, 42, 0.4);
            min-height: 150px;
            max-height: calc(100vh - 300px);
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px 16px 16px 4px;
            padding: 16px 18px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px 16px 4px 16px;
            padding: 16px 18px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 85%;
        }
        
        .chat-input-container {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--glass-light);
        }
        
        .chat-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .map-search-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
            min-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .location-btn, .home-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .location-btn:hover, .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .data-panels {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .data-panel {
            background: var(--glass);
            border: 1px solid var(--glass-light);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            min-width: 140px;
            max-width: 200px;
        }
        
        .panel-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .panel-subtitle {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .panel-breakdown {
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        .breakdown-sale {
            color: var(--danger);
            font-weight: 600;
        }
        
        .breakdown-rent {
            color: var(--success);
            font-weight: 600;
        }
        
        .breakdown-type {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .properties-panel .panel-title {
            color: var(--primary);
        }
        
        .property-marker {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
            opacity: 0.85;
            width: 60px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        .property-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            opacity: 1;
            z-index: 1000;
        }
        
        .property-marker.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            opacity: 1;
            z-index: 1001;
        }
        
        .property-marker.sale {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .property-marker.sale.selected {
            background: var(--danger);
            color: white;
        }
        
        .property-marker.sale::after {
            content: 'SALE';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.rent {
            border-color: var(--success);
            color: var(--success);
        }
        
        .property-marker.rent.selected {
            background: var(--success);
            color: white;
        }
        
        .property-marker.rent::after {
            content: 'RENT';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--success);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.luxury {
            border-color: var(--warning);
            color: var(--warning);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            background: linear-gradient(135deg, #fff, #fffbeb);
        }
        
        .property-marker.luxury.selected {
            background: var(--warning);
            color: white;
        }
        
        .property-marker.luxury::before {
            content: '‚≠ê';
            position: absolute;
            top: -6px;
            left: -6px;
            background: var(--warning);
            color: white;
            font-size: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .school-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--education);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .school-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        .hospital-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--success);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        <style>
        .hospital-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }
        
        .property-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .proximity-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--success);
        }
        
        .education-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(124, 58, 237, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--education);
        }
        
        .facility-list {
            margin-top: 12px;
        }
        
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .facility-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        .facility-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .facility-distance {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .leaflet-tooltip.compact-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 6px !important;
            color: #ffffff !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            padding: 6px 8px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            max-width: 200px !important;
        }
        
        .leaflet-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-container {
                width: 100%;
                height: 45vh;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--glass-light);
            }
            
            .chat-container.collapsed {
                height: 60px;
            }
            
            .map-container {
                height: 55vh;
                order: 1;
            }
            
            .data-panels {
                flex-direction: column;
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }
            
            .data-panel {
                padding: 10px 12px;
                min-width: 120px;
                max-width: 160px;
            }
            
            .map-search-controls {
                top: 10px;
                right: 10px;
                left: unset;
                flex-direction: column;
                gap: 8px;
            }
            
            .search-box {
                min-width: unset;
            }
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .welcome-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 20px;
            color: var(--primary);
            font-style: italic;
            font-size: 0.85rem;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI analyzing'; }
            40% { content: 'AI analyzing.'; }
            60% { content: 'AI analyzing..'; }
            80%, 100% { content: 'AI analyzing...'; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container" id="chatContainer">
            <div class="app-header">
                <div class="app-title">PropertyIntel Kigali</div>
                <button class="toggle-chat-btn" onclick="toggleChat()" aria-label="Toggle chat">
                    <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </button>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Property Filters
                </div>
                <div class="filter-grid">
                    <select id="statusFilter" class="filter-select" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                        <option value="plot">Plot</option>
                    </select>
                    
                    <select id="priceFilter" class="filter-select" aria-label="Filter by price">
                        <option value="">All Prices</option>
                        <option value="0-50">Under 50M RWF</option>
                        <option value="50-100">50M - 100M RWF</option>
                        <option value="100-200">100M - 200M RWF</option>
                        <option value="200+">Above 200M RWF</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-title">Welcome to PropertyIntel!</div>
                        Your AI-powered real estate assistant for Kigali. Ask me about market trends, investment opportunities, or specific properties!
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask about Kigali real estate market, investment tips, or specific properties..." 
                              rows="1" aria-label="Ask about property"></textarea>
                    <button class="send-btn" id="sendBtn" aria-label="Send message">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div class="map-search-controls">
                <div class="search-box">
                    <input type="text" id="locationSearch" class="search-input" 
                           placeholder="Search location in Kigali..." aria-label="Search location">
                    <button id="searchBtn" class="search-btn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button id="locationBtn" class="location-btn" aria-label="Use current location">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button id="homeBtn" class="home-btn" aria-label="Reset to home view">
                    <i class="fas fa-home"></i>
                </button>
            </div>
            
            <div class="data-panels">
                <div class="data-panel properties-panel">
                    <div class="panel-title">
                        <i class="fas fa-home"></i> Property Listings
                    </div>
                    <div class="panel-value" id="propertiesCount">20</div>
                    <div class="panel-subtitle">Available listings</div>
                    <div class="panel-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-sale">For Sale:</span>
                            <span id="forSaleCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-rent">For Rent:</span>
                            <span id="forRentCount">0</span>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0; padding-top: 4px;">
                            <div class="breakdown-item">
                                <span class="breakdown-type">Apartments:</span>
                                <span id="apartmentCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Houses:</span>
                                <span id="houseCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Villas:</span>
                                <span id="villaCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Luxury:</span>
                                <span id="luxuryCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Plots:</span>
                                <span id="plotCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class PropertyIntelSystem {
            constructor() {
                this.map = null;
                this.currentProperty = null;
                this.selectedMarker = null;
                this.facilities = [];
                this.schools = [];
                this.propertyMarkers = [];
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.nearbyHospitals = [];
                this.nearbySchools = [];
                this.filteredProperties = [];
                this.isSending = false;
                this.chatHistory = [];
                
                // Expanded dataset with plots and affordable properties
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m¬≤', yearBuilt: 2022, district: 'Nyarugenge', amenities: ['Pool', 'Gym', 'Security', 'Parking'] },
                    { id: 2, lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m¬≤', yearBuilt: 2019, district: 'Nyarugenge', amenities: ['Security', 'Parking'] },
                    { id: 3, lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Garden', 'Pool', 'Security', 'Garage'] },
                    { id: 4, lat: -1.9356, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 5, lat: -1.9416, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security', 'Balcony'] },
                    { id: 6, lat: -1.9634, lng: 30.0929, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m¬≤', yearBuilt: 2017, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 7, lat: -1.9604, lng: 30.0959, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Pool', 'Garden', 'Security', 'Smart Home'] },
                    { id: 8, lat: -1.9564, lng: 30.0899, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['River View', 'Security'] },
                    { id: 9, lat: -1.9456, lng: 30.1212, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Parking', 'Security'] },
                    { id: 10, lat: -1.9486, lng: 30.1242, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Gym', 'Security', 'Parking'] },
                    { id: 11, lat: -1.9756, lng: 30.0729, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m¬≤', yearBuilt: 2019, district: 'Kicukiro', amenities: ['Garden', 'Security', 'Workshop'] },
                    { id: 12, lat: -1.9686, lng: 30.0759, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m¬≤', yearBuilt: 2016, district: 'Kicukiro', amenities: ['Parking'] },
                    { id: 13, lat: -1.9606, lng: 30.0529, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m¬≤', yearBuilt: 2018, district: 'Nyarugenge', amenities: ['Garden', 'Traditional Design'] },
                    { id: 14, lat: -1.9536, lng: 30.0499, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m¬≤', yearBuilt: 2017, district: 'Nyarugenge', amenities: ['Garden', 'Cultural Features'] },
                    { id: 15, lat: -1.9256, lng: 30.0919, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m¬≤', yearBuilt: 2024, district: 'Gasabo', amenities: ['Pool', 'Gym', 'Cinema', 'Smart Home', 'Wine Cellar'] },
                    { id: 16, lat: -1.9186, lng: 30.0889, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m¬≤', yearBuilt: 2022, district: 'Gasabo', amenities: ['View', 'Security', 'Garden'] },
                    { id: 17, lat: -1.9706, lng: 30.1059, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Study Area', 'Internet'] },
                    { id: 18, lat: -1.9636, lng: 30.1029, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 19, lat: -1.9356, lng: 30.1112, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Golf Access', 'Pool', 'Tennis Court', 'Spa'] },
                    { id: 20, lat: -1.9286, lng: 30.1082, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Golf View', 'Security', 'Gym'] },
                    { id: 21, lat: -1.9706, lng: 30.0929, name: 'Kicukiro Modern Plot', type: 'Plot', price: '40M RWF', status: 'sale', area: '600m¬≤', district: 'Kicukiro', amenities: ['Utilities Ready'] },
                    { id: 22, lat: -1.9506, lng: 30.1262, name: 'Remera Residential Plot', type: 'Plot', price: '45M RWF', status: 'sale', area: '550m¬≤', district: 'Gasabo', amenities: ['Utilities Ready'] },
                    { id: 23, lat: -1.9624, lng: 30.0879, name: 'Kacyiru New Plot', type: 'Plot', price: '42M RWF', status: 'sale', area: '520m¬≤', district: 'Gasabo', amenities: ['Utilities Ready'] },
                    { id: 24, lat: -1.9406, lng: 30.0809, name: 'Gisozi Affordable Apartment', type: 'Apartment', price: '30M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '80m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security', 'Parking'] },
                    { id: 25, lat: -1.9654, lng: 30.0949, name: 'Kicukiro Budget Plot', type: 'Plot', price: '38M RWF', status: 'sale', area: '500m¬≤', district: 'Kicukiro', amenities: ['Utilities Ready'] },
                    { id: 26, lat: -1.9476, lng: 30.1152, name: 'Remera Compact Apartment', type: 'Apartment', price: '28M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '70m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Security', 'Balcony'] }
                ];
                
                this.init();
            }
            
            async init() {
                await this.loadFacilities();
                await this.loadSchools();
                await this.fetchRealTimeData();
                this.initializeMap();
                this.setupEventListeners();
                this.updateStats();
            }
            
            async loadFacilities() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.facilities = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.lat && 
                            feature.attributes.long
                        ).map(feature => ({
                            facility_name: feature.attributes.facility_name || 'Unknown',
                            facility_type: feature.attributes.facility_type || 'Unknown',
                            lat: feature.attributes.lat,
                            long: feature.attributes.long,
                            district: feature.attributes.district || 'N/A',
                            sector: feature.attributes.sector || 'N/A',
                            ownership: feature.attributes.ownership || 'N/A'
                        }));
                        console.log('Loaded health facilities:', this.facilities.length);
                    }
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                    this.facilities = [
                        { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo" },
                        { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge" },
                        { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro" }
                    ];
                }
            }
            
            async loadSchools() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.schools = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.latitude && 
                            feature.attributes.longitude
                        ).map(feature => ({
                            school_name: feature.attributes.school_nam || 'Unknown School',
                            school_type: feature.attributes.school_typ || 'Unknown',
                            school_category: feature.attributes.school_cat || 'PRE_PRIMARY',
                            school_status: feature.attributes.school_sta || 'Unknown',
                            curriculum: feature.attributes.curriculum || 'National',
                            lat: feature.attributes.latitude,
                            lng: feature.attributes.longitude,
                            established: feature.attributes.establishm || 'N/A'
                        }));
                        console.log('Loaded schools:', this.schools.length);
                    }
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    this.schools = [
                        { school_name: "ITETERO NURSERY SCHOOL", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9489, lng: 30.0000, established: 2009 },
                        { school_name: "Green Hills Academy", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "INTERNATIONAL", lat: -1.9556, lng: 30.1044, established: 2006 },
                        { school_name: "Kigali Parents School", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9386, lng: 30.0619, established: 2010 }
                    ];
                }
            }
            
            async fetchRealTimeData() {
                try {
                    const mockApiResponse = [
                        { id: 27, lat: -1.9686, lng: 30.0989, name: 'Kicukiro Expansion Plot', type: 'Plot', price: '35M RWF', status: 'sale', area: '480m¬≤', district: 'Kicukiro', amenities: ['Utilities Ready'] },
                        { id: 28, lat: -1.9466, lng: 30.1122, name: 'Remera Budget Apartment', type: 'Apartment', price: '25M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '60m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security'] }
                    ];
                    this.properties = [...this.properties, ...mockApiResponse];
                    console.log('Fetched real-time properties:', mockApiResponse.length);
                } catch (error) {
                    console.error('Failed to fetch real-time data:', error);
                }
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
                
                this.addProperties();
                this.prepareHospitals();
                this.prepareSchools();
                
                this.map.on('click', this.handleMapClick.bind(this));
                
                new ResizeObserver(() => this.map.invalidateSize()).observe(document.getElementById('map'));
            }
            
            addProperties() {
                this.propertyMarkers = [];
                this.filteredProperties = [...this.properties];
                
                this.properties.forEach((prop) => {
                    const isLuxury = prop.type.toLowerCase().includes('luxury');
                    const markerClass = `property-marker ${prop.status} ${isLuxury ? 'luxury' : ''}`;
                    
                    const priceLabel = prop.price.replace(' RWF', '').replace('M', '');
                    
                    const marker = L.marker([prop.lat, prop.lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: priceLabel,
                            iconSize: [60, 24],
                            iconAnchor: [30, 24],
                            popupAnchor: [0, -24]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">${prop.name}</div>
                        <div style="margin-bottom: 2px; font-size: 12px;">üìç ${prop.district} ${prop.bedrooms ? '‚Ä¢ ' + prop.bedrooms + 'BR' : ''}</div>
                        <div style="font-weight: 600; color: #6366f1; font-size: 13px;">üí∞ ${prop.price}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -24],
                        permanent: false,
                        sticky: false,
                        className: 'compact-tooltip'
                    });
                    
                    marker.on('click', () => this.selectProperty(prop, marker));
                    marker.addTo(this.map);
                    
                    this.propertyMarkers.push({
                        marker: marker,
                        property: prop,
                        visible: true
                    });
                });
                
                this.updateFilterSummary();
            }
            
            prepareHospitals() {
                this.hospitalMarkers = [];
                this.facilities.forEach(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: 'üè•',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üè• ${facility.facility_name}</div>
                        <div style="margin-bottom: 2px;">üìã ${facility.facility_type}</div>
                        <div>üìç ${facility.district}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.hospitalMarkers.push(marker);
                });
            }
            
            prepareSchools() {
                this.schoolMarkers = [];
                this.schools.forEach(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: 'üéì',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üéì ${school.school_name}</div>
                        <div style="margin-bottom: 2px;">üìö ${school.school_status} School</div>
                        <div style="margin-bottom: 2px;">üìñ ${school.curriculum} Curriculum</div>
                        <div>üìÖ Est. ${school.established}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.schoolMarkers.push(marker);
                });
            }
            
            selectProperty(property, marker) {
                if (this.selectedMarker) {
                    const prevElement = this.selectedMarker.getElement();
                    if (prevElement) {
                        prevElement.classList.remove('selected');
                    }
                }
                
                this.currentProperty = property;
                this.selectedMarker = marker;
                
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
                
                document.getElementById('chatInput').placeholder = `Ask about ${property.name}...`;
                
                this.analyzeProperty(property);
                this.map.setView([property.lat, property.lng], 15);
            }
            
            analyzeProperty(property) {
                this.clearNearbyMarkers();
                this.analyzeProximity(property);
                this.displayPropertyAnalysis(property);
                this.showNearbyFacilities(property);
            }
            
            clearNearbyMarkers() {
                this.hospitalMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                
                this.schoolMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
            }
            
            showNearbyFacilities(property) {
                this.nearbyHospitals.forEach(hospital => {
                    const marker = this.hospitalMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - hospital.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - hospital.long) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
                
                this.nearbySchools.forEach(school => {
                    const marker = this.schoolMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - school.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - school.lng) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
            }
            
            analyzeProximity(property, params = {}) {
                this.nearbyHospitals = [];
                this.facilities.forEach(facility => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= (params.hospitalDistance || 3)) {
                        this.nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                    }
                });
                this.nearbyHospitals.sort((a, b) => a.distance - b.distance);
                
                this.nearbySchools = [];
                this.schools.forEach(school => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([school.lat, school.lng]) / 1000;
                    
                    if (distance <= (params.schoolDistance || 2)) {
                        this.nearbySchools.push({
                            ...school,
                            distance: distance
                        });
                    }
                });
                this.nearbySchools.sort((a, b) => a.distance - b.distance);
            }
            
            displayPropertyAnalysis(property) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                let propertyHtml = `
                    <div class="property-info">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">${property.name}</h3>
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> ${property.type}</div>
                        <div style="margin-bottom: 6px;"><strong>Price:</strong> ${property.price}</div>
                        <div style="margin-bottom: 6px;"><strong>Size:</strong> ${property.bedrooms ? property.bedrooms + 'BR ‚Ä¢ ' + property.bathrooms + 'BA ‚Ä¢ ' : ''}${property.area}</div>
                        <div style="margin-bottom: 6px;"><strong>Built:</strong> ${property.yearBuilt || 'N/A'}</div>
                        <div style="margin-bottom: 6px;"><strong>District:</strong> ${property.district}</div>
                        <div><strong>Amenities:</strong> ${property.amenities ? property.amenities.join(', ') : 'Standard'}</div>
                    </div>`;
                
                messagesContainer.innerHTML += propertyHtml;
                
                if (this.nearbySchools.length > 0) {
                    let schoolHtml = `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">üéì Education Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbySchools.length} schools within 2km</p>
                            <div class="facility-list">`;
                    
                    this.nearbySchools.slice(0, 5).forEach(school => {
                        schoolHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${school.lat}, ${school.lng})">
                                <div class="facility-name">${school.school_name}</div>
                                <div class="facility-distance">${(school.distance * 1000).toFixed(0)}m</div>
                            </div>`;
                    });
                    
                    schoolHtml += `</div></div>`;
                    messagesContainer.innerHTML += schoolHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Education Access</h4>
                            <p>No schools within 2km walking distance. Consider transportation needs for school-age children.</p>
                        </div>`;
                }
                
                if (this.nearbyHospitals.length > 0) {
                    let hospitalHtml = `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">üè• Healthcare Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbyHospitals.length} health facilities within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbyHospitals.slice(0, 5).forEach(hospital => {
                        hospitalHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${hospital.lat}, ${hospital.long})">
                                <div class="facility-name">${hospital.facility_name}</div>
                                <div class="facility-distance">${hospital.distance.toFixed(1)}km</div>
                            </div>`;
                    });
                    
                    hospitalHtml += `</div></div>`;
                    messagesContainer.innerHTML += hospitalHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Healthcare Access</h4>
                            <p>No hospitals within 3km radius. Emergency services may take longer to reach this location.</p>
                        </div>`;
                }
                
                this.scrollToBottom();
            }
            
            focusLocation(lat, lng) {
                this.map.setView([lat, lng], 16);
            }
            
            resetToHomeView() {
                this.map.setView([-1.9441, 30.0619], 11);
            }
            
            handleMapClick(e) {
                this.clearNearbyMarkers();
                
                if (!this.currentProperty) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-title">Welcome to PropertyIntel!</div>
                            Your AI-powered real estate assistant for Kigali. Ask me about market trends, investment opportunities, or specific properties!
                        </div>`;
                }
            }
            
            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const locationSearch = document.getElementById('locationSearch');
                const searchBtn = document.getElementById('searchBtn');
                const locationBtn = document.getElementById('locationBtn');
                const homeBtn = document.getElementById('homeBtn');
                const statusFilter = document.getElementById('statusFilter');
                const typeFilter = document.getElementById('typeFilter');
                const priceFilter = document.getElementById('priceFilter');
                
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                
                locationSearch.addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.performLocationSearch();
                });
                
                searchBtn.addEventListener('click', () => this.performLocationSearch());
                locationBtn.addEventListener('click', () => this.useCurrentLocation());
                homeBtn.addEventListener('click', () => this.resetToHomeView());
                
                statusFilter.addEventListener('change', () => this.applyFilters());
                typeFilter.addEventListener('change', () => this.applyFilters());
                priceFilter.addEventListener('change', () => this.applyFilters());
            }
            
            async performLocationSearch() {
                const locationSearch = document.getElementById('locationSearch');
                const location = locationSearch.value.trim();
                if (!location) return;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const { lat, lon } = results[0];
                        this.map.setView([lat, lon], 16);
                    } else {
                        alert('Location not found in Kigali');
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    alert('Search failed. Please try again.');
                }
            }
            
            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported by this browser');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        this.map.setView([lat, lng], 15);
                    },
                    error => {
                        alert('Unable to get your location');
                    }
                );
            }
            
            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priceFilter = document.getElementById('priceFilter').value;
                
                this.filteredProperties = this.properties.filter(property => {
                    if (statusFilter && property.status !== statusFilter) return false;
                    
                    if (typeFilter) {
                        const propType = property.type.toLowerCase();
                        if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                        if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                        if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                        if (typeFilter === 'house' && !propType.includes('house')) return false;
                        if (typeFilter === 'plot' && !propType.includes('plot')) return false;
                    }
                    
                    if (priceFilter) {
                        const price = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('M') ? 1000000 : 1000);
                        if (priceFilter === '0-50' && price >= 50 * 1000000) return false;
                        if (priceFilter === '50-100' && (price < 50 * 1000000 || price >= 100 * 1000000)) return false;
                        if (priceFilter === '100-200' && (price < 100 * 1000000 || price >= 200 * 1000000)) return false;
                        if (priceFilter === '200+' && price < 200 * 1000000) return false;
                    }
                    
                    return true;
                });
                
                this.updatePropertyVisibility();
                this.updateFilterSummary();
                this.updateStats();
            }
            
            updatePropertyVisibility() {
                this.propertyMarkers.forEach(item => {
                    const isVisible = this.filteredProperties.includes(item.property);
                    if (isVisible && !item.visible) {
                        item.marker.addTo(this.map);
                        item.visible = true;
                    } else if (!isVisible && item.visible) {
                        this.map.removeLayer(item.marker);
                        item.visible = false;
                    }
                });
            }
            
            updateFilterSummary() {
                const filterSummary = document.getElementById('filterSummary');
                const total = this.properties.length;
                const shown = this.filteredProperties.length;
                
                filterSummary.textContent = shown === total ? 
                    `Showing all ${total} properties` : 
                    `Showing ${shown} of ${total} properties`;
            }
            
            updateStats() {
                const forSale = this.filteredProperties.filter(p => p.status === 'sale').length;
                const forRent = this.filteredProperties.filter(p => p.status === 'rent').length;
                
                const apartments = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('apartment')).length;
                const houses = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('house')).length;
                const villas = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('villa') && !p.type.toLowerCase().includes('luxury')).length;
                const luxury = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('luxury')).length;
                const plots = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('plot')).length;
                
                document.getElementById('propertiesCount').textContent = this.filteredProperties.length;
                document.getElementById('forSaleCount').textContent = forSale;
                document.getElementById('forRentCount').textContent = forRent;
                document.getElementById('apartmentCount').textContent = apartments;
                document.getElementById('houseCount').textContent = houses;
                document.getElementById('villaCount').textContent = villas;
                document.getElementById('luxuryCount').textContent = luxury;
                document.getElementById('plotCount').textContent = plots;
            }
            
            async sendMessage() {
                if (this.isSending) return;
                this.isSending = true;
                
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message) {
                    this.isSending = false;
                    return;
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                this.showTyping();
                this.chatHistory.push({ role: 'user', content: message });
                
                setTimeout(() => {
                    this.hideTyping();
                    const response = this.processQuery(message);
                    messagesContainer.innerHTML += `
                        <div class="message ai">
                            <div class="message-content">${response}</div>
                        </div>`;
                    this.isSending = false;
                    this.scrollToBottom();
                }, 1500);
                
                this.scrollToBottom();
            }
            
            processQuery(query) {
                const lowerQuery = query.toLowerCase();
                const params = {};
                
                // Parse query for filters
                if (lowerQuery.includes('residential')) params.types = ['Apartment', 'House', 'Villa', 'Luxury Apartment', 'Luxury Villa'];
                if (lowerQuery.includes('plot')) params.types = ['Plot'];
                if (lowerQuery.includes('sale')) params.status = 'sale';
                if (lowerQuery.includes('rent')) params.status = 'rent';
                if (lowerQuery.includes('nyarugenge')) params.district = 'Nyarugenge';
                if (lowerQuery.includes('gasabo')) params.district = 'Gasabo';
                if (lowerQuery.includes('kicukiro')) params.district = 'Kicukiro';
                if (lowerQuery.includes('remera')) params.district = 'Gasabo';
                if (lowerQuery.includes('kimihurura')) params.district = 'Gasabo';
                if (lowerQuery.includes('nyarutarama')) params.district = 'Gasabo';
                
                // Parse price constraints
                const priceMatch = lowerQuery.match(/(under|below|less than)\s*(\d+)\s*(m|million)/i);
                if (priceMatch) params.maxPrice = parseFloat(priceMatch[2]) * 1000000;
                
                // Parse area constraints
                const areaMatch = lowerQuery.match(/(\d+)\s*(m¬≤|square meters)/i);
                if (areaMatch) params.minArea = parseFloat(areaMatch[1]);
                
                // Parse proximity constraints
                const schoolDistanceMatch = lowerQuery.match(/schools?\s*within\s*(\d+)\s*(m|km|meters|kilometers)/i);
                if (schoolDistanceMatch) {
                    params.schoolDistance = schoolDistanceMatch[2].startsWith('k') ? parseFloat(schoolDistanceMatch[1]) : parseFloat(schoolDistanceMatch[1]) / 1000;
                    params.minSchools = lowerQuery.includes('multiple') || lowerQuery.includes('several') ? 2 : 1;
                }
                
                const hospitalDistanceMatch = lowerQuery.match(/hospitals?\s*within\s*(\d+)\s*(m|km|meters|kilometers)/i);
                if (hospitalDistanceMatch) {
                    params.hospitalDistance = hospitalDistanceMatch[2].startsWith('k') ? parseFloat(hospitalDistanceMatch[1]) : parseFloat(hospitalDistanceMatch[1]) / 1000;
                    params.minHospitals = lowerQuery.includes('multiple') || lowerQuery.includes('several') ? 2 : 1;
                }
                
                // Handle equidistant queries
                if (lowerQuery.includes('equidistant')) {
                    params.equidistant = true;
                }
                
                // Handle general analysis queries
                if (lowerQuery.includes('market') || lowerQuery.includes('trend')) {
                    return this.generateMarketAnalysis();
                } else if (lowerQuery.includes('investment') || lowerQuery.includes('roi') || lowerQuery.includes('return')) {
                    return this.generateInvestmentAdvice();
                } else if (lowerQuery.includes('district') || lowerQuery.includes('area') || lowerQuery.includes('neighborhood')) {
                    return this.generateDistrictAnalysis();
                } else if (lowerQuery.includes('luxury') || lowerQuery.includes('premium')) {
                    return this.generateLuxuryMarketInsight();
                } else if (lowerQuery.includes('rental') || lowerQuery.includes('rent')) {
                    return this.generateRentalMarketAnalysis();
                } else if (lowerQuery.includes('price') || lowerQuery.includes('cost') || lowerQuery.includes('value')) {
                    return this.currentProperty ? this.generatePriceResponse(this.currentProperty) : this.generatePricingInsights();
                } else if (lowerQuery.includes('school') || lowerQuery.includes('education')) {
                    return this.currentProperty ? this.generateSchoolResponse(this.currentProperty) : this.generateEducationInsights();
                } else if (lowerQuery.includes('hospital') || lowerQuery.includes('health') || lowerQuery.includes('medical')) {
                    return this.currentProperty ? this.generateHealthResponse(this.currentProperty) : this.generateHealthcareInsights();
                } else if (lowerQuery.includes('family') || lowerQuery.includes('children')) {
                    return this.currentProperty ? this.generateFamilyResponse(this.currentProperty) : this.generateFamilyLivingInsights();
                } else if (lowerQuery.includes('developer') || lowerQuery.includes('construction')) {
                    return this.generateDevelopmentInsights();
                } else if (lowerQuery.includes('infrastructure') || lowerQuery.includes('transport')) {
                    return this.generateInfrastructureInsights();
                }
                
                // Filter properties based on parsed parameters
                const results = this.filterProperties(params);
                
                if (results.length === 0) {
                    return `No properties match your criteria. Try relaxing filters or check listings on ewawe.com or kigaliproperties.online.`;
                }
                
                let response = `<h4>üîç Property Search Results</h4><br>Found <strong>${results.length} properties</strong> matching your criteria:<br><br>`;
                
                results.forEach(property => {
                    this.analyzeProximity(property, params);
                    response += `<strong>${property.name}</strong> (${property.district})<br>`;
                    response += `‚Ä¢ Type: ${property.type}<br>`;
                    response += `‚Ä¢ Price: ${property.price}<br>`;
                    response += `‚Ä¢ Size: ${property.bedrooms ? property.bedrooms + 'BR ‚Ä¢ ' + property.bathrooms + 'BA ‚Ä¢ ' : ''}${property.area}<br>`;
                    if (this.nearbySchools.length > 0) {
                        response += `‚Ä¢ Schools: ${this.nearbySchools.slice(0, 2).map(s => `${s.school_name} (~${(s.distance * 1000).toFixed(0)}m)`).join(', ')}<br>`;
                    }
                    if (this.nearbyHospitals.length > 0) {
                        response += `‚Ä¢ Hospitals: ${this.nearbyHospitals.slice(0, 2).map(h => `${h.facility_name} (~${h.distance.toFixed(1)}km)`).join(', ')}<br>`;
                    }
                    response += `‚Ä¢ Coordinates: (${property.lat}, ${property.lng})<br><br>`;
                });
                
                response += `Click a property marker on the map for detailed analysis or refine your search.`;
                
                this.filteredProperties = results;
                this.updatePropertyVisibility();
                if (results.length > 0) {
                    this.map.setView([results[0].lat, results[0].lng], 15);
                }
                
                return response;
            }
            
            filterProperties(params) {
                const lowerQuery = this.chatHistory.length > 0 ? this.chatHistory[this.chatHistory.length - 1].content.toLowerCase() : '';
                
                return this.properties
                    .map(property => {
                        let score = 0;
                        let matchesCriteria = true;

                        // Type filter
                        if (params.types && !params.types.includes(property.type)) {
                            matchesCriteria = false;
                        }

                        // Status filter
                        if (params.status && property.status !== params.status) {
                            matchesCriteria = false;
                        }

                        // District filter
                        if (params.district && property.district !== params.district) {
                            matchesCriteria = false;
                        }

                        // Price filter
                        if (params.maxPrice) {
                            const price = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('M') ? 1000000 : 1000);
                            if (price > params.maxPrice) {
                                matchesCriteria = false;
                            } else {
                                score += (params.maxPrice - price) / params.maxPrice;
                            }
                        }

                        // Area filter
                        if (params.minArea) {
                            const area = parseInt(property.area.replace(/[^0-9]/g, ''));
                            if (area < params.minArea) {
                                matchesCriteria = false;
                            } else {
                                score += area / params.minArea;
                            }
                        }

                        // Proximity to schools
                        if (params.schoolDistance && params.minSchools) {
                            this.analyzeProximity(property, params);
                            if (this.nearbySchools.length < params.minSchools) {
                                matchesCriteria = false;
                            } else {
                                const avgSchoolDistance = this.nearbySchools.reduce((sum, s) => sum + s.distance, 0) / this.nearbySchools.length;
                                score += (params.schoolDistance - avgSchoolDistance) / params.schoolDistance;
                            }
                        }

                        // Proximity to hospitals
                        if (params.hospitalDistance && params.minHospitals) {
                            this.analyzeProximity(property, params);
                            if (this.nearbyHospitals.length < params.minHospitals) {
                                matchesCriteria = false;
                            } else {
                                const avgHospitalDistance = this.nearbyHospitals.reduce((sum, h) => sum + h.distance, 0) / this.nearbyHospitals.length;
                                score += (params.hospitalDistance - avgHospitalDistance) / params.hospitalDistance;
                            }
                        }

                        // Equidistant logic
                        if (params.equidistant && params.schoolDistance && params.hospitalDistance) {
                            this.analyzeProximity(property, params);
                            if (this.nearbySchools.length > 0 && this.nearbyHospitals.length > 0) {
                                const minSchoolDistance = Math.min(...this.nearbySchools.map(s => s.distance));
                                const minHospitalDistance = Math.min(...this.nearbyHospitals.map(h => h.distance));
                                const distanceDiff = Math.abs(minSchoolDistance - minHospitalDistance);
                                if (distanceDiff > 0.5) {
                                    matchesCriteria = false;
                                } else {
                                    score += (0.5 - distanceDiff) / 0.5;
                                }
                            } else {
                                matchesCriteria = false;
                            }
                        }

                        // Family-friendly scoring
                        if (lowerQuery.includes('family') || lowerQuery.includes('children')) {
                            if (property.bedrooms >= 3) score += 0.5;
                            if (this.nearbySchools.length >= 2) score += 0.5;
                            if (property.amenities.includes('Garden')) score += 0.3;
                        }

                        // Investment scoring
                        if (lowerQuery.includes('investment')) {
                            if (['Gasabo', 'Nyarugenge'].includes(property.district)) score += 0.5;
                            if (property.price.includes('M') && parseInt(property.price) < 100) score += 0.3;
                        }

                        return { property, score, matchesCriteria };
                    })
                    .filter(item => item.matchesCriteria)
                    .sort((a, b) => b.score - a.score)
                    .map(item => item.property);
            }
            
            generateMarketAnalysis() {
                return `
                    <h4>üìà Kigali Real Estate Market Overview</h4>
                    <p>The Kigali real estate market is experiencing steady growth, driven by urban development and foreign investment. Key trends include:</p>
                    <ul>
                        <li><strong>High Demand in Gasabo and Nyarugenge</strong>: These districts see strong interest due to proximity to business hubs and amenities.</li>
                        <li><strong>Rental Market Growth</strong>: Apartments under 50M RWF are popular among young professionals and expatriates.</li>
                        <li><strong>Land Appreciation</strong>: Plots in Kicukiro and Gasabo are appreciating at 5-7% annually due to infrastructure projects.</li>
                    </ul>
                    <p>Explore specific districts or property types for detailed insights!</p>`;
            }
            
            generateInvestmentAdvice() {
                return `
                    <h4>üí∞ Investment Opportunities in Kigali</h4>
                    <p>For optimal ROI, consider:</p>
                    <ul>
                        <li><strong>Gasabo Plots</strong>: Affordable plots (40-50M RWF) in areas like Remera offer high appreciation potential.</li>
                        <li><strong>Rental Apartments</strong>: Properties under 100M RWF in Kacyiru and Nyarugenge yield 6-8% annually.</li>
                        <li><strong>Luxury Market</strong>: High-end villas in Nyarutarama attract expatriates and diplomats, ensuring stable rental income.</li>
                    </ul>
                    <p>Ask for specific properties or districts to tailor your investment strategy!</p>`;
            }
            
            generateDistrictAnalysis() {
                return `
                    <h4>üèôÔ∏è Kigali District Insights</h4>
                    <p>Key districts for real estate:</p>
                    <ul>
                        <li><strong>Gasabo</strong>: Home to affluent areas like Nyarutarama and Kimihurura. Ideal for luxury and family homes.</li>
                        <li><strong>Nyarugenge</strong>: Central business district with high rental demand for apartments.</li>
                        <li><strong>Kicukiro</strong>: Emerging area with affordable plots and growing infrastructure.</li>
                    </ul>
                    <p>Filter by district to explore available properties!</p>`;
            }
            
            generateLuxuryMarketInsight() {
                return `
                    <h4>‚≠ê Luxury Property Insights</h4>
                    <p>Kigali‚Äôs luxury market is thriving, particularly in:</p>
                    <ul>
                        <li><strong>Nyarutarama</strong>: Golf course villas with amenities like pools and smart home systems.</li>
                        <li><strong>Kigali Heights</strong>: Exclusive properties with panoramic views, priced above 400M RWF.</li>
                    </ul>
                    <p>Search for luxury villas or apartments to see premium listings!</p>`;
            }
            
            generateRentalMarketAnalysis() {
                return `
                    <h4>üè† Rental Market Insights</h4>
                    <p>Kigali‚Äôs rental market is vibrant, with:</p>
                    <ul>
                        <li><strong>Affordable Apartments</strong>: 1-2 bedroom units in Kibagabaga and Gisozi, priced 30-75M RWF.</li>
                        <li><strong>High-Demand Areas</strong>: Nyarugenge and Kacyiru offer strong rental yields due to business proximity.</li>
                    </ul>
                    <p>Filter for rentals to explore available options!</p>`;
            }
            
            generatePricingInsights() {
                return `
                    <h4>üí∏ Pricing Trends</h4>
                    <p>Kigali property prices vary by district and type:</p>
                    <ul>
                        <li><strong>Plots</strong>: 40-50M RWF in Kicukiro and Remera.</li>
                        <li><strong>Apartments</strong>: 30-75M RWF for rentals, 65-150M RWF for sales.</li>
                        <li><strong>Villas</strong>: 140-520M RWF, with luxury options in Nyarutarama.</li>
                    </ul>
                    <p>Specify a budget or property type for tailored results!</p>`;
            }
            
            generateEducationInsights() {
                return `
                    <h4>üéì Education Access in Kigali</h4>
                    <p>Key areas with strong school access:</p>
                    <ul>
                        <li><strong>Gasabo</strong>: Home to Green Hills Academy and Kigali Parents School.</li>
                        <li><strong>Nyarugenge</strong>: Proximity to national curriculum schools like ITETERO.</li>
                    </ul>
                    <p>Search for properties near schools for family-friendly options!</p>`;
            }
            
            generateHealthcareInsights() {
                return `
                    <h4>üè• Healthcare Access</h4>
                    <p>Major hospitals are concentrated in:</p>
                    <ul>
                        <li><strong>Gasabo</strong>: King Faisal Hospital, Rwanda Military Hospital.</li>
                        <li><strong>Nyarugenge</strong>: CHUK for specialized care.</li>
                    </ul>
                    <p>Filter for properties near hospitals for healthcare proximity!</p>`;
            }
            
            generateFamilyLivingInsights() {
                return `
                    <h4>üë®‚Äçüë©‚Äçüëß Family-Friendly Living</h4>
                    <p>Best areas for families:</p>
                    <ul>
                        <li><strong>Kimihurura</strong>: Quiet, with large houses and nearby schools.</li>
                        <li><strong>Kibagabaga</strong>: Affordable family homes with garden spaces.</li>
                    </ul>
                    <p>Search for 3+ bedroom houses near schools for ideal family homes!</p>`;
            }
            
            generateDevelopmentInsights() {
                return `
                    <h4>üèóÔ∏è Development Insights</h4>
                    <p>Kigali‚Äôs real estate is boosted by:</p>
                    <ul>
                        <li><strong>Infrastructure Growth</strong>: New roads and utilities in Kicukiro.</li>
                        <li><strong>Developer Activity</strong>: Affordable plots in Remera and Gisozi are popular for new builds.</li>
                    </ul>
                    <p>Explore plots for development opportunities!</p>`;
            }
            
            generateInfrastructureInsights() {
                return `
                    <h4>üõ£Ô∏è Infrastructure Insights</h4>
                    <p>Kigali‚Äôs infrastructure supports real estate growth:</p>
                    <ul>
                        <li><strong>Transport</strong>: Improved roads in Gasabo and Kicukiro enhance accessibility.</li>
                        <li><strong>Utilities</strong>: Reliable power and water in most urban areas.</li>
                    </ul>
                    <p>Search properties in well-connected districts for convenience!</p>`;
            }
            
            generatePriceResponse(property) {
                return `
                    <h4>üí∞ Price Analysis for ${property.name}</h4>
                    <p><strong>Price:</strong> ${property.price}</p>
                    <p><strong>Market Context:</strong> This ${property.type.toLowerCase()} in ${property.district} is priced ${this.isPriceCompetitive(property) ? 'competitively' : 'above average'} for its amenities and location.</p>
                    <p>Explore similar properties to compare!</p>`;
            }
            
            generateSchoolResponse(property) {
                this.analyzeProximity(property);
                let response = `<h4>üéì Schools near ${property.name}</h4>`;
                if (this.nearbySchools.length > 0) {
                    response += `<p>Found ${this.nearbySchools.length} schools within 2km:</p><ul>`;
                    this.nearbySchools.slice(0, 3).forEach(school => {
                        response += `<li>${school.school_name} (${(school.distance * 1000).toFixed(0)}m)</li>`;
                    });
                    response += `</ul>`;
                } else {
                    response += `<p>No schools within 2km. Consider transportation for school access.</p>`;
                }
                return response;
            }
            
            generateHealthResponse(property) {
                this.analyzeProximity(property);
                let response = `<h4>üè• Hospitals near ${property.name}</h4>`;
                if (this.nearbyHospitals.length > 0) {
                    response += `<p>Found ${this.nearbyHospitals.length} hospitals within 3km:</p><ul>`;
                    this.nearbyHospitals.slice(0, 3).forEach(hospital => {
                        response += `<li>${hospital.facility_name} (${hospital.distance.toFixed(1)}km)</li>`;
                    });
                    response += `</ul>`;
                } else {
                    response += `<p>No hospitals within 3km. Emergency services may be farther.</p>`;
                }
                return response;
            }
            
            generateFamilyResponse(property) {
                this.analyzeProximity(property);
                let response = `<h4>üë®‚Äçüë©‚Äçüëß Family Suitability for ${property.name}</h4>`;
                response += `<p><strong>Type:</strong> ${property.type}, ${property.bedrooms || 0} bedrooms</p>`;
                if (property.bedrooms >= 3 && this.nearbySchools.length >= 2) {
                    response += `<p>Ideal for families: Spacious with ${this.nearbySchools.length} schools nearby.</p>`;
                } else {
                    response += `<p>${property.bedrooms < 3 ? 'Limited bedrooms' : 'Good size'}, but ${this.nearbySchools.length} schools within 2km.</p>`;
                }
                if (property.amenities.includes('Garden')) {
                    response += `<p>Bonus: Includes a garden for family activities.</p>`;
                }
                return response;
            }
            
            isPriceCompetitive(property) {
                const price = parseInt(property.price.replace(/[^0-9]/g, '')) * (property.price.includes('M') ? 1000000 : 1000);
                const similarProperties = this.properties.filter(p => p.type === property.type && p.district === property.district);
                const avgPrice = similarProperties.reduce((sum, p) => sum + parseInt(p.price.replace(/[^0-9]/g, '')) * (p.price.includes('M') ? 1000000 : 1000), 0) / similarProperties.length;
                return price <= avgPrice;
            }
            
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            showTyping() {
                document.getElementById('typingIndicator').classList.add('show');
                this.scrollToBottom();
            }
            
            hideTyping() {
                document.getElementById('typingIndicator').classList.remove('show');
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        const propertyIntel = new PropertyIntelSystem();
        
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            chatContainer.classList.toggle('collapsed');
            toggleIcon.classList.toggle('fa-chevron-left');
            toggleIcon.classList.toggle('fa-chevron-right');
            propertyIntel.map.invalidateSize();
        }
    </script>
</body>
</html>
