<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Enhanced</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Desktop Layout - Chat on Left */
        .chat-container {
            width: 380px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.1);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        /* Mobile Layout - Chat at Bottom */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .chat-container {
                width: 100%;
                height: 50vh;
                min-height: 400px;
                border-right: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                order: 2;
            }
            .map-container {
                height: 50vh;
                order: 1;
            }
            
            /* Adjust search controls for mobile */
            .search-controls {
                padding: 10px;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 6px;
            }
            
            .compact-filter {
                width: 100%;
                min-width: unset;
            }
            
            /* Ensure chat messages area is visible */
            .chat-messages {
                flex: 1;
                min-height: 200px;
                max-height: none;
            }
            
            /* Make chat header smaller on mobile */
            .chat-header {
                padding: 12px 15px;
                font-size: 1.1rem;
            }
            
            .chat-header small {
                font-size: 0.75rem;
                margin-top: 2px;
            }
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 1.3rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-header small {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
            display: block;
            margin-top: 4px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
            background: rgba(10, 10, 15, 0.3);
            min-height: 150px;
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px 15px 15px 4px;
            padding: 12px 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
        }
        
        .message.ai .message-content::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 8px;
            font-size: 1.2rem;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 200, 100, 0.15) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px 15px 4px 15px;
            padding: 12px 15px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 80%;
            position: relative;
        }
        
        .message.user .message-content::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 8px;
            font-size: 1.2rem;
        }
        
        .chat-input-container {
            padding: 15px;
            background: rgba(10, 10, 15, 0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .property-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .property-marker:hover {
            transform: scale(1.2);
        }
        
        .property-marker.sale {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        .property-marker.rent {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .property-marker.special {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .hospital-marker {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .hospital-marker:hover {
            transform: scale(1.3);
        }
        
        .location-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        .location-info .status-sale { color: #ff6b6b; font-weight: bold; }
        .location-info .status-rent { color: #667eea; font-weight: bold; }
        .location-info .status-special { color: #ffd700; font-weight: bold; }
        
        .hospital-proximity {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .hospital-list {
            margin-top: 10px;
        }
        
        .hospital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hospital-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .hospital-name {
            font-weight: 600;
            color: #00ff88;
        }
        
        .hospital-distance {
            color: #ccc;
            font-size: 0.8rem;
        }
        
        .buffer-hospital {
            fill: rgba(102, 126, 234, 0.15);
            stroke: #667eea;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .insight-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            font-weight: 600;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        /* Search and Filter Controls */
        .search-controls {
            background: rgba(15, 15, 25, 0.8);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .search-container {
            margin-bottom: 12px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0;
        }
        
        .main-search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 16px;
            outline: none;
        }
        
        .main-search-input::placeholder {
            color: #666;
        }
        
        .search-icon-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-icon-btn:hover {
            background: #f5f5f5;
        }
        
        .search-options {
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .location-option {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #1a73e8;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .location-option:hover {
            background: #e8f0fe;
        }
        
        .location-option i {
            font-size: 16px;
        }
        
        .filter-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .compact-filter {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            cursor: pointer;
        }
        
        .compact-filter:focus {
            border-color: #667eea;
        }
        
        .compact-filter option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .filter-summary {
            font-size: 0.75rem;
            color: #999;
            text-align: center;
            padding: 5px;
        }
        
        /* Current location marker */
        .current-location-marker {
            width: 16px;
            height: 16px;
            background: #ff4757;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.6);
            animation: locationPulse 2s infinite;
        }
        
        @keyframes locationPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 71, 87, 0.6); }
            50% { transform: scale(1.2); box-shadow: 0 0 25px rgba(255, 71, 87, 0.8); }
        }
        
        /* Hospital flashing animation */
        .hospital-flash {
            animation: hospitalFlash 1s ease-in-out infinite;
        }
        
        @keyframes hospitalFlash {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
            }
            50% { 
                opacity: 0.3; 
                transform: scale(1.3);
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.9);
            }
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #667eea;
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI is analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI is analyzing'; }
            40% { content: 'AI is analyzing.'; }
            60% { content: 'AI is analyzing..'; }
            80%, 100% { content: 'AI is analyzing...'; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                PropertyIntel Kigali 
                <small>AI Real Estate Advisor with Location Intelligence in your pocket</small>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="search-controls">
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input-wrapper">
                            <input type="text" id="locationSearch" class="main-search-input" placeholder="Find address or place">
                            <button id="searchBtn" class="search-icon-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="search-options">
                            <button id="locationBtn" class="location-option">
                                <i class="fas fa-crosshairs"></i>
                                Use current location
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="filter-row">
                    <select id="statusFilter" class="compact-filter">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="compact-filter">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                    </select>
                    
                    <select id="priceFilter" class="compact-filter">
                        <option value="">Price Range</option>
                        <option value="0-50">Under 50M</option>
                        <option value="50-100">50M - 100M</option>
                        <option value="100-200">100M - 200M</option>
                        <option value="200+">Above 200M</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Welcome to PropertyIntel Kigali!<br><br>
                        I'm your AI real estate advisor. Click on any property to get instant insights about:
                        <br>• Hospital proximity (WHO 5km standard)
                        <br>• Property investment potential
                        <br>• Neighborhood analysis
                        <br>• Health facility accessibility
                        <br><br>
                        <strong>Click a property marker to get started!</strong>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask me anything about this property..." rows="1" disabled></textarea>
                <button class="send-btn" id="sendBtn" disabled>Send Message</button>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentLocation, currentProperty, facilities = [], hospitalMarkers = [];
        let nearbyHospitals = [], currentLocationMarker = null, allPropertyMarkers = [], filteredProperties = [];

        // Extended property data with 20 properties across Kigali
        const properties = [
            // Kigali City Center
            { lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m²', yearBuilt: 2022, district: 'Nyarugenge' },
            { lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m²', yearBuilt: 2019, district: 'Nyarugenge' },
            
            // Kimihurura
            { lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m²', yearBuilt: 2021, district: 'Gasabo' },
            { lat: -1.9256, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m²', yearBuilt: 2018, district: 'Gasabo' },
            { lat: -1.9316, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m²', yearBuilt: 2020, district: 'Gasabo' },
            
            // Kacyiru
            { lat: -1.9634, lng: 30.1029, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m²', yearBuilt: 2017, district: 'Gasabo' },
            { lat: -1.9604, lng: 30.1059, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m²', yearBuilt: 2023, district: 'Gasabo' },
            { lat: -1.9664, lng: 30.0999, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m²', yearBuilt: 2019, district: 'Gasabo' },
            
            // Remera
            { lat: -1.9456, lng: 30.1312, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m²', yearBuilt: 2020, district: 'Gasabo' },
            { lat: -1.9486, lng: 30.1342, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m²', yearBuilt: 2021, district: 'Gasabo' },
            
            // Gikondo
            { lat: -1.9756, lng: 30.0529, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m²', yearBuilt: 2019, district: 'Kicukiro' },
            { lat: -1.9786, lng: 30.0559, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m²', yearBuilt: 2016, district: 'Kicukiro' },
            
            // Nyamirambo
            { lat: -1.9606, lng: 30.0429, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m²', yearBuilt: 2018, district: 'Nyarugenge' },
            { lat: -1.9636, lng: 30.0399, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m²', yearBuilt: 2017, district: 'Nyarugenge' },
            
            // Kigali Heights
            { lat: -1.9156, lng: 30.0819, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m²', yearBuilt: 2024, district: 'Gasabo' },
            { lat: -1.9186, lng: 30.0789, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m²', yearBuilt: 2022, district: 'Gasabo' },
            
            // Kibagabaga
            { lat: -1.9706, lng: 30.1159, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m²', yearBuilt: 2018, district: 'Gasabo' },
            { lat: -1.9736, lng: 30.1129, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m²', yearBuilt: 2019, district: 'Gasabo' },
            
            // Nyarutarama
            { lat: -1.9356, lng: 30.1212, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m²', yearBuilt: 2023, district: 'Gasabo' },
            { lat: -1.9386, lng: 30.1182, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m²', yearBuilt: 2021, district: 'Gasabo' }
        ];

        async function loadFacilities() {
            try {
                const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                const data = await response.json();
                
                // Parse ESRI JSON structure
                if (data.features && Array.isArray(data.features)) {
                    facilities = data.features.map(feature => ({
                        facility_name: feature.attributes.facility_name,
                        facility_type: feature.attributes.facility_type,
                        lat: feature.attributes.lat,
                        long: feature.attributes.long,
                        district: feature.attributes.district,
                        sector: feature.attributes.sector,
                        ownership: feature.attributes.ownership,
                        opening_date: feature.attributes.opening_date
                    }));
                    console.log('Loaded facilities from JSON:', facilities.length);
                } else {
                    throw new Error('Invalid JSON structure');
                }
            } catch (error) {
                console.error('Failed to load facilities:', error);
                // Fallback data using some from your actual JSON
                facilities = [
                    { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo", sector: "Kacyiru" },
                    { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge", sector: "Nyarugenge" },
                    { facility_name: "Kacyiru DH", facility_type: "District Hospital", lat: -1.932984, long: 30.075489, district: "Gasabo", sector: "Kacyiru" },
                    { facility_name: "Kibagabaga Hospital", facility_type: "District Hospital", lat: -1.9308, long: 30.112, district: "Gasabo", sector: "Kimironko" },
                    { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro", sector: "Nyarugunga" },
                    { facility_name: "Muhima DH", facility_type: "District Hospital", lat: -1.9367, long: 30.0585, district: "Nyarugenge", sector: "Muhima" },
                    { facility_name: "Masaka District Hospital", facility_type: "District Hospital", lat: -1.99563, long: 30.1913, district: "Kicukiro", sector: "Masaka" }
                ];
                console.log('Using fallback facility data');
            }
        }

        function initializeMap() {
            map = L.map('map').setView([-1.9441, 30.0619], 12);
            
            // Enhanced map tiles with proper error handling
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                crossOrigin: true
            }).addTo(map);
            
            // Ensure map renders properly
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            addProperties();
            addHospitals();
            
            map.on('click', handleMapClick);
        }

        function addProperties() {
            allPropertyMarkers = [];
            filteredProperties = [...properties]; // Start with all properties
            
            properties.forEach((prop, index) => {
                const isSpecial = prop.type.includes('Luxury') || prop.type.includes('Premium');
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${isSpecial ? 'special' : prop.status}`,
                        html: `<div style="width: 24px; height: 24px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                marker.bindTooltip(
                    `<strong>${prop.name}</strong><br>
                    ${prop.price}<br>
                    ${prop.bedrooms}BR • ${prop.bathrooms}BA • ${prop.area}<br>
                    ${prop.district} District`, 
                    { direction: 'top', offset: [0, -10] }
                );
                
                marker.on('click', () => selectProperty(prop));
                
                // Store marker with property data
                allPropertyMarkers.push({
                    marker: marker,
                    property: prop,
                    visible: true
                });
            });
            
            updateFilterSummary();
        }

        function addHospitals() {
            // Don't add hospital markers to map initially - they'll be shown only when within 5km of selected property
            hospitalMarkers = [];
            console.log(`Loaded ${facilities.length} health facilities (markers will show when within 5km of properties)`);
        }

        function selectProperty(property) {
            currentProperty = property;
            currentLocation = L.latLng(property.lat, property.lng);
            
            // Enable chat
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // Clear previous analysis
            clearBuffers();
            
            // Analyze hospital proximity
            analyzeHospitalProximity(property);
            
            // Generate AI insights
            generatePropertyInsights(property);
            
            // Center map on property
            map.setView([property.lat, property.lng], 15);
        }

        function analyzeHospitalProximity(property) {
            nearbyHospitals = [];
            
            // Clear any existing hospital markers from previous selections
            hospitalMarkers.forEach(marker => map.removeLayer(marker));
            hospitalMarkers = [];
            
            facilities.forEach(facility => {
                const facilityType = facility.facility_type.toLowerCase();
                if (facilityType.includes('hospital') || 
                    facilityType.includes('health center') || 
                    facilityType.includes('clinic')) {
                    
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= 5) {
                        nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                        
                        // Create hospital marker with flashing animation
                        const marker = L.marker([facility.lat, facility.long], {
                            icon: L.divIcon({
                                className: 'hospital-marker hospital-flash',
                                html: `<div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00ff88, #00cc6a); border: 3px solid white; border-radius: 50%;"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        marker.bindTooltip(
                            `<strong>${facility.facility_name}</strong><br>
                            Type: ${facility.facility_type}<br>
                            Distance: ${distance.toFixed(1)}km<br>
                            District: ${facility.district || 'N/A'}<br>
                            Sector: ${facility.sector || 'N/A'}`, 
                            { direction: 'top', offset: [0, -10] }
                        );
                        
                        hospitalMarkers.push(marker);
                        
                        // Stop flashing after 10 seconds
                        setTimeout(() => {
                            const markerElement = marker.getElement();
                            if (markerElement) {
                                markerElement.classList.remove('hospital-flash');
                            }
                        }, 10000);
                    }
                }
            });
            
            // Sort by distance
            nearbyHospitals.sort((a, b) => a.distance - b.distance);
            
            console.log(`Found ${nearbyHospitals.length} health facilities within 5km of ${property.name}`);
            displayProximityAnalysis(property);
        }

        function displayProximityAnalysis(property) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Property info
            const statusClass = property.type.includes('Luxury') ? 'status-special' : 
                               property.status === 'sale' ? 'status-sale' : 'status-rent';
            
            messagesContainer.innerHTML += `
                <div class="location-info">
                    <strong>${property.name}</strong><br>
                    <strong>Type:</strong> ${property.type}<br>
                    <strong>Price:</strong> ${property.price}<br>
                    <strong>Details:</strong> ${property.bedrooms}BR • ${property.bathrooms}BA • ${property.area}<br>
                    <strong>Year Built:</strong> ${property.yearBuilt}<br>
                    <span class="${statusClass}">Status: ${property.status.charAt(0).toUpperCase() + property.status.slice(1)}</span>
                </div>`;
            
            // Hospital proximity analysis
            if (nearbyHospitals.length > 0) {
                let hospitalHtml = `
                    <div class="hospital-proximity">
                        <strong>Hospital Proximity Analysis</strong><br>
                        <small>WHO Standard: 5km walking distance</small>
                        <div class="hospital-list">`;
                
                nearbyHospitals.forEach(hospital => {
                    hospitalHtml += `
                        <div class="hospital-item" onclick="focusHospital(${hospital.lat}, ${hospital.long})">
                            <div>
                                <div class="hospital-name">${hospital.facility_name}</div>
                                <div style="font-size: 0.75rem; color: #999;">${hospital.facility_type}</div>
                            </div>
                            <div class="hospital-distance">${hospital.distance.toFixed(1)}km</div>
                        </div>`;
                });
                
                hospitalHtml += `</div></div>`;
                messagesContainer.innerHTML += hospitalHtml;
            } else {
                messagesContainer.innerHTML += `
                    <div class="hospital-proximity">
                        <strong>Hospital Proximity Alert</strong><br>
                        No hospitals within WHO standard 5km walking distance.<br>
                        <small>Consider transportation accessibility for healthcare needs.</small>
                    </div>`;
            }
            
            scrollToBottom();
        }

        function generatePropertyInsights(property) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Show typing indicator
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                let insights = `
                    <div class="ai-insights">
                        <strong>AI Property Analysis</strong><br><br>`;
                
                // Health accessibility insight
                if (nearbyHospitals.length > 0) {
                    insights += `<span class="insight-tag">Excellent Health Access</span>`;
                    insights += `<br>Good: ${nearbyHospitals.length} healthcare facilities within 5km WHO standard<br>`;
                } else {
                    insights += `<span class="insight-tag">Health Access Concern</span>`;
                    insights += `<br>Alert: Limited healthcare accessibility - consider transportation needs<br>`;
                }
                
                // Property type insights
                if (property.type.includes('Luxury') || property.type.includes('Premium')) {
                    insights += `<span class="insight-tag">Premium Property</span>`;
                    insights += `<br>Premium: High-end property with excellent specifications<br>`;
                } else if (property.type === 'Apartment') {
                    insights += `<span class="insight-tag">Urban Living</span>`;
                    insights += `<br>Urban: City living with convenient amenities<br>`;
                } else {
                    insights += `<span class="insight-tag">Family Home</span>`;
                    insights += `<br>Family: Great for family living with privacy<br>`;
                }
                
                // Investment potential
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    insights += `<span class="insight-tag">High Value Investment</span>`;
                } else if (priceValue > 50) {
                    insights += `<span class="insight-tag">Mid-Range Investment</span>`;
                } else {
                    insights += `<span class="insight-tag">Entry Level Investment</span>`;
                }
                
                insights += `<br><br><strong>Ask me anything about this property!</strong></div>`;
                
                messagesContainer.innerHTML += insights;
                scrollToBottom();
            }, 2000);
        }

        function focusHospital(lat, lng) {
            map.setView([lat, lng], 17);
        }

        function clearBuffers() {
            // Clear hospital markers
            hospitalMarkers.forEach(marker => map.removeLayer(marker));
            hospitalMarkers = [];
        }

        function handleMapClick(e) {
            // Handle clicks on empty map areas
            if (!currentProperty) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            Please click on a property marker (colored circles) to get detailed analysis and proximity insights!
                        </div>
                    </div>`;
                scrollToBottom();
            }
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const locationSearch = document.getElementById('locationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const locationBtn = document.getElementById('locationBtn');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priceFilter = document.getElementById('priceFilter');
            
            // Chat functionality
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            // Search functionality
            locationSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') performLocationSearch();
            });
            
            searchBtn.addEventListener('click', performLocationSearch);
            locationBtn.addEventListener('click', useCurrentLocation);
            
            // Filter functionality
            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            priceFilter.addEventListener('change', applyFilters);
        }

        async function performLocationSearch() {
            const locationSearch = document.getElementById('locationSearch');
            const location = locationSearch.value.trim();
            if (!location) return;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                const results = await response.json();
                
                if (results.length > 0) {
                    const { lat, lon } = results[0];
                    map.setView([lat, lon], 16);
                    
                    // Add search location marker
                    const searchMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'search-location-marker',
                            html: '<div style="width: 16px; height: 16px; background: #667eea; border: 3px solid white; border-radius: 50%;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    searchMarker.bindTooltip(`Search: ${location}`, { direction: 'top' });
                    
                    // Remove search marker after 5 seconds
                    setTimeout(() => {
                        map.removeLayer(searchMarker);
                    }, 5000);
                } else {
                    alert('Location not found in Kigali');
                }
            } catch (error) {
                console.error('Search failed:', error);
                alert('Search failed. Please try again.');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }
            
            const locationBtn = document.getElementById('locationBtn');
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude: lat, longitude: lng } = position.coords;
                    
                    // Check if location is within reasonable bounds for Kigali
                    if (lat < -2.2 || lat > -1.7 || lng < 29.8 || lng > 30.3) {
                        alert('Your location appears to be outside Kigali area');
                        locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                        return;
                    }
                    
                    // Remove existing current location marker
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    // Add current location marker
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div style="width: 16px; height: 16px; background: #ff4757; border: 3px solid white; border-radius: 50%;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    currentLocationMarker.bindTooltip('Your Location', { direction: 'top', permanent: true });
                    
                    // Center map on current location
                    map.setView([lat, lng], 15);
                    
                    // Add message to chat
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML += `
                        <div class="message ai">
                            <div class="message-content">
                                Found your current location! The red pulsing marker shows where you are. Now click on nearby properties to see proximity analysis.
                            </div>
                        </div>`;
                    scrollToBottom();
                    
                    locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                },
                error => {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location. Please check your browser settings.');
                    locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            
            filteredProperties = properties.filter(property => {
                // Status filter
                if (statusFilter && property.status !== statusFilter) return false;
                
                // Type filter
                if (typeFilter) {
                    const propType = property.type.toLowerCase();
                    if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                    if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                    if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                    if (typeFilter === 'house' && !propType.includes('house')) return false;
                }
                
                // Price filter
                if (priceFilter) {
                    const price = parseInt(property.price.replace(/[^0-9]/g, ''));
                    if (priceFilter === '0-50' && price >= 50) return false;
                    if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                    if (priceFilter === '100-200' && (price < 100 || price >= 200)) return false;
                    if (priceFilter === '200+' && price < 200) return false;
                }
                
                return true;
            });
            
            // Update marker visibility
            allPropertyMarkers.forEach(markerObj => {
                const isVisible = filteredProperties.includes(markerObj.property);
                if (isVisible && !markerObj.visible) {
                    map.addLayer(markerObj.marker);
                    markerObj.visible = true;
                } else if (!isVisible && markerObj.visible) {
                    map.removeLayer(markerObj.marker);
                    markerObj.visible = false;
                }
            });
            
            updateFilterSummary();
        }

        function updateFilterSummary() {
            const filterSummary = document.getElementById('filterSummary');
            const total = properties.length;
            const shown = filteredProperties.length;
            
            if (shown === total) {
                filterSummary.textContent = `Showing all ${total} properties`;
            } else {
                filterSummary.textContent = `Showing ${shown} of ${total} properties`;
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || !currentProperty) return;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `
                <div class="message user">
                    <div class="message-content">${message}</div>
                </div>`;
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Show typing and generate AI response
            showTyping();
            setTimeout(() => {
                hideTyping();
                generateAIResponse(message, currentProperty);
            }, 1500);
            
            scrollToBottom();
        }

        function generateAIResponse(question, property) {
            const messagesContainer = document.getElementById('chatMessages');
            let response = '';
            
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                if (nearbyHospitals.length > 0) {
                    response = `Great question about healthcare access!<br><br>This property has excellent healthcare accessibility with ${nearbyHospitals.length} facilities within the WHO 5km standard:<br><br>`;
                    nearbyHospitals.slice(0, 3).forEach(h => {
                        response += `• <strong>${h.facility_name}</strong> (${h.facility_type}) - ${h.distance.toFixed(1)}km<br>`;
                    });
                    response += `<br>This significantly adds to the property's value and livability!`;
                } else {
                    response = `Healthcare accessibility is a concern for this property.<br><br>No hospitals within the WHO recommended 5km walking distance. You'd need to consider:<br>• Private transportation<br>• Emergency response times<br>• Regular healthcare access<br><br>This might affect property value and family suitability.`;
                }
            } else if (lowerQuestion.includes('investment') || lowerQuestion.includes('value') || lowerQuestion.includes('profit')) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    response = `This is a premium investment opportunity!<br><br>At ${property.price}, you're looking at the luxury market segment. Key factors:<br>• High-end specifications (${property.area}, ${property.bedrooms}BR)<br>• ${nearbyHospitals.length > 0 ? 'Excellent healthcare access' : 'Limited healthcare access'}<br>• Built in ${property.yearBuilt} - relatively new<br><br>Expected appreciation: 8-12% annually for premium properties in Kigali.`;
                } else {
                    response = `Solid investment potential!<br><br>At ${property.price}, this offers good entry-level investment value:<br>• ${property.area} living space<br>• ${nearbyHospitals.length > 0 ? 'Good healthcare proximity' : 'Consider healthcare access'}<br>• ${property.yearBuilt} construction<br><br>Expected growth: 6-10% annually in this market segment.`;
                }
            } else if (lowerQuestion.includes('neighborhood') || lowerQuestion.includes('area') || lowerQuestion.includes('location')) {
                response = `Great location question!<br><br>This ${property.name} is strategically located in Kigali:<br><br>`;
                response += `Healthcare: ${nearbyHospitals.length} facilities within 5km${nearbyHospitals.length > 0 ? ' (Good)' : ' (Limited)'}<br>`;
                response += `Education: Multiple schools and universities nearby<br>`;
                response += `Shopping: Close to major shopping centers<br>`;
                response += `Transport: Well-connected road networks<br>`;
                response += `Environment: Clean, safe residential area<br><br>`;
                response += `The location significantly enhances property value and livability!`;
            } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('expensive') || lowerQuestion.includes('cheap')) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                const pricePerSqm = (priceValue * 1000000) / parseInt(property.area.replace(/[^0-9]/g, ''));
                response = `Let me break down the pricing for you!<br><br>`;
                response += `<strong>Listed Price:</strong> ${property.price}<br>`;
                response += `<strong>Price per m²:</strong> ${Math.round(pricePerSqm).toLocaleString()} RWF<br>`;
                response += `<strong>Property Size:</strong> ${property.area}<br><br>`;
                if (priceValue > 100) {
                    response += `This is <span class="insight-tag">Premium Pricing</span> for Kigali luxury market.<br>`;
                } else if (priceValue > 50) {
                    response += `This is <span class="insight-tag">Market Rate</span> for this property type.<br>`;
                } else {
                    response += `This is <span class="insight-tag">Competitive Pricing</span> for the area.<br>`;
                }
                response += `Healthcare accessibility ${nearbyHospitals.length > 0 ? 'adds 10-15% value premium' : 'may affect pricing negatively'}.`;
            } else if (lowerQuestion.includes('recommend') || lowerQuestion.includes('should i buy') || lowerQuestion.includes('good choice')) {
                response = `Based on my analysis, here's my recommendation:<br><br>`;
                let score = 0;
                let reasons = [];
                
                // Healthcare scoring
                if (nearbyHospitals.length > 2) {
                    score += 30; 
                    reasons.push('Good: Excellent healthcare access');
                } else if (nearbyHospitals.length > 0) {
                    score += 20; 
                    reasons.push('Good: Healthcare access available');
                } else {
                    reasons.push('Alert: Limited healthcare access');
                }
                
                // Property age scoring
                const age = 2025 - property.yearBuilt;
                if (age < 5) {
                    score += 25; 
                    reasons.push('Good: Modern construction');
                } else {
                    score += 15; 
                    reasons.push('Good: Established property');
                }
                
                // Size and amenities
                if (property.bedrooms >= 4) {
                    score += 20; 
                    reasons.push('Good: Spacious for families');
                } else {
                    score += 15; 
                    reasons.push('Good: Appropriate size');
                }
                
                // Market positioning
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue <= 70) {
                    score += 25; 
                    reasons.push('Good: Competitive pricing');
                } else {
                    score += 15; 
                    reasons.push('Alert: Premium pricing');
                }
                
                reasons.forEach(reason => {
                    response += `${reason}<br>`;
                });
                
                response += `<br><strong>Overall Score: ${score}/100</strong><br><br>`;
                
                if (score >= 80) {
                    response += `<span class="insight-tag">Highly Recommended</span><br>This is an excellent choice! Strong fundamentals across all key metrics.`;
                } else if (score >= 60) {
                    response += `<span class="insight-tag">Recommended</span><br>Good investment opportunity with solid potential.`;
                } else {
                    response += `<span class="insight-tag">Consider Carefully</span><br>Some concerns to address before purchasing.`;
                }
            } else if (lowerQuestion.includes('transport') || lowerQuestion.includes('road') || lowerQuestion.includes('access')) {
                response = `Transportation and accessibility analysis!<br><br>`;
                response += `<strong>Road Network:</strong><br>`;
                response += `• Well-connected to main Kigali roads<br>`;
                response += `• ${nearbyHospitals.length > 0 ? 'Easy access to healthcare facilities' : 'May need private transport for healthcare'}<br>`;
                response += `• Public transport availability varies by area<br><br>`;
                response += `<strong>Accessibility Score:</strong> ${nearbyHospitals.length > 0 ? '8/10 Good' : '6/10 Moderate'}<br>`;
                response += `The location provides ${nearbyHospitals.length > 0 ? 'excellent' : 'moderate'} connectivity to essential services.`;
            } else {
                // General response
                response = `Thanks for your question about ${property.name}!<br><br>`;
                response += `This ${property.type} offers:<br>`;
                response += `• ${property.bedrooms} bedrooms, ${property.bathrooms} bathrooms<br>`;
                response += `• ${property.area} living space<br>`;
                response += `• Built in ${property.yearBuilt}<br>`;
                response += `• ${nearbyHospitals.length} healthcare facilities within 5km<br><br>`;
                response += `Feel free to ask about specific aspects like investment potential, neighborhood, pricing, or healthcare access!`;
            }
            
            messagesContainer.innerHTML += `
                <div class="message ai">
                    <div class="message-content">${response}</div>
                </div>`;
            
            scrollToBottom();
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.add('show');
            scrollToBottom();
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFacilities();
            initializeMap();
            setupEventListeners();
            
            // Handle window resize for map
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            });
            
            // Add some initial guidance
            console.log(`PropertyIntel Enhanced loaded with ${facilities.length} health facilities`);
        });
    </script>
</body>
</html>
