<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: #ffffff;
            height: 100vh;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #16213e;
        }
        .map-container {
            flex: 1;
            margin: 10px;
            border-radius: 12px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .chat-container {
            width: 100%;
            background: rgba(15, 15, 25, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px;
            background: #667eea;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .chat-header small {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            scroll-behavior: smooth;
        }
        .message {
            margin-bottom: 10px;
        }
        .message.ai .message-content {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px 10px 10px 3px;
            padding: 10px;
            font-size: 0.85rem;
        }
        .message.user .message-content {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px 10px 3px 10px;
            padding: 10px;
            font-size: 0.85rem;
            margin-left: auto;
            max-width: 75%;
        }
        .chat-input-container {
            padding: 10px;
            background: rgba(10, 10, 15, 0.8);
        }
        .chat-input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.85rem;
            resize: none;
            outline: none;
        }
        .chat-input:focus {
            border-color: #667eea;
        }
        .send-btn {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            background: #667eea;
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        .send-btn:hover {
            background: #764ba2;
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .property-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }
        .property-marker.sale {
            background: #ff6b6b;
        }
        .property-marker.rent {
            background: #667eea;
        }
        .property-marker.special {
            background: #ffd700;
        }
        .hospital-marker {
            width: 15px;
            height: 15px;
            background: #00ff88;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
        }
        .nearest-hospital-marker {
            width: 15px;
            height: 15px;
            background: #ff00ff;
            border: 2px solid white;
            border-radius: 50%;
        }
        .location-info {
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }
        .location-info .status-sale { color: #ff6b6b; font-weight: bold; }
        .location-info .status-rent { color: #667eea; font-weight: bold; }
        .location-info .status-special { color: #ffd700; font-weight: bold; }
        .buffer-hospital {
            fill: rgba(102, 126, 234, 0.2);
            stroke: #667eea;
            stroke-width: 2;
        }
        @media (min-width: 769px) {
            .main-container {
                flex-direction: row;
            }
            .chat-container {
                width: 400px;
                border-top: none;
                border-right: 1px solid rgba(255,255,255,0.1);
            }
            .map-container {
                flex: 1;
            }
        }
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                PropertyIntel Kigali <small>AI Real Estate Advisor</small>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask about this property..." rows="1" disabled></textarea>
                <button class="send-btn" id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentLocation, bufferLayers = [], facilities = [], hospitalMarkers = [], nearestHospitalMarkers = [];

        async function loadFacilities() {
            try {
                const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                const data = await response.json();
                facilities = data.facilities || [];
            } catch (error) {
                console.error('Failed to load facilities:', error);
                alert('Failed to load facility data');
                facilities = [
                    { facility_name: "King Faisal Hospital", facility_type: "Hospital", lat: -1.9300, long: 30.1200 },
                    { facility_name: "CHUK Hospital", facility_type: "Hospital", lat: -1.9600, long: 30.0800 },
                    { facility_name: "Kigali General", facility_type: "Hospital", lat: -1.9400, long: 30.1000 }
                ];
            }
        }

        function initializeMap() {
            map = L.map('map').setView([-1.9441, 30.0619], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            addSampleProperties();
            addFacilities();
            map.on('click', e => handleMapClick(e.latlng));
        }

        function addSampleProperties() {
            const properties = [
                { lat: -1.9286, lng: 30.1044, name: 'Sunset Villa', type: 'Villa', price: '120M RWF', status: 'sale' },
                { lat: -1.9506, lng: 30.0939, name: 'City View Apt', type: 'Apartment', price: '45M RWF', status: 'rent' },
                { lat: -1.9634, lng: 30.1029, name: 'Green Hills House', type: 'House', price: '65M RWF', status: 'sale' },
                { lat: -1.9456, lng: 30.0612, name: 'Golden Villa', type: 'Suspicious Villa', price: '250M RWF', status: 'sale' }
            ];
            properties.forEach(prop => {
                const isSpecial = prop.type === 'Suspicious Villa';
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${isSpecial ? 'special' : prop.status}`,
                        html: `<div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                marker.bindTooltip(`${prop.name}<br>${prop.price}<br>${prop.status.charAt(0).toUpperCase() + prop.status.slice(1)}`, {
                    direction: 'top'
                });
                marker.on('click', () => handleMapClick(L.latLng(prop.lat, prop.lng), prop));
            });
        }

        function addFacilities() {
            hospitalMarkers.forEach(marker => map.removeLayer(marker));
            hospitalMarkers = [];
            facilities.filter(f => f.facility_type.toLowerCase() === 'hospital').forEach(facility => {
                const marker = L.marker([facility.lat, facility.long], {
                    icon: L.divIcon({
                        className: 'hospital-marker',
                        html: `<div style="width: 15px; height: 15px; background: #00ff88; border: 2px solid white; border-radius: 50%;"></div>`,
                        iconSize: [15, 15],
                        iconAnchor: [7.5, 7.5]
                    })
                }).addTo(map);
                marker.bindTooltip(`${facility.facility_name}<br>Type: ${facility.facility_type}`, { direction: 'top' });
                hospitalMarkers.push(marker);
            });
        }

        function highlightNearestHospitals(lat, lng, count = 2) {
            nearestHospitalMarkers.forEach(marker => map.removeLayer(marker));
            nearestHospitalMarkers = [];
            const hospitals = facilities.filter(f => f.facility_type.toLowerCase() === 'hospital');
            hospitals.sort((a, b) => {
                const distA = L.latLng(lat, lng).distanceTo([a.lat, a.long]) / 1000;
                const distB = L.latLng(lat, lng).distanceTo([b.lat, b.long]) / 1000;
                return distA - distB;
            });
            const nearest = hospitals.slice(0, count);
            nearest.forEach(facility => {
                const marker = L.marker([facility.lat, facility.long], {
                    icon: L.divIcon({
                        className: 'nearest-hospital-marker',
                        html: `<div style="width: 15px; height: 15px; background: #ff00ff; border: 2px solid white; border-radius: 50%;"></div>`,
                        iconSize: [15, 15],
                        iconAnchor: [7.5, 7.5]
                    })
                }).addTo(map);
                marker.bindTooltip(`${facility.facility_name}<br>Type: ${facility.facility_type}`, { direction: 'top' });
                nearestHospitalMarkers.push(marker);
            });
            return nearest;
        }

        function addHospitalBuffers(lat, lng, facility) {
            bufferLayers.forEach(layer => map.removeLayer(layer));
            bufferLayers = [];
            const distance = L.latLng(lat, lng).distanceTo([facility.lat, facility.long]) / 1000;
            if (distance <= 5) {
                bufferLayers.push(L.circle([facility.lat, facility.long], {
                    radius: 5000,
                    className: 'buffer-hospital',
                    fillOpacity: 0.2,
                    color: '#667eea',
                    weight: 2
                }).addTo(map));
            }
        }

        function getHospitalProximityAnalysis(lat, lng, nearestHospitals) {
            const currentDateTime = '09:52 PM CAT, Wednesday, August 06, 2025';
            return `**Nearest Hospital Analysis (as of ${currentDateTime})**
${nearestHospitals.map((hosp, index) => {
    const distance = L.latLng(lat, lng).distanceTo([hosp.lat, hosp.long]) / 1000;
    return `- ${index + 1}. ${hosp.facility_name} (${hosp.facility_type}): ${(distance).toFixed(1)} km
  ${distance <= 5 ? 'Within 5 km walking distance.' : 'Beyond 5 km walking distance.'}`;
}).join('\n')}`;
        }

        async function handleMapClick(latlng, propertyData = null) {
            currentLocation = latlng;
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            addLocationMessage(propertyData);
            const nearestHospitals = highlightNearestHospitals(latlng.lat, latlng.lng);
            messagesContainer.innerHTML += `<div class="message ai"><div class="message-content">${getHospitalProximityAnalysis(latlng.lat, latlng.lng, nearestHospitals)}</div></div>`;
            scrollToBottom();
        }

        function addLocationMessage(propertyData) {
            const messagesContainer = document.getElementById('chatMessages');
            const statusClass = propertyData ? (propertyData.type === 'Suspicious Villa' ? 'status-special' : propertyData.status === 'sale' ? 'status-sale' : 'status-rent') : '';
            messagesContainer.innerHTML += `
                <div class="location-info">
                    <strong>üìç Property Location</strong><br>
                    ${propertyData ? `
                        Name: ${propertyData.name}<br>
                        Type: ${propertyData.type}<br>
                        Price: ${propertyData.price}<br>
                        <span class="${statusClass}">Status: ${propertyData.status.charAt(0).toUpperCase() + propertyData.status.slice(1)}</span><br>
                    ` : 'No property selected'}
                </div>`;
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const searchInput = document.getElementById('searchInput');
            const locationBtn = document.getElementById('locationBtn');
            const randomBtn = document.getElementById('randomBtn');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 60) + 'px';
            });
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            sendBtn.addEventListener('click', sendMessage);
            searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            locationBtn.addEventListener('click', useCurrentLocation);
            randomBtn.addEventListener('click', selectRandomProperty);
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || !currentLocation) return;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `<div class="message user"><div class="message-content">${message}</div></div>`;
            chatInput.value = '';
            chatInput.style.height = 'auto';
            messagesContainer.innerHTML += `<div class="message ai"><div class="message-content">Click a property to see the nearest hospitals.</div></div>`;
            scrollToBottom();
        }

        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const location = searchInput.value.trim();
            if (!location) return alert('Enter a location');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                const results = await response.json();
                if (results.length) {
                    const { lat, lon } = results[0];
                    map.setView([lat, lon], 16);
                    handleMapClick(L.latLng(lat, lon));
                } else {
                    alert('Location not found');
                }
            } catch (error) {
                alert('Search failed');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) return alert('Geolocation not supported');
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude: lat, longitude: lng } = position.coords;
                    if (lat < -2.2 || lat > -1.7 || lng < 29.8 || lng > 30.3) {
                        alert('Location outside Kigali');
                        return;
                    }
                    map.setView([lat, lng], 16);
                    handleMapClick(L.latLng(lat, lng));
                },
                () => alert('Unable to get location')
            );
        }

        function selectRandomProperty() {
            const properties = [
                { lat: -1.9286, lng: 30.1044 },
                { lat: -1.9506, lng: 30.0939 },
                { lat: -1.9634, lng: 30.1029 },
                { lat: -1.9456, lng: 30.0612 }
            ];
            const random = properties[Math.floor(Math.random() * properties.length)];
            map.setView([random.lat, random.lng], 16);
            handleMapClick(L.latLng(random.lat, random.lng));
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadFacilities();
            initializeMap();
            setupEventListeners();
        });
    </script>
</body>
</html>
