<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Intel Kigali</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    .leaflet-popup-content-wrapper {
      font-size: 14px;
    }
    .highlight-circle {
      stroke: red;
      stroke-width: 3;
      fill: rgba(255,0,0,0.1);
      animation: pulse 1.5s ease-out infinite;
    }
    @keyframes pulse {
      0% { r: 100; opacity: 0.5; }
      50% { r: 150; opacity: 0.3; }
      100% { r: 100; opacity: 0.5; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <script>
    const map = L.map('map').setView([-1.95, 30.06], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const propertyIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
      iconSize: [32, 32]
    });

    // Load GeoJSON data
    async function loadJSON(url) {
      const res = await fetch(url);
      return res.json();
    }

    Promise.all([
      loadJSON('Kigali_RealEstate_Properties.json'),
      loadJSON('Kigali_Health.json'),
      loadJSON('Pre_Primary.json')
    ]).then(([propertyData, healthData, schoolData]) => {
      const healthLayer = L.geoJSON(healthData, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 5, color: 'green' })
      }).addTo(map);

      const schoolLayer = L.geoJSON(schoolData, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 5, color: 'blue' })
      }).addTo(map);

      const propertyLayer = L.geoJSON(propertyData, {
        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: propertyIcon }),
        onEachFeature: (feature, layer) => {
          layer.on('click', () => {
            const p = layer.getLatLng();

            // Filter nearby POIs
            const getNearbyCount = (layer, center, radius) => {
              let count = 0;
              let nearby = [];
              layer.eachLayer(l => {
                if (center.distanceTo(l.getLatLng()) < radius) {
                  count++;
                  nearby.push(l);
                }
              });
              return [count, nearby];
            };

            const [healthCount, nearbyHealth] = getNearbyCount(healthLayer, p, 500);
            const [schoolCount, nearbySchools] = getNearbyCount(schoolLayer, p, 500);

            // Highlight circles
            const flashCircle = (latlng) => {
              const circle = L.circle(latlng, {
                radius: 100,
                className: 'highlight-circle'
              }).addTo(map);
              setTimeout(() => map.removeLayer(circle), 3000);
            };
            nearbyHealth.forEach(f => flashCircle(f.getLatLng()));
            nearbySchools.forEach(f => flashCircle(f.getLatLng()));

            // Compose message
            const f = feature.properties;
            const summary = `
              <strong>ğŸ¡ ${f.upi || 'Unnamed Property'}</strong><br>
              Located in <strong>${f.district || 'Kigali'}</strong>, <strong>${f.sector || 'unknown sector'}</strong>.<br>
              âœ… Status: <strong>${f.status || 'N/A'}</strong><br>
              ğŸ§± Land Use: <strong>${f.existing_land_use || 'N/A'}</strong><br>
              ğŸ“ Within 500m:<br>
              - ğŸ¥ <strong>${healthCount}</strong> health facilities<br>
              - ğŸ« <strong>${schoolCount}</strong> pre-primary schools<br><br>
              This is a great opportunity for families or developers seeking proximity to key amenities in a vibrant Kigali neighborhood.`;

            layer.bindPopup(summary).openPopup();
          });
        }
      }).addTo(map);

      // Optional: show route from user to a clicked property
      map.locate({ setView: false, maxZoom: 16 });
      map.on('locationfound', (e) => {
        const userLoc = e.latlng;
        L.marker(userLoc).addTo(map).bindPopup('ğŸ“ Your Location').openPopup();

        propertyLayer.eachLayer(l => {
          l.on('contextmenu', () => {
            if (window.routingControl) map.removeControl(window.routingControl);
            window.routingControl = L.Routing.control({
              waypoints: [userLoc, l.getLatLng()],
              routeWhileDragging: false
            }).addTo(map);
          });
        });
      });
    });
  </script>
</body>
</html>
