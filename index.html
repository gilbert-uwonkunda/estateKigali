<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Enhanced</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Desktop Layout - Chat on Left */
        .chat-container {
            width: 380px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.1);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        /* Mobile Layout - Optimized */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .chat-container {
                width: 100%;
                height: 40vh;
                min-height: 300px;
                border-right: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                order: 2;
                transition: height 0.3s ease;
            }
            .chat-container.collapsed {
                height: 60px;
                overflow: hidden;
            }
            .map-container {
                height: 60vh;
                order: 1;
            }
            .map-container.fullscreen {
                height: 100vh !important;
                z-index: 1000;
            }
            .search-controls {
                padding: 12px;
            }
            .filter-row {
                flex-direction: column;
                gap: 8px;
            }
            .compact-filter {
                width: 100%;
                min-width: unset;
                padding: 12px 16px;
                font-size: 1rem;
            }
            .chat-messages {
                flex: 1;
                min-height: 150px;
                max-height: none;
            }
            .chat-header {
                padding: 12px 15px;
                font-size: 1.1rem;
                position: relative;
            }
            .chat-header small {
                font-size: 0.75rem;
                margin-top: 2px;
            }
            .chat-input-container {
                position: sticky;
                bottom: 0;
                background: rgba(10, 10, 15, 0.8);
                z-index: 10;
            }
            .toggle-chat-btn {
                display: block;
                position: absolute;
                top: 12px;
                right: 15px;
                background: #667eea;
                border: none;
                color: #fff;
                padding: 8px 12px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .fullscreen-toggle {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(15, 15, 25, 0.9);
                border: 1px solid rgba(255,255,255,0.2);
                color: #fff;
                padding: 10px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 1000;
                font-size: 1rem;
            }
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 1.3rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-header small {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
            display: block;
            margin-top: 4px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
            background: rgba(10, 10, 15, 0.3);
            min-height: 150px;
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px 15px 15px 4px;
            padding: 12px 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 200, 100, 0.15) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px 15px 4px 15px;
            padding: 12px 15px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 80%;
            position: relative;
        }
        
        .chat-input-container {
            padding: 15px;
            background: rgba(10, 10, 15, 0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .property-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .property-marker:hover {
            transform: scale(1.4);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            animation: glow 1.5s ease-in-out infinite;
        }
        
        .property-marker.sale {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        .property-marker.rent {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .property-marker.special {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            animation: pulse 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.9); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .hospital-marker {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .hospital-marker:hover {
            transform: scale(1.5);
            background: linear-gradient(135deg, #00ffcc, #00ff88);
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.8);
        }
        
        .hospital-marker:hover::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #00ff88;
            animation: ringPulse 1.5s ease-in-out infinite;
            top: -5px;
            left: -5px;
            z-index: -1;
        }
        
        @keyframes ringPulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        .location-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        .location-info .status-sale { color: #ff6b6b; font-weight: bold; }
        .location-info .status-rent { color: #667eea; font-weight: bold; }
        .location-info .status-special { color: #ffd700; font-weight: bold; }
        
        .hospital-proximity {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .hospital-list {
            margin-top: 10px;
        }
        
        .hospital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hospital-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .hospital-name {
            font-weight: 600;
            color: #00ff88;
        }
        
        .hospital-distance {
            color: #ccc;
            font-size: 0.8rem;
        }
        
        .buffer-hospital {
            fill: rgba(102, 126, 234, 0.15);
            stroke: #667eea;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .insight-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            font-weight: 600;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .search-controls {
            background: rgba(15, 15, 25, 0.8);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .search-container {
            margin-bottom: 12px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0;
        }
        
        .main-search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 16px;
            outline: none;
        }
        
        .main-search-input::placeholder {
            color: #666;
        }
        
        .search-icon-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-icon-btn:hover {
            background: #f5f5f5;
        }
        
        .search-options {
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .location-option {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #1a73e8;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .location-option:hover {
            background: #e8f0fe;
        }
        
        .location-option i {
            font-size: 16px;
        }
        
        .filter-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .compact-filter {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            cursor: pointer;
        }
        
        .compact-filter:focus {
            border-color: #667eea;
        }
        
        .compact-filter option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .filter-summary {
            font-size: 0.75rem;
            color: #999;
            text-align: center;
            padding: 5px;
        }
        
        .current-location-marker {
            width: 16px;
            height: 16px;
            background: #ff4757;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.6);
            animation: locationPulse 2s infinite;
        }
        
        @keyframes locationPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 71, 87, 0.6); }
            50% { transform: scale(1.2); box-shadow: 0 0 25px rgba(255, 71, 87, 0.8); }
        }
        
        .hospital-flash {
            animation: hospitalFlash 1s ease-in-out infinite;
        }
        
        @keyframes hospitalFlash {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
            }
            50% { 
                opacity: 0.3; 
                transform: scale(1.3);
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.9);
            }
        }
        
        .hospital-circle-flash {
            fill: transparent;
            stroke: #00ff88;
            stroke-width: 3;
            opacity: 0.8;
            animation: circleFlash 1.5s ease-in-out infinite;
        }
        
        @keyframes circleFlash {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.2); }
        }
        
        .leaflet-tooltip {
            background: linear-gradient(135deg, rgba(15, 15, 25, 0.95), rgba(25, 25, 40, 0.95)) !important;
            border: 1px solid rgba(102, 126, 234, 0.3) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            animation: tooltipPop 0.3s ease-out;
        }
        
        @keyframes tooltipPop {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .leaflet-tooltip::before {
            border-top-color: rgba(15, 15, 25, 0.95) !important;
            border-bottom-color: rgba(15, 15, 25, 0.95) !important;
        }
        
        .property-tooltip {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9)) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 10px !important;
            color: #ffffff !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            padding: 10px 14px !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
            backdrop-filter: blur(15px) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            animation: tooltipPop 0.3s ease-out;
        }
        
        .hospital-tooltip {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.9), rgba(0, 200, 100, 0.9)) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 10px !important;
            color: #ffffff !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 10px 14px !important;
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4) !important;
            backdrop-filter: blur(15px) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            animation: tooltipPop 0.3s ease-out;
        }
        
        .search-tooltip {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9)) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
            animation: tooltipPop 0.3s ease-out;
        }
        
        .location-tooltip {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.9), rgba(255, 50, 70, 0.9)) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
            animation: tooltipPop 0.3s ease-out;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #667eea;
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI is analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI is analyzing'; }
            40% { content: 'AI is analyzing.'; }
            60% { content: 'AI is analyzing..'; }
            80%, 100% { content: 'AI is analyzing...'; }
        }

        /* Property price labels */
        .property-price-label {
            background: linear-gradient(135deg, rgba(15, 15, 25, 0.95), rgba(25, 25, 40, 0.95));
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 6px;
            color: #ffffff;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            pointer-events: none;
        }
        
        .property-price-label.sale {
            border-color: rgba(255, 107, 107, 0.4);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(238, 90, 82, 0.9));
        }
        
        .property-price-label.rent {
            border-color: rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
        }
        
        .property-price-label.special {
            border-color: rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 237, 78, 0.9));
            color: #333;
            text-shadow: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                PropertyIntel Kigali 
                <small>AI Real Estate Advisor with Location Intelligence</small>
                <button class="toggle-chat-btn" onclick="toggleChat()">Toggle Chat</button>
            </div>
            
            <div class="search-controls">
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input-wrapper">
                            <input type="text" id="locationSearch" class="main-search-input" placeholder="Find address or place" aria-label="Search for address or place">
                            <button id="searchBtn" class="search-icon-btn" aria-label="Search">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="search-options">
                            <button id="locationBtn" class="location-option" aria-label="Use current location">
                                <i class="fas fa-crosshairs"></i>
                                Use current location
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="filter-row">
                    <select id="statusFilter" class="compact-filter" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="compact-filter" aria-label="Filter by property type">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                    </select>
                    
                    <select id="priceFilter" class="compact-filter" aria-label="Filter by price range">
                        <option value="">Price Range</option>
                        <option value="0-50">Under 50M</option>
                        <option value="50-100">50M - 100M</option>
                        <option value="100-200">100M - 200M</option>
                        <option value="200+">Above 200M</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Welcome to PropertyIntel Kigali!<br><br>
                        I'm your AI real estate advisor. Tap on any property to get instant insights about:
                        <br>• Hospital proximity (2km standard)
                        <br>• Property investment potential
                        <br>• Neighborhood analysis
                        <br>• Health facility accessibility
                        <br><br>
                        <strong>Tap a property marker to get started!</strong>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Select a property to enable chat..." rows="1" disabled aria-label="Ask about the selected property"></textarea>
                <button class="send-btn" id="sendBtn" disabled aria-label="Send message">Send Message</button>
            </div>
        </div>
        <div class="map-container">
            <button class="fullscreen-toggle" onclick="toggleFullscreenMap()" aria-label="Toggle fullscreen map">
                <i class="fas fa-expand"></i>
            </button>
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        let map, currentLocation, currentProperty, facilities = [], hospitalMarkers = [], hospitalCircles = [];
        let nearbyHospitals = [], currentLocationMarker = null, allPropertyMarkers = [], filteredProperties = [];
        let isSending = false;

        const properties = [
            { lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m²', yearBuilt: 2022, district: 'Nyarugenge' },
            { lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m²', yearBuilt: 2019, district: 'Nyarugenge' },
            { lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m²', yearBuilt: 2021, district: 'Gasabo' },
            { lat: -1.9256, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m²', yearBuilt: 2018, district: 'Gasabo' },
            { lat: -1.9316, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m²', yearBuilt: 2020, district: 'Gasabo' },
            { lat: -1.9634, lng: 30.1029, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m²', yearBuilt: 2017, district: 'Gasabo' },
            { lat: -1.9604, lng: 30.1059, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m²', yearBuilt: 2023, district: 'Gasabo' },
            { lat: -1.9664, lng: 30.0999, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m²', yearBuilt: 2019, district: 'Gasabo' },
            { lat: -1.9456, lng: 30.1312, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m²', yearBuilt: 2020, district: 'Gasabo' },
            { lat: -1.9486, lng: 30.1342, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m²', yearBuilt: 2021, district: 'Gasabo' },
            { lat: -1.9756, lng: 30.0529, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m²', yearBuilt: 2019, district: 'Kicukiro' },
            { lat: -1.9786, lng: 30.0559, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m²', yearBuilt: 2016, district: 'Kicukiro' },
            { lat: -1.9606, lng: 30.0429, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m²', yearBuilt: 2018, district: 'Nyarugenge' },
            { lat: -1.9636, lng: 30.0399, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m²', yearBuilt: 2017, district: 'Nyarugenge' },
            { lat: -1.9156, lng: 30.0819, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m²', yearBuilt: 2024, district: 'Gasabo' },
            { lat: -1.9186, lng: 30.0789, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m²', yearBuilt: 2022, district: 'Gasabo' },
            { lat: -1.9706, lng: 30.1159, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m²', yearBuilt: 2018, district: 'Gasabo' },
            { lat: -1.9736, lng: 30.1129, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m²', yearBuilt: 2019, district: 'Gasabo' },
            { lat: -1.9356, lng: 30.1212, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m²', yearBuilt: 2023, district: 'Gasabo' },
            { lat: -1.9386, lng: 30.1182, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m²', yearBuilt: 2021, district: 'Gasabo' }
        ];

        async function loadFacilities() {
            try {
                const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                const data = await response.json();
                
                if (data.features && Array.isArray(data.features)) {
                    facilities = data.features.filter(feature => 
                        feature.attributes && 
                        feature.attributes.lat && 
                        feature.attributes.long
                    ).map(feature => ({
                        facility_name: feature.attributes.facility_name || 'Unknown',
                        facility_type: feature.attributes.facility_type || 'Unknown',
                        lat: feature.attributes.lat,
                        long: feature.attributes.long,
                        district: feature.attributes.district || 'N/A',
                        sector: feature.attributes.sector || 'N/A',
                        ownership: feature.attributes.ownership || 'N/A',
                        opening_date: feature.attributes.opening_date || 'N/A'
                    }));
                    console.log('Loaded facilities from JSON:', facilities.length);
                } else {
                    throw new Error('Invalid JSON structure');
                }
            } catch (error) {
                console.error('Failed to load facilities:', error);
                facilities = [
                    { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo", sector: "Kacyiru" },
                    { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge", sector: "Nyarugenge" },
                    { facility_name: "Kacyiru DH", facility_type: "District Hospital", lat: -1.932984, long: 30.075489, district: "Gasabo", sector: "Kacyiru" },
                    { facility_name: "Kibagabaga Hospital", facility_type: "District Hospital", lat: -1.9308, long: 30.112, district: "Gasabo", sector: "Kimironko" },
                    { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro", sector: "Nyarugunga" },
                    { facility_name: "Muhima DH", facility_type: "District Hospital", lat: -1.9367, long: 30.0585, district: "Nyarugenge", sector: "Muhima" },
                    { facility_name: "Masaka District Hospital", facility_type: "District Hospital", lat: -1.99563, long: 30.1913, district: "Kicukiro", sector: "Masaka" }
                ];
                console.log('Using fallback facility data');
            }
        }

        function initializeMap() {
            map = L.map('map').setView([-1.9441, 30.0619], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                crossOrigin: true
            }).addTo(map);
            
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            addProperties();
            addHospitals();
            
            map.on('click', handleMapClick);
            
            new ResizeObserver(() => map.invalidateSize()).observe(document.getElementById('map'));
        }

        function addProperties() {
            allPropertyMarkers = [];
            filteredProperties = [...properties];
            const markerCluster = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${cluster.getChildCount()}</div>`,
                        className: 'marker-cluster',
                        iconSize: [40, 40]
                    });
                }
            });
            
            properties.forEach((prop, index) => {
                const isSpecial = prop.type.includes('Luxury') || prop.type.includes('Premium');
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${isSpecial ? 'special' : prop.status}`,
                        html: `<div style="width: 24px; height: 24px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                });
                
                marker.bindTooltip(
                    `<div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">${prop.name}</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="opacity: 0.9;">Price:</span>
                        <span style="font-weight: 600; color: #fff;">${prop.price}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="opacity: 0.9;">Size:</span>
                        <span>${prop.bedrooms}BR • ${prop.bathrooms}BA • ${prop.area}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="opacity: 0.9;">District:</span>
                        <span style="font-weight: 500;">${prop.district}</span>
                    </div>`, 
                    { 
                        direction: 'top', 
                        offset: [0, -15],
                        className: 'property-tooltip',
                        permanent: false,
                        sticky: true
                    }
                );
                
                marker.on('click', () => selectProperty(prop));
                markerCluster.addLayer(marker);
                
                allPropertyMarkers.push({
                    marker: marker,
                    property: prop,
                    visible: true
                });
            });
            
            map.addLayer(markerCluster);
            updateFilterSummary();
        }

        function addHospitals() {
            hospitalMarkers = [];
            console.log(`Loaded ${facilities.length} health facilities (markers will show when within 2km of properties)`);
        }

        function selectProperty(property) {
            currentProperty = property;
            currentLocation = L.latLng(property.lat, property.lng);
            
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            clearBuffers();
            analyzeHospitalProximity(property);
            generatePropertyInsights(property);
            map.setView([property.lat, property.lng], 15);
        }

        function analyzeHospitalProximity(property) {
            nearbyHospitals = [];
            hospitalMarkers.forEach(marker => map.removeLayer(marker));
            hospitalMarkers = [];
            hospitalCircles.forEach(circle => map.removeLayer(circle));
            hospitalCircles = [];
            
            facilities.forEach(facility => {
                const facilityType = facility.facility_type.toLowerCase();
                if (facilityType.includes('hospital') || 
                    facilityType.includes('health center') || 
                    facilityType.includes('clinic')) {
                    
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= 2) {
                        nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                        
                        const flashingCircle = L.circle([facility.lat, facility.long], {
                            radius: 100,
                            className: 'hospital-circle-flash',
                            fillOpacity: 0,
                            color: '#00ff88',
                            weight: 3
                        }).addTo(map);
                        
                        hospitalCircles.push(flashingCircle);
                        
                        const marker = L.marker([facility.lat, facility.long], {
                            icon: L.divIcon({
                                className: 'hospital-marker hospital-flash',
                                html: `<div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00ff88, #00cc6a); border: 3px solid white; border-radius: 50%;"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        marker.bindTooltip(
                            `<div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #fff;">
                                <i class="fas fa-hospital" style="margin-right: 6px; color: #00ff88;"></i>
                                ${facility.facility_name}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="opacity: 0.9;">Type:</span>
                                <span style="font-weight: 500;">${facility.facility_type}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="opacity: 0.9;">Distance:</span>
                                <span style="font-weight: 600; color: #00ff88;">${distance.toFixed(1)}km</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="opacity: 0.9;">District:</span>
                                <span>${facility.district || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="opacity: 0.9;">Sector:</span>
                                <span>${facility.sector || 'N/A'}</span>
                            </div>`, 
                            { 
                                direction: 'top', 
                                offset: [0, -15],
                                className: 'hospital-tooltip',
                                permanent: false,
                                sticky: true
                            }
                        );
                        
                        hospitalMarkers.push(marker);
                        
                        setTimeout(() => {
                            const markerElement = marker.getElement();
                            if (markerElement) {
                                markerElement.classList.remove('hospital-flash');
                            }
                            flashingCircle.setStyle({
                                className: '',
                                color: '#00ff88',
                                opacity: 0.3,
                                weight: 2
                            });
                        }, 10000);
                    }
                }
            });
            
            nearbyHospitals.sort((a, b) => a.distance - b.distance);
            console.log(`Found ${nearbyHospitals.length} health facilities within 2km of ${property.name}`);
            displayProximityAnalysis(property);
        }

        function displayProximityAnalysis(property) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            const statusClass = property.type.includes('Luxury') ? 'status-special' : 
                               property.status === 'sale' ? 'status-sale' : 'status-rent';
            
            messagesContainer.innerHTML += `
                <div class="location-info">
                    <strong>${property.name}</strong><br>
                    <strong>Type:</strong> ${property.type}<br>
                    <strong>Price:</strong> ${property.price}<br>
                    <strong>Details:</strong> ${property.bedrooms}BR • ${property.bathrooms}BA • ${property.area}<br>
                    <strong>Year Built:</strong> ${property.yearBuilt}<br>
                    <span class="${statusClass}">Status: ${property.status.charAt(0).toUpperCase() + property.status.slice(1)}</span>
                </div>`;
            
            if (nearbyHospitals.length > 0) {
                let hospitalHtml = `
                    <div class="hospital-proximity">
                        <strong>Hospital Proximity Analysis</strong><br>
                        <small>Standard: 2km accessibility radius</small>
                        <div class="hospital-list">`;
                
                nearbyHospitals.forEach(hospital => {
                    hospitalHtml += `
                        <div class="hospital-item" onclick="focusHospital(${hospital.lat}, ${hospital.long})">
                            <div>
                                <div class="hospital-name">${hospital.facility_name}</div>
                                <div style="font-size: 0.75rem; color: #999;">${hospital.facility_type}</div>
                            </div>
                            <div class="hospital-distance">${hospital.distance.toFixed(1)}km</div>
                        </div>`;
                });
                
                hospitalHtml += `</div></div>`;
                messagesContainer.innerHTML += hospitalHtml;
            } else {
                messagesContainer.innerHTML += `
                    <div class="hospital-proximity">
                        <strong>Hospital Proximity Alert</strong><br>
                        No hospitals within 2km accessibility radius.<br>
                        <small>Consider transportation accessibility for healthcare needs.</small>
                    </div>`;
            }
            
            scrollToBottom();
        }

        function generatePropertyInsights(property) {
            const messagesContainer = document.getElementById('chatMessages');
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                let insights = `
                    <div class="ai-insights">
                        <strong>AI Property Analysis</strong><br><br>`;
                
                if (nearbyHospitals.length > 0) {
                    insights += `<span class="insight-tag">Excellent Health Access</span>`;
                    insights += `<br>Good: ${nearbyHospitals.length} healthcare facilities within 2km radius<br>`;
                } else {
                    insights += `<span class="insight-tag">Health Access Concern</span>`;
                    insights += `<br>Alert: Limited healthcare accessibility - consider transportation needs<br>`;
                }
                
                if (property.type.includes('Luxury') || property.type.includes('Premium')) {
                    insights += `<span class="insight-tag">Premium Property</span>`;
                    insights += `<br>Premium: High-end property with excellent specifications<br>`;
                } else if (property.type === 'Apartment') {
                    insights += `<span class="insight-tag">Urban Living</span>`;
                    insights += `<br>Urban: City living with convenient amenities<br>`;
                } else {
                    insights += `<span class="insight-tag">Family Home</span>`;
                    insights += `<br>Family: Great for family living with privacy<br>`;
                }
                
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    insights += `<span class="insight-tag">High Value Investment</span>`;
                } else if (priceValue > 50) {
                    insights += `<span class="insight-tag">Mid-Range Investment</span>`;
                } else {
                    insights += `<span class="insight-tag">Entry Level Investment</span>`;
                }
                
                insights += `<br><br><strong>Ask me anything about this property!</strong></div>`;
                
                messagesContainer.innerHTML += insights;
                scrollToBottom();
            }, 2000);
        }

        function focusHospital(lat, lng) {
            map.setView([lat, lng], 17);
        }

        function clearBuffers() {
            hospitalMarkers.forEach(marker => map.removeLayer(marker));
            hospitalMarkers = [];
            hospitalCircles.forEach(circle => map.removeLayer(circle));
            hospitalCircles = [];
        }

        function handleMapClick(e) {
            clearBuffers();
            if (!currentProperty) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            Please tap on a property marker (colored circles) to get detailed analysis and proximity insights!
                        </div>
                    </div>`;
                scrollToBottom();
            }
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.classList.toggle('collapsed');
            document.querySelector('.toggle-chat-btn').textContent = chatContainer.classList.contains('collapsed') ? 'Expand Chat' : 'Collapse Chat';
            map.invalidateSize();
        }

        function toggleFullscreenMap() {
            const mapContainer = document.querySelector('.map-container');
            mapContainer.classList.toggle('fullscreen');
            document.querySelector('.fullscreen-toggle i').classList.toggle('fa-expand');
            document.querySelector('.fullscreen-toggle i').classList.toggle('fa-compress');
            map.invalidateSize();
        }

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const locationSearch = document.getElementById('locationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const locationBtn = document.getElementById('locationBtn');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priceFilter = document.getElementById('priceFilter');
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            locationSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') performLocationSearch();
            });
            
            searchBtn.addEventListener('click', performLocationSearch);
            locationBtn.addEventListener('click', useCurrentLocation);
            
            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            priceFilter.addEventListener('change', applyFilters);
        }

        async function performLocationSearch() {
            const locationSearch = document.getElementById('locationSearch');
            const location = locationSearch.value.trim();
            if (!location) return;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`, {
                    headers: { 'User-Agent': 'PropertyIntelKigali/1.0' }
                });
                const results = await response.json();
                
                if (results.length > 0) {
                    const { lat, lon } = results[0];
                    map.setView([lat, lon], 16);
                    
                    const searchMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'search-location-marker',
                            html: '<div style="width: 16px; height: 16px; background: #667eea; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    searchMarker.bindTooltip(
                        `<div style="font-weight: 600; color: #fff;">
                            <i class="fas fa-search" style="margin-right: 6px; color: #667eea;"></i>
                            Search Result
                        </div>
                        <div style="margin-top: 4px; opacity: 0.9;">${sanitizeHTML(location)}</div>`, 
                        { 
                            direction: 'top',
                            className: 'search-tooltip',
                            permanent: false
                        }
                    );
                    
                    setTimeout(() => {
                        map.removeLayer(searchMarker);
                    }, 5000);
                } else {
                    alert('Location not found in Kigali');
                }
            } catch (error) {
                console.error('Search failed:', error);
                alert('Search failed. Please try again.');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }
            
            const locationBtn = document.getElementById('locationBtn');
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            
            const KIGALI_BOUNDS = {
                latMin: -2.2,
                latMax: -1.7,
                lngMin: 29.8,
                lngMax: 30.3
            };
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude: lat, longitude: lng } = position.coords;
                    
                    if (lat < KIGALI_BOUNDS.latMin || lat > KIGALI_BOUNDS.latMax || lng < KIGALI_BOUNDS.lngMin || lng > KIGALI_BOUNDS.lngMax) {
                        alert('Your location appears to be outside Kigali area');
                        locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                        return;
                    }
                    
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div style="width: 16px; height: 16px; background: #ff4757; border: 3px solid white; border-radius: 50%;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);
                    
                    currentLocationMarker.bindTooltip(
                        `<div style="font-weight: 600; color: #fff;">
                            <i class="fas fa-crosshairs" style="margin-right: 6px; color: #ff4757;"></i>
                            Your Location
                        </div>
                        <div style="margin-top: 4px; opacity: 0.9; font-size: 11px;">
                            Tap nearby properties for analysis
                        </div>`, 
                        { 
                            direction: 'top', 
                            permanent: true,
                            className: 'location-tooltip'
                        }
                    );
                    
                    map.setView([lat, lng], 15);
                    
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML += `
                        <div class="message ai">
                            <div class="message-content">
                                Found your current location! The red pulsing marker shows where you are. Now tap on nearby properties to see proximity analysis.
                            </div>
                        </div>`;
                    scrollToBottom();
                    
                    locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                },
                error => {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location. Please check your browser settings.');
                    locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Use current location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            
            filteredProperties = properties.filter(property => {
                if (statusFilter && property.status !== statusFilter) return false;
                
                if (typeFilter) {
                    const propType = property.type.toLowerCase();
                    if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                    if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                    if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                    if (typeFilter === 'house' && !propType.includes('house')) return false;
                }
                
                if (priceFilter) {
                    const price = parseInt(property.price.replace(/[^0-9]/g, ''));
                    if (priceFilter === '0-50' && price >= 50) return false;
                    if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                    if (priceFilter === '100-200' && (price < 100 || price >= 200)) return false;
                    if (priceFilter === '200+' && price < 200) return false;
                }
                
                return true;
            });
            
            const markerCluster = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${cluster.getChildCount()}</div>`,
                        className: 'marker-cluster',
                        iconSize: [40, 40]
                    });
                }
            });
            
            allPropertyMarkers.forEach(markerObj => {
                const isVisible = filteredProperties.includes(markerObj.property);
                if (isVisible) {
                    markerCluster.addLayer(markerObj.marker);
                    markerObj.visible = true;
                } else {
                    map.removeLayer(markerObj.marker);
                    markerObj.visible = false;
                }
            });
            
            map.eachLayer(layer => {
                if (layer instanceof L.MarkerClusterGroup) {
                    map.removeLayer(layer);
                }
            });
            
            map.addLayer(markerCluster);
            updateFilterSummary();
        }

        function updateFilterSummary() {
            const filterSummary = document.getElementById('filterSummary');
            const total = properties.length;
            const shown = filteredProperties.length;
            
            if (shown === total) {
                filterSummary.textContent = `Showing all ${total} properties`;
            } else {
                filterSummary.textContent = `Showing ${shown} of ${total} properties`;
            }
        }

        function sendMessage() {
            if (isSending) return;
            isSending = true;
            
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || !currentProperty) {
                isSending = false;
                return;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `
                <div class="message user">
                    <div class="message-content">${sanitizeHTML(message)}</div>
                </div>`;
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                generateAIResponse(message, currentProperty);
                isSending = false;
            }, 1500);
            
            scrollToBottom();
        }

        function generateAIResponse(question, property) {
            const messagesContainer = document.getElementById('chatMessages');
            let response = '';
            
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                if (nearbyHospitals.length > 0) {
                    response = `Great question about healthcare access!<br><br>This property has excellent healthcare accessibility with ${nearbyHospitals.length} facilities within 2km:<br><br>`;
                    nearbyHospitals.slice(0, 3).forEach(h => {
                        response += `• <strong>${h.facility_name}</strong> (${h.facility_type}) - ${h.distance.toFixed(1)}km<br>`;
                    });
                    response += `<br>This significantly adds to the property's value and livability!`;
                } else {
                    response = `Healthcare accessibility is a concern for this property.<br><br>No hospitals within 2km radius. You'd need to consider:<br>• Private transportation<br>• Emergency response times<br>• Regular healthcare access<br><br>This might affect property value and family suitability.`;
                }
            } else if (lowerQuestion.includes('investment') || lowerQuestion.includes('value') || lowerQuestion.includes('profit')) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    response = `This is a premium investment opportunity!<br><br>At ${property.price}, you're looking at the luxury market segment. Key factors:<br>• High-end specifications (${property.area}, ${property.bedrooms}BR)<br>• ${nearbyHospitals.length > 0 ? 'Excellent healthcare access' : 'Limited healthcare access'}<br>• Built in ${property.yearBuilt} - relatively new<br><br>Expected appreciation: 8-12% annually for premium properties in Kigali.`;
                } else {
                    response = `Solid investment potential!<br><br>At ${property.price}, this offers good entry-level investment value:<br>• ${property.area} living space<br>• ${nearbyHospitals.length > 0 ? 'Good healthcare proximity' : 'Consider healthcare access'}<br>• ${property.yearBuilt} construction<br><br>Expected growth: 6-10% annually in this market segment.`;
                }
            } else if (lowerQuestion.includes('neighborhood') || lowerQuestion.includes('area') || lowerQuestion.includes('location')) {
                response = `Great location question!<br><br>This ${property.name} is strategically located in Kigali:<br><br>`;
                response += `Healthcare: ${nearbyHospitals.length} facilities within 2km${nearbyHospitals.length > 0 ? ' (Good)' : ' (Limited)'}<br>`;
                response += `Education: Multiple schools and universities nearby<br>`;
                response += `Shopping: Close to major shopping centers<br>`;
                response += `Transport: Well-connected road networks<br>`;
                response += `Environment: Clean, safe residential area<br><br>`;
                response += `The location significantly enhances property value and livability!`;
            } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('expensive') || lowerQuestion.includes('cheap')) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                const pricePerSqm = (priceValue * 1000000) / parseInt(property.area.replace(/[^0-9]/g, ''));
                response = `Let me break down the pricing for you!<br><br>`;
                response += `<strong>Listed Price:</strong> ${property.price}<br>`;
                response += `<strong>Price per m²:</strong> ${Math.round(pricePerSqm).toLocaleString()} RWF<br>`;
                response += `<strong>Property Size:</strong> ${property.area}<br><br>`;
                if (priceValue > 100) {
                    response += `This is <span class="insight-tag">Premium Pricing</span> for Kigali luxury market.<br>`;
                } else if (priceValue > 50) {
                    response += `This is <span class="insight-tag">Market Rate</span> for this property type.<br>`;
                } else {
                    response += `This is <span class="insight-tag">Competitive Pricing</span> for the area.<br>`;
                }
                response += `Healthcare accessibility ${nearbyHospitals.length > 0 ? 'adds 10-15% value premium' : 'may affect pricing negatively'}.`;
            } else if (lowerQuestion.includes('recommend') || lowerQuestion.includes('should i buy') || lowerQuestion.includes('good choice')) {
                response = `Based on my analysis, here's my recommendation:<br><br>`;
                let score = 0;
                let reasons = [];
                
                if (nearbyHospitals.length > 2) {
                    score += 30; 
                    reasons.push('Good: Excellent healthcare access');
                } else if (nearbyHospitals.length > 0) {
                    score += 20; 
                    reasons.push('Good: Healthcare access available');
                } else {
                    reasons.push('Alert: Limited healthcare access');
                }
                
                const age = 2025 - property.yearBuilt;
                if (age < 5) {
                    score += 25; 
                    reasons.push('Good: Modern construction');
                } else {
                    score += 15; 
                    reasons.push('Good: Established property');
                }
                
                if (property.bedrooms >= 4) {
                    score += 20; 
                    reasons.push('Good: Spacious for families');
                } else {
                    score += 15; 
                    reasons.push('Good: Appropriate size');
                }
                
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue <= 70) {
                    score += 25; 
                    reasons.push('Good: Competitive pricing');
                } else {
                    score += 15; 
                    reasons.push('Alert: Premium pricing');
                }
                
                reasons.forEach(reason => {
                    response += `${reason}<br>`;
                });
                
                response += `<br><strong>Overall Score: ${score}/100</strong><br><br>`;
                
                if (score >= 80) {
                    response += `<span class="insight-tag">Highly Recommended</span><br>This is an excellent choice! Strong fundamentals across all key metrics.`;
                } else if (score >= 60) {
                    response += `<span class="insight-tag">Recommended</span><br>Good investment opportunity with solid potential.`;
                } else {
                    response += `<span class="insight-tag">Consider Carefully</span><br>Some concerns to address before purchasing.`;
                }
            } else if (lowerQuestion.includes('transport') || lowerQuestion.includes('road') || lowerQuestion.includes('access')) {
                response = `Transportation and accessibility analysis!<br><br>`;
                response += `<strong>Road Network:</strong><br>`;
                response += `• Well-connected to main Kigali roads<br>`;
                response += `• ${nearbyHospitals.length > 0 ? 'Easy access to healthcare facilities' : 'May need private transport for healthcare'}<br>`;
                response += `• Public transport availability varies by area<br><br>`;
                response += `<strong>Accessibility Score:</strong> ${nearbyHospitals.length > 0 ? '8/10 Good' : '6/10 Moderate'}<br>`;
                response += `The location provides ${nearbyHospitals.length >
