
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Location Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --education: #8b5cf6;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-light: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        .chat-container {
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-light);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }
        
        .chat-container.collapsed {
            width: 60px;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        .app-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-bottom: 1px solid var(--glass-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .toggle-chat-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-chat-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }
        
        .filter-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-light);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.8rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        
        .filter-select option {
            background: var(--dark);
            color: #fff;
        }
        
        .filter-summary {
            margin-top: 8px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(15, 23, 42, 0.4);
            min-height: 150px;
            max-height: calc(100vh - 300px);
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px 16px 16px 4px;
            padding: 16px 18px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px 16px 4px 16px;
            padding: 16px 18px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 85%;
        }
        
        .chat-input-container {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--glass-light);
        }
        
        .chat-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .map-search-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .search-box {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
            min-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .location-btn, .home-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .location-btn:hover, .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .data-panels {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .data-panel {
            background: var(--glass);
            border: 1px solid var(--glass-light);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            min-width: 140px;
            max-width: 200px;
        }
        
        .panel-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .panel-subtitle {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .panel-breakdown {
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        .breakdown-sale {
            color: var(--danger);
            font-weight: 600;
        }
        
        .breakdown-rent {
            color: var(--success);
            font-weight: 600;
        }
        
        .breakdown-type {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .properties-panel .panel-title {
            color: var(--primary);
        }
        
        .property-marker {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
            opacity: 0.85;
            width: 60px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        .property-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            opacity: 1;
            z-index: 1000;
        }
        
        .property-marker.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            opacity: 1;
            z-index: 1001;
        }
        
        .property-marker.sale {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .property-marker.sale.selected {
            background: var(--danger);
            color: white;
        }
        
        .property-marker.sale::after {
            content: 'SALE';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.rent {
            border-color: var(--success);
            color: var(--success);
        }
        
        .property-marker.rent.selected {
            background: var(--success);
            color: white;
        }
        
        .property-marker.rent::after {
            content: 'RENT';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--success);
            color: white;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 3px;
            border-radius: 3px;
            line-height: 1;
        }
        
        .property-marker.luxury {
            border-color: var(--warning);
            color: var(--warning);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            background: linear-gradient(135deg, #fff, #fffbeb);
        }
        
        .property-marker.luxury.selected {
            background: var(--warning);
            color: white;
        }
        
        .property-marker.luxury::before {
            content: '‚≠ê';
            position: absolute;
            top: -6px;
            left: -6px;
            background: var(--warning);
            color: white;
            font-size: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .school-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--education);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .school-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        .hospital-marker {
            width: 28px !important;
            height: 28px !important;
            background: var(--success);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px;
            box-sizing: border-box !important;
        }
        
        .hospital-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }
        
        .property-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .proximity-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--success);
        }
        
        .education-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(124, 58, 237, 0.08));
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--education);
        }
        
        .facility-list {
            margin-top: 12px;
        }
        
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .facility-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        .facility-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .facility-distance {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .leaflet-tooltip.compact-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 6px !important;
            color: #ffffff !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            padding: 6px 8px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            max-width: 200px !important;
        }
        
        .leaflet-tooltip {
            background: var(--glass) !important;
            border: 1px solid var(--glass-light) !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-container {
                width: 100%;
                height: 45vh;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--glass-light);
            }
            
            .chat-container.collapsed {
                height: 60px;
            }
            
            .map-container {
                height: 55vh;
                order: 1;
            }
            
            .data-panels {
                flex-direction: column;
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }
            
            .data-panel {
                padding: 10px 12px;
                min-width: 120px;
                max-width: 160px;
            }
            
            .map-search-controls {
                top: 10px;
                right: 10px;
                left: unset;
                flex-direction: column;
                gap: 8px;
            }
            
            .search-box {
                min-width: unset;
            }
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .welcome-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 20px;
            color: var(--primary);
            font-style: italic;
            font-size: 0.85rem;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-indicator::before {
            content: 'AI analyzing';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: 'AI analyzing'; }
            40% { content: 'AI analyzing.'; }
            60% { content: 'AI analyzing..'; }
            80%, 100% { content: 'AI analyzing...'; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container" id="chatContainer">
            <div class="app-header">
                <div class="app-title">PropertyIntel Kigali</div>
                <button class="toggle-chat-btn" onclick="toggleChat()" aria-label="Toggle chat">
                    <i class="fas fa-chevron-left" id="toggleIcon"></i>
                </button>
            </div>
            
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Property Filters
                </div>
                <div class="filter-grid">
                    <select id="statusFilter" class="filter-select" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="sale">For Sale</option>
                        <option value="rent">For Rent</option>
                    </select>
                    
                    <select id="typeFilter" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="villa">Villa</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="luxury">Luxury</option>
                    </select>
                    
                    <select id="priceFilter" class="filter-select" aria-label="Filter by price">
                        <option value="">All Prices</option>
                        <option value="0-50">Under 50M RWF</option>
                        <option value="50-100">50M - 100M RWF</option>
                        <option value="100-200">100M - 200M RWF</option>
                        <option value="200+">Above 200M RWF</option>
                    </select>
                </div>
                
                <div class="filter-summary" id="filterSummary">
                    Showing all properties
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-title">Welcome to PropertyIntel!</div>
                        Your AI-powered real estate assistant for Kigali. Ask me about market trends, investment opportunities, or specific properties!
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask about Kigali real estate market, investment tips, or specific properties..." 
                              rows="1" aria-label="Ask about property"></textarea>
                    <button class="send-btn" id="sendBtn" aria-label="Send message">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div class="map-search-controls">
                <div class="search-box">
                    <input type="text" id="locationSearch" class="search-input" 
                           placeholder="Search location in Kigali..." aria-label="Search location">
                    <button id="searchBtn" class="search-btn" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button id="locationBtn" class="location-btn" aria-label="Use current location">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button id="homeBtn" class="home-btn" aria-label="Reset to home view">
                    <i class="fas fa-home"></i>
                </button>
            </div>
            
            <div class="data-panels">
                <div class="data-panel properties-panel">
                    <div class="panel-title">
                        <i class="fas fa-home"></i> Property Listings
                    </div>
                    <div class="panel-value" id="propertiesCount">20</div>
                    <div class="panel-subtitle">Available listings</div>
                    <div class="panel-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-sale">For Sale:</span>
                            <span id="forSaleCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-rent">For Rent:</span>
                            <span id="forRentCount">0</span>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0; padding-top: 4px;">
                            <div class="breakdown-item">
                                <span class="breakdown-type">Apartments:</span>
                                <span id="apartmentCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Houses:</span>
                                <span id="houseCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Villas:</span>
                                <span id="villaCount">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-type">Luxury:</span>
                                <span id="luxuryCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class PropertyIntelSystem {
            constructor() {
                this.map = null;
                this.currentProperty = null;
                this.selectedMarker = null;
                this.facilities = [];
                this.schools = [];
                this.propertyMarkers = [];
                this.hospitalMarkers = [];
                this.schoolMarkers = [];
                this.nearbyHospitals = [];
                this.nearbySchools = [];
                this.filteredProperties = [];
                this.isSending = false;
                
                this.properties = [
                    { id: 1, lat: -1.9441, lng: 30.0619, name: 'City Center Luxury Apartment', type: 'Luxury Apartment', price: '180M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '180m¬≤', yearBuilt: 2022, district: 'Nyarugenge', amenities: ['Pool', 'Gym', 'Security', 'Parking'] },
                    { id: 2, lat: -1.9506, lng: 30.0639, name: 'Business District Condo', type: 'Apartment', price: '65M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '110m¬≤', yearBuilt: 2019, district: 'Nyarugenge', amenities: ['Security', 'Parking'] },
                    { id: 3, lat: -1.9286, lng: 30.1044, name: 'Kimihurura Sunset Villa', type: 'Villa', price: '320M RWF', status: 'sale', bedrooms: 5, bathrooms: 4, area: '450m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Garden', 'Pool', 'Security', 'Garage'] },
                    { id: 4, lat: -1.9356, lng: 30.1074, name: 'Kimihurura Family House', type: 'House', price: '150M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '280m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 5, lat: -1.9416, lng: 30.1014, name: 'Kimihurura Modern Apartment', type: 'Apartment', price: '45M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '95m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Security', 'Balcony'] },
                    { id: 6, lat: -1.9634, lng: 30.0929, name: 'Kacyiru Green Hills House', type: 'House', price: '95M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '220m¬≤', yearBuilt: 2017, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 7, lat: -1.9604, lng: 30.0959, name: 'Kacyiru Executive Villa', type: 'Villa', price: '280M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '380m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Pool', 'Garden', 'Security', 'Smart Home'] },
                    { id: 8, lat: -1.9564, lng: 30.0899, name: 'Kacyiru Riverside Apartment', type: 'Apartment', price: '38M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '65m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['River View', 'Security'] },
                    { id: 9, lat: -1.9456, lng: 30.1212, name: 'Remera Shopping District House', type: 'House', price: '120M RWF', status: 'sale', bedrooms: 3, bathrooms: 3, area: '200m¬≤', yearBuilt: 2020, district: 'Gasabo', amenities: ['Parking', 'Security'] },
                    { id: 10, lat: -1.9486, lng: 30.1242, name: 'Remera Premium Apartment', type: 'Apartment', price: '55M RWF', status: 'rent', bedrooms: 2, bathrooms: 2, area: '130m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Gym', 'Security', 'Parking'] },
                    { id: 11, lat: -1.9756, lng: 30.0729, name: 'Gikondo Industrial Villa', type: 'Villa', price: '200M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '350m¬≤', yearBuilt: 2019, district: 'Kicukiro', amenities: ['Garden', 'Security', 'Workshop'] },
                    { id: 12, lat: -1.9686, lng: 30.0759, name: 'Gikondo Worker Housing', type: 'House', price: '75M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '160m¬≤', yearBuilt: 2016, district: 'Kicukiro', amenities: ['Parking'] },
                    { id: 13, lat: -1.9606, lng: 30.0529, name: 'Nyamirambo Cultural House', type: 'House', price: '85M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '190m¬≤', yearBuilt: 2018, district: 'Nyarugenge', amenities: ['Garden', 'Traditional Design'] },
                    { id: 14, lat: -1.9536, lng: 30.0499, name: 'Nyamirambo Traditional Villa', type: 'Villa', price: '140M RWF', status: 'sale', bedrooms: 4, bathrooms: 3, area: '260m¬≤', yearBuilt: 2017, district: 'Nyarugenge', amenities: ['Garden', 'Cultural Features'] },
                    { id: 15, lat: -1.9256, lng: 30.0919, name: 'Kigali Heights Luxury Villa', type: 'Luxury Villa', price: '450M RWF', status: 'sale', bedrooms: 6, bathrooms: 5, area: '600m¬≤', yearBuilt: 2024, district: 'Gasabo', amenities: ['Pool', 'Gym', 'Cinema', 'Smart Home', 'Wine Cellar'] },
                    { id: 16, lat: -1.9186, lng: 30.0889, name: 'Kigali Heights Executive House', type: 'House', price: '220M RWF', status: 'sale', bedrooms: 4, bathrooms: 4, area: '320m¬≤', yearBuilt: 2022, district: 'Gasabo', amenities: ['View', 'Security', 'Garden'] },
                    { id: 17, lat: -1.9706, lng: 30.1059, name: 'Kibagabaga Student Apartment', type: 'Apartment', price: '35M RWF', status: 'rent', bedrooms: 1, bathrooms: 1, area: '55m¬≤', yearBuilt: 2018, district: 'Gasabo', amenities: ['Study Area', 'Internet'] },
                    { id: 18, lat: -1.9636, lng: 30.1029, name: 'Kibagabaga Family House', type: 'House', price: '110M RWF', status: 'sale', bedrooms: 3, bathrooms: 2, area: '210m¬≤', yearBuilt: 2019, district: 'Gasabo', amenities: ['Garden', 'Parking'] },
                    { id: 19, lat: -1.9356, lng: 30.1112, name: 'Nyarutarama Golf Course Villa', type: 'Luxury Villa', price: '520M RWF', status: 'sale', bedrooms: 7, bathrooms: 6, area: '700m¬≤', yearBuilt: 2023, district: 'Gasabo', amenities: ['Golf Access', 'Pool', 'Tennis Court', 'Spa'] },
                    { id: 20, lat: -1.9286, lng: 30.1082, name: 'Nyarutarama Executive Apartment', type: 'Apartment', price: '75M RWF', status: 'rent', bedrooms: 3, bathrooms: 2, area: '150m¬≤', yearBuilt: 2021, district: 'Gasabo', amenities: ['Golf View', 'Security', 'Gym'] }
                ];
                
                this.init();
            }
            
            async init() {
                await this.loadFacilities();
                await this.loadSchools();
                this.initializeMap();
                this.setupEventListeners();
                this.updateStats();
            }
            
            async loadFacilities() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.facilities = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.lat && 
                            feature.attributes.long
                        ).map(feature => ({
                            facility_name: feature.attributes.facility_name || 'Unknown',
                            facility_type: feature.attributes.facility_type || 'Unknown',
                            lat: feature.attributes.lat,
                            long: feature.attributes.long,
                            district: feature.attributes.district || 'N/A',
                            sector: feature.attributes.sector || 'N/A',
                            ownership: feature.attributes.ownership || 'N/A'
                        }));
                        console.log('Loaded health facilities:', this.facilities.length);
                    }
                } catch (error) {
                    console.error('Failed to load facilities:', error);
                    this.facilities = [
                        { facility_name: "King Faisal Hospital", facility_type: "Referral Hospital", lat: -1.9439, long: 30.0951, district: "Gasabo" },
                        { facility_name: "CHUK", facility_type: "Referral Hospital", lat: -1.9565, long: 30.0604, district: "Nyarugenge" },
                        { facility_name: "Rwanda Military Hospital", facility_type: "Referral Hospital", lat: -1.9787, long: 30.1678, district: "Kicukiro" }
                    ];
                }
            }
            
            async loadSchools() {
                try {
                    const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Pre_Primary.json');
                    const data = await response.json();
                    
                    if (data.features && Array.isArray(data.features)) {
                        this.schools = data.features.filter(feature => 
                            feature.attributes && 
                            feature.attributes.latitude && 
                            feature.attributes.longitude
                        ).map(feature => ({
                            school_name: feature.attributes.school_nam || 'Unknown School',
                            school_type: feature.attributes.school_typ || 'Unknown',
                            school_category: feature.attributes.school_cat || 'PRE_PRIMARY',
                            school_status: feature.attributes.school_sta || 'Unknown',
                            curriculum: feature.attributes.curriculum || 'National',
                            lat: feature.attributes.latitude,
                            lng: feature.attributes.longitude,
                            established: feature.attributes.establishm || 'N/A'
                        }));
                        console.log('Loaded schools:', this.schools.length);
                    }
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    this.schools = [
                        { school_name: "ITETERO NURSERY SCHOOL", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9489, lng: 30.0000, established: 2009 },
                        { school_name: "Green Hills Academy", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "INTERNATIONAL", lat: -1.9556, lng: 30.1044, established: 2006 },
                        { school_name: "Kigali Parents School", school_type: "MIXED", school_category: "PRE_PRIMARY", school_status: "PRIVATE", curriculum: "NATIONAL", lat: -1.9386, lng: 30.0619, established: 2010 }
                    ];
                }
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-1.9441, 30.0619], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
                
                this.addProperties();
                this.prepareHospitals();
                this.prepareSchools();
                
                this.map.on('click', this.handleMapClick.bind(this));
                
                new ResizeObserver(() => this.map.invalidateSize()).observe(document.getElementById('map'));
            }
            
            addProperties() {
                this.propertyMarkers = [];
                this.filteredProperties = [...this.properties];
                
                this.properties.forEach((prop) => {
                    const isLuxury = prop.type.toLowerCase().includes('luxury');
                    const markerClass = `property-marker ${prop.status} ${isLuxury ? 'luxury' : ''}`;
                    
                    const priceLabel = prop.price.replace(' RWF', '').replace('M', '');
                    
                    const marker = L.marker([prop.lat, prop.lng], {
                        icon: L.divIcon({
                            className: markerClass,
                            html: priceLabel,
                            iconSize: [60, 24],
                            iconAnchor: [30, 24],
                            popupAnchor: [0, -24]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">${prop.name}</div>
                        <div style="margin-bottom: 2px; font-size: 12px;">üìç ${prop.district} ‚Ä¢ ${prop.bedrooms}BR</div>
                        <div style="font-weight: 600; color: #6366f1; font-size: 13px;">üí∞ ${prop.price}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -24],
                        permanent: false,
                        sticky: false,
                        className: 'compact-tooltip'
                    });
                    
                    marker.on('click', () => this.selectProperty(prop, marker));
                    marker.addTo(this.map);
                    
                    this.propertyMarkers.push({
                        marker: marker,
                        property: prop,
                        visible: true
                    });
                });
                
                this.updateFilterSummary();
            }
            
            prepareHospitals() {
                this.hospitalMarkers = [];
                this.facilities.forEach(facility => {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: 'üè•',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üè• ${facility.facility_name}</div>
                        <div style="margin-bottom: 2px;">üìã ${facility.facility_type}</div>
                        <div>üìç ${facility.district}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.hospitalMarkers.push(marker);
                });
            }
            
            prepareSchools() {
                this.schoolMarkers = [];
                this.schools.forEach(school => {
                    const marker = L.marker([school.lat, school.lng], {
                        icon: L.divIcon({
                            className: 'school-marker',
                            html: 'üéì',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14],
                            popupAnchor: [0, -14]
                        })
                    });
                    
                    const tooltipContent = `
                        <div style="font-weight: 600; margin-bottom: 4px;">üéì ${school.school_name}</div>
                        <div style="margin-bottom: 2px;">üìö ${school.school_status} School</div>
                        <div style="margin-bottom: 2px;">üìñ ${school.curriculum} Curriculum</div>
                        <div>üìÖ Est. ${school.established}</div>
                    `;
                    
                    marker.bindTooltip(tooltipContent, { 
                        direction: 'top', 
                        offset: [0, -15],
                        permanent: false,
                        sticky: true
                    });
                    
                    this.schoolMarkers.push(marker);
                });
            }
            
            selectProperty(property, marker) {
                if (this.selectedMarker) {
                    const prevElement = this.selectedMarker.getElement();
                    if (prevElement) {
                        prevElement.classList.remove('selected');
                    }
                }
                
                this.currentProperty = property;
                this.selectedMarker = marker;
                
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
                
                document.getElementById('chatInput').placeholder = `Ask about ${property.name}...`;
                
                this.analyzeProperty(property);
                this.map.setView([property.lat, property.lng], 15);
            }
            
            analyzeProperty(property) {
                this.clearNearbyMarkers();
                this.analyzeProximity(property);
                this.displayPropertyAnalysis(property);
                this.showNearbyFacilities(property);
            }
            
            clearNearbyMarkers() {
                this.hospitalMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                
                this.schoolMarkers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
            }
            
            showNearbyFacilities(property) {
                this.nearbyHospitals.forEach(hospital => {
                    const marker = this.hospitalMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - hospital.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - hospital.long) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
                
                this.nearbySchools.forEach(school => {
                    const marker = this.schoolMarkers.find(m => {
                        const markerLatLng = m.getLatLng();
                        return Math.abs(markerLatLng.lat - school.lat) < 0.0001 && 
                               Math.abs(markerLatLng.lng - school.lng) < 0.0001;
                    });
                    if (marker) {
                        marker.addTo(this.map);
                    }
                });
            }
            
            analyzeProximity(property) {
                this.nearbyHospitals = [];
                this.facilities.forEach(facility => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= 3) {
                        this.nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                    }
                });
                this.nearbyHospitals.sort((a, b) => a.distance - b.distance);
                
                this.nearbySchools = [];
                this.schools.forEach(school => {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([school.lat, school.lng]) / 1000;
                    
                    if (distance <= 2) {
                        this.nearbySchools.push({
                            ...school,
                            distance: distance
                        });
                    }
                });
                this.nearbySchools.sort((a, b) => a.distance - b.distance);
            }
            
            displayPropertyAnalysis(property) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                let propertyHtml = `
                    <div class="property-info">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">${property.name}</h3>
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> ${property.type}</div>
                        <div style="margin-bottom: 6px;"><strong>Price:</strong> ${property.price}</div>
                        <div style="margin-bottom: 6px;"><strong>Size:</strong> ${property.bedrooms}BR ‚Ä¢ ${property.bathrooms}BA ‚Ä¢ ${property.area}</div>
                        <div style="margin-bottom: 6px;"><strong>Built:</strong> ${property.yearBuilt}</div>
                        <div style="margin-bottom: 6px;"><strong>District:</strong> ${property.district}</div>
                        <div><strong>Amenities:</strong> ${property.amenities ? property.amenities.join(', ') : 'Standard'}</div>
                    </div>`;
                
                messagesContainer.innerHTML += propertyHtml;
                
                if (this.nearbySchools.length > 0) {
                    let schoolHtml = `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">üéì Education Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbySchools.length} schools within 2km</p>
                            <div class="facility-list">`;
                    
                    this.nearbySchools.slice(0, 5).forEach(school => {
                        schoolHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${school.lat}, ${school.lng})">
                                <div class="facility-name">${school.school_name}</div>
                                <div class="facility-distance">${(school.distance * 1000).toFixed(0)}m</div>
                            </div>`;
                    });
                    
                    schoolHtml += `</div></div>`;
                    messagesContainer.innerHTML += schoolHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="education-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Education Access</h4>
                            <p>No schools within 2km walking distance. Consider transportation needs for school-age children.</p>
                        </div>`;
                }
                
                if (this.nearbyHospitals.length > 0) {
                    let hospitalHtml = `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">üè• Healthcare Access</h4>
                            <p style="margin-bottom: 8px;">${this.nearbyHospitals.length} health facilities within 3km</p>
                            <div class="facility-list">`;
                    
                    this.nearbyHospitals.slice(0, 5).forEach(hospital => {
                        hospitalHtml += `
                            <div class="facility-item" onclick="propertyIntel.focusLocation(${hospital.lat}, ${hospital.long})">
                                <div class="facility-name">${hospital.facility_name}</div>
                                <div class="facility-distance">${hospital.distance.toFixed(1)}km</div>
                            </div>`;
                    });
                    
                    hospitalHtml += `</div></div>`;
                    messagesContainer.innerHTML += hospitalHtml;
                } else {
                    messagesContainer.innerHTML += `
                        <div class="proximity-info">
                            <h4 style="margin-bottom: 8px;">‚ö†Ô∏è Healthcare Access</h4>
                            <p>No hospitals within 3km radius. Emergency services may take longer to reach this location.</p>
                        </div>`;
                }
                
                this.scrollToBottom();
            }
            
            focusLocation(lat, lng) {
                this.map.setView([lat, lng], 16);
            }
            
            resetToHomeView() {
                this.map.setView([-1.9441, 30.0619], 11);
            }
            
            handleMapClick(e) {
                this.clearNearbyMarkers();
                
                if (!this.currentProperty) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-title">Welcome to PropertyIntel!</div>
                            Your AI-powered real estate assistant for Kigali. Ask me about market trends, investment opportunities, or specific properties!
                        </div>`;
                }
            }
            
            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const locationSearch = document.getElementById('locationSearch');
                const searchBtn = document.getElementById('searchBtn');
                const locationBtn = document.getElementById('locationBtn');
                const homeBtn = document.getElementById('homeBtn');
                const statusFilter = document.getElementById('statusFilter');
                const typeFilter = document.getElementById('typeFilter');
                const priceFilter = document.getElementById('priceFilter');
                
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                
                locationSearch.addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.performLocationSearch();
                });
                
                searchBtn.addEventListener('click', () => this.performLocationSearch());
                locationBtn.addEventListener('click', () => this.useCurrentLocation());
                homeBtn.addEventListener('click', () => this.resetToHomeView());
                
                statusFilter.addEventListener('change', () => this.applyFilters());
                typeFilter.addEventListener('change', () => this.applyFilters());
                priceFilter.addEventListener('change', () => this.applyFilters());
            }
            
            async performLocationSearch() {
                const locationSearch = document.getElementById('locationSearch');
                const location = locationSearch.value.trim();
                if (!location) return;
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Kigali, Rwanda')}&limit=1`);
                    const results = await response.json();
                    
                    if (results.length > 0) {
                        const { lat, lon } = results[0];
                        this.map.setView([lat, lon], 16);
                    } else {
                        alert('Location not found in Kigali');
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    alert('Search failed. Please try again.');
                }
            }
            
            useCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported by this browser');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        this.map.setView([lat, lng], 15);
                    },
                    error => {
                        alert('Unable to get your location');
                    }
                );
            }
            
            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const priceFilter = document.getElementById('priceFilter').value;
                
                this.filteredProperties = this.properties.filter(property => {
                    if (statusFilter && property.status !== statusFilter) return false;
                    
                    if (typeFilter) {
                        const propType = property.type.toLowerCase();
                        if (typeFilter === 'luxury' && !propType.includes('luxury')) return false;
                        if (typeFilter === 'villa' && !propType.includes('villa')) return false;
                        if (typeFilter === 'apartment' && !propType.includes('apartment')) return false;
                        if (typeFilter === 'house' && !propType.includes('house')) return false;
                    }
                    
                    if (priceFilter) {
                        const price = parseInt(property.price.replace(/[^0-9]/g, ''));
                        if (priceFilter === '0-50' && price >= 50) return false;
                        if (priceFilter === '50-100' && (price < 50 || price >= 100)) return false;
                        if (priceFilter === '100-200' && (price < 100 || price >= 200)) return false;
                        if (priceFilter === '200+' && price < 200) return false;
                    }
                    
                    return true;
                });
                
                this.updatePropertyVisibility();
                this.updateFilterSummary();
                this.updateStats();
            }
            
            updatePropertyVisibility() {
                this.propertyMarkers.forEach(item => {
                    const isVisible = this.filteredProperties.includes(item.property);
                    if (isVisible && !item.visible) {
                        item.marker.addTo(this.map);
                        item.visible = true;
                    } else if (!isVisible && item.visible) {
                        this.map.removeLayer(item.marker);
                        item.visible = false;
                    }
                });
            }
            
            updateFilterSummary() {
                const filterSummary = document.getElementById('filterSummary');
                const total = this.properties.length;
                const shown = this.filteredProperties.length;
                
                filterSummary.textContent = shown === total ? 
                    `Showing all ${total} properties` : 
                    `Showing ${shown} of ${total} properties`;
            }
            
            updateStats() {
                const forSale = this.filteredProperties.filter(p => p.status === 'sale').length;
                const forRent = this.filteredProperties.filter(p => p.status === 'rent').length;
                
                const apartments = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('apartment')).length;
                const houses = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('house')).length;
                const villas = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('villa') && !p.type.toLowerCase().includes('luxury')).length;
                const luxury = this.filteredProperties.filter(p => 
                    p.type.toLowerCase().includes('luxury')).length;
                
                document.getElementById('propertiesCount').textContent = this.filteredProperties.length;
                document.getElementById('forSaleCount').textContent = forSale;
                document.getElementById('forRentCount').textContent = forRent;
                document.getElementById('apartmentCount').textContent = apartments;
                document.getElementById('houseCount').textContent = houses;
                document.getElementById('villaCount').textContent = villas;
                document.getElementById('luxuryCount').textContent = luxury;
            }
            
            sendMessage() {
                if (this.isSending) return;
                this.isSending = true;
                
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (!message) {
                    this.isSending = false;
                    return;
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="message user">
                        <div class="message-content">${this.sanitizeHTML(message)}</div>
                    </div>`;
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.generateAIResponse(message);
                    this.isSending = false;
                }, 1500);
                
                this.scrollToBottom();
            }
            
            generateAIResponse(question) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                
                const lowerQuestion = question.toLowerCase();
                
                // Enhanced AI responses for real estate enthusiasts
                if (lowerQuestion.includes('market') || lowerQuestion.includes('trend')) {
                    response = this.generateMarketAnalysis();
                } else if (lowerQuestion.includes('investment') || lowerQuestion.includes('roi') || lowerQuestion.includes('return')) {
                    response = this.generateInvestmentAdvice();
                } else if (lowerQuestion.includes('district') || lowerQuestion.includes('area') || lowerQuestion.includes('neighborhood')) {
                    response = this.generateDistrictAnalysis();
                } else if (lowerQuestion.includes('luxury') || lowerQuestion.includes('premium')) {
                    response = this.generateLuxuryMarketInsight();
                } else if (lowerQuestion.includes('rental') || lowerQuestion.includes('rent')) {
                    response = this.generateRentalMarketAnalysis();
                } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('value')) {
                    response = this.currentProperty ? this.generatePriceResponse(this.currentProperty) : this.generatePricingInsights();
                } else if (lowerQuestion.includes('school') || lowerQuestion.includes('education')) {
                    response = this.currentProperty ? this.generateSchoolResponse(this.currentProperty) : this.generateEducationInsights();
                } else if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                    response = this.currentProperty ? this.generateHealthResponse(this.currentProperty) : this.generateHealthcareInsights();
                } else if (lowerQuestion.includes('family') || lowerQuestion.includes('children')) {
                    response = this.currentProperty ? this.generateFamilyResponse(this.currentProperty) : this.generateFamilyLivingInsights();
                } else if (lowerQuestion.includes('developer') || lowerQuestion.includes('construction')) {
                    response = this.generateDevelopmentInsights();
                } else if (lowerQuestion.includes('infrastructure') || lowerQuestion.includes('transport')) {
                    response = this.generateInfrastructureInsights();
                } else {
                    response = this.currentProperty ? this.generateGeneralResponse(this.currentProperty) : this.generateGeneralMarketResponse();
                }
                
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                
                this.scrollToBottom();
            }
            
            generateMarketAnalysis() {
                return `<h4>üìà Kigali Real Estate Market Analysis</h4><br>
                
                <strong>Current Market Overview (2025):</strong><br>
                ‚Ä¢ Market shows strong growth with 12-15% annual appreciation<br>
                ‚Ä¢ Foreign investment increasing, especially in luxury segment<br>
                ‚Ä¢ New infrastructure projects driving demand in Gasabo district<br><br>
                
                <strong>Hot Districts:</strong><br>
                üî• <strong>Gasabo:</strong> Premium locations like Nyarutarama, Kimihurura<br>
                üè¢ <strong>Nyarugenge:</strong> CBD proximity, business district appeal<br>
                üè≠ <strong>Kicukiro:</strong> Industrial growth, affordable housing<br><br>
                
                <strong>Price Trends:</strong><br>
                ‚Ä¢ Luxury villas: 300M - 600M RWF (high demand)<br>
                ‚Ä¢ Executive houses: 150M - 300M RWF (steady growth)<br>
                ‚Ä¢ Apartments: 35M - 180M RWF (rental yields 6-8%)<br><br>
                
                <strong>Investment Outlook:</strong><br>
                Strong fundamentals with Rwanda's economic growth, urbanization, and Vision 2050 driving long-term demand. Best opportunities in mixed-use developments and rental properties near business hubs.`;
            }
            
            generateInvestmentAdvice() {
                return `<h4>üíº Investment Strategy for Kigali Real Estate</h4><br>
                
                <strong>Top Investment Strategies:</strong><br>
                üéØ <strong>Buy-to-Let:</strong> Target young professionals, expats<br>
                üèóÔ∏è <strong>Off-Plan Purchases:</strong> 15-20% discounts, payment plans<br>
                üìç <strong>Location Arbitrage:</strong> Emerging areas before infrastructure<br><br>
                
                <strong>ROI Expectations:</strong><br>
                ‚Ä¢ Rental Yield: 6-8% annually<br>
                ‚Ä¢ Capital Appreciation: 12-15% per year<br>
                ‚Ä¢ Total Return: 18-23% potential<br><br>
                
                <strong>Smart Investment Zones:</strong><br>
                üåü <strong>Kimihurura:</strong> Established, expat community<br>
                üöÄ <strong>Kacyiru:</strong> Government offices, growing demand<br>
                üíé <strong>Nyarutarama:</strong> Ultra-luxury, limited supply<br>
                ‚ö° <strong>Remera:</strong> Shopping, transport hub<br><br>
                
                <strong>Risk Factors:</strong><br>
                ‚Ä¢ Currency fluctuation (USD vs RWF)<br>
                ‚Ä¢ Oversupply in luxury segment<br>
                ‚Ä¢ Regulatory changes in foreign ownership<br><br>
                
                <strong>Due Diligence Tips:</strong><br>
                ‚úÖ Verify land titles with Rwanda Development Board<br>
                ‚úÖ Check infrastructure development plans<br>
                ‚úÖ Analyze rental comparables in 500m radius<br>
                ‚úÖ Factor in maintenance and management costs`;
            }
            
            generateDistrictAnalysis() {
                return `<h4>üèòÔ∏è Kigali District Investment Guide</h4><br>
                
                <strong>GASABO DISTRICT</strong> - Premium Investment Zone<br>
                üí∞ Price Range: 45M - 600M RWF<br>
                üìà Growth Rate: 15-18% annually<br>
                üéØ Target: Executives, expats, luxury buyers<br>
                Key Areas: Nyarutarama (ultra-luxury), Kimihurura (family-friendly), Kacyiru (government sector)<br><br>
                
                <strong>NYARUGENGE DISTRICT</strong> - Business Hub<br>
                üí∞ Price Range: 35M - 180M RWF<br>
                üìà Growth Rate: 10-12% annually<br>
                üéØ Target: Business owners, young professionals<br>
                Key Areas: City Center (CBD proximity), Nyamirambo (cultural significance)<br><br>
                
                <strong>KICUKIRO DISTRICT</strong> - Emerging Value<br>
                üí∞ Price Range: 35M - 200M RWF<br>
                üìà Growth Rate: 12-15% annually<br>
                üéØ Target: Industrial workers, first-time buyers<br>
                Key Areas: Gikondo (industrial), Kibagabaga (university area)<br><br>
                
                <strong>Investment Recommendations:</strong><br>
                üèÜ <strong>Best Overall:</strong> Gasabo (established, high appreciation)<br>
                üí∏ <strong>Best Value:</strong> Kicukiro (affordable entry point)<br>
                üè¢ <strong>Best Rental:</strong> Nyarugenge (business district demand)<br>
                üöÄ <strong>Best Growth:</strong> Gasabo periphery (infrastructure development)`;
            }
            
            generateLuxuryMarketInsight() {
                return `<h4>üëë Luxury Real Estate Market in Kigali</h4><br>
                
                <strong>Luxury Market Dynamics:</strong><br>
                ‚Ä¢ Ultra-high-end: 400M+ RWF (limited inventory)<br>
                ‚Ä¢ High-end: 200M - 400M RWF (growing segment)<br>
                ‚Ä¢ Premium: 100M - 200M RWF (most active)<br><br>
                
                <strong>Luxury Hotspots:</strong><br>
                üèåÔ∏è <strong>Nyarutarama:</strong> Golf course access, diplomatic community<br>
                üåÖ <strong>Kigali Heights:</strong> Panoramic views, gated community<br>
                üèñÔ∏è <strong>Kimihurura:</strong> Established luxury, family compounds<br><br>
                
                <strong>Luxury Features in Demand:</strong><br>
                ‚Ä¢ Smart home technology and automation<br>
                ‚Ä¢ Private pools and spa facilities<br>
                ‚Ä¢ Wine cellars and entertainment rooms<br>
                ‚Ä¢ Multi-car garages and staff quarters<br>
                ‚Ä¢ 24/7 security and gated access<br><br>
                
                <strong>Market Insights:</strong><br>
                üìä Luxury segment represents 15% of total sales<br>
                üíº 80% buyers are business executives or diplomats<br>
                üåç 40% are foreign nationals or diaspora<br>
                ‚è±Ô∏è Average time on market: 3-6 months<br><br>
                
                <strong>Investment Potential:</strong><br>
                ‚Ä¢ Strong appreciation in prime locations (20%+ annually)<br>
                ‚Ä¢ Limited supply maintaining price stability<br>
                ‚Ä¢ High-end rental yields: 4-6% but strong capital gains<br>
                ‚Ä¢ Trophy asset appeal for wealth preservation`;
            }
            
            generateRentalMarketAnalysis() {
                return `<h4>üè† Rental Market Intelligence - Kigali</h4><br>
                
                <strong>Rental Yield Analysis:</strong><br>
                üè¢ <strong>Apartments:</strong> 6-8% annual yield<br>
                üèòÔ∏è <strong>Houses:</strong> 5-7% annual yield<br>
                üè∞ <strong>Villas:</strong> 4-6% annual yield<br><br>
                
                <strong>High-Demand Rental Areas:</strong><br>
                üíº <strong>Kacyiru:</strong> Government employees, stable tenants<br>
                üéì <strong>Kimihurura:</strong> Expat families, international schools<br>
                üè¢ <strong>City Center:</strong> Business professionals, short commutes<br>
                üìö <strong>Remera:</strong> Shopping access, transport links<br><br>
                
                <strong>Tenant Profiles:</strong><br>
                ‚Ä¢ Young professionals (25-35): 1-2BR apartments<br>
                ‚Ä¢ Expat families (30-45): 3-4BR houses with gardens<br>
                ‚Ä¢ Business executives (35-50): Luxury apartments/villas<br>
                ‚Ä¢ Students/interns (20-30): Shared accommodations<br><br>
                
                <strong>Rental Rate Ranges (Monthly):</strong><br>
                ‚Ä¢ 1BR Apartment: 300K - 600K RWF<br>
                ‚Ä¢ 2BR Apartment: 500K - 900K RWF<br>
                ‚Ä¢ 3BR House: 800K - 1.5M RWF<br>
                ‚Ä¢ 4BR Villa: 1.2M - 3M RWF<br><br>
                
                <strong>Landlord Tips:</strong><br>
                ‚úÖ Furnish properties for higher yields (+20-30%)<br>
                ‚úÖ Include utilities in rent for convenience<br>
                ‚úÖ Target corporate clients for stability<br>
                ‚úÖ Maintain properties proactively<br>
                ‚úÖ Use professional property management`;
            }
            
            generatePricingInsights() {
                return `<h4>üí∞ Kigali Property Pricing Intelligence</h4><br>
                
                <strong>Price Per Square Meter Analysis:</strong><br>
                üè¢ <strong>Apartments:</strong> 800K - 1.2M RWF/m¬≤<br>
                üèòÔ∏è <strong>Houses:</strong> 600K - 1M RWF/m¬≤<br>
                üè∞ <strong>Villas:</strong> 1M - 1.8M RWF/m¬≤<br><br>
                
                <strong>Price Drivers:</strong><br>
                üìç <strong>Location:</strong> 30-40% impact on pricing<br>
                üèóÔ∏è <strong>Build Quality:</strong> 20-25% price variation<br>
                üéØ <strong>Amenities:</strong> 15-20% premium for luxury features<br>
                üìÖ <strong>Age:</strong> 10-15% depreciation for older properties<br><br>
                
                <strong>Negotiation Insights:</strong><br>
                ‚Ä¢ Properties on market >6 months: 5-10% negotiable<br>
                ‚Ä¢ Cash purchases: 3-7% discount potential<br>
                ‚Ä¢ Off-season timing (Jan-Mar): Better deals<br>
                ‚Ä¢ Multiple property purchases: Volume discounts<br><br>
                
                <strong>Value-Add Opportunities:</strong><br>
                üîß <strong>Renovations:</strong> 20-30% value increase potential<br>
                üåä <strong>Pool Addition:</strong> 15-25% premium<br>
                üîí <strong>Security Upgrades:</strong> 10-15% value boost<br>
                üå± <strong>Landscaping:</strong> 5-12% aesthetic value<br><br>
                
                <strong>Price Forecast (2025-2027):</strong><br>
                ‚Ä¢ Continued 12-15% annual appreciation expected<br>
                ‚Ä¢ Infrastructure projects driving growth<br>
                ‚Ä¢ Foreign investment maintaining momentum<br>
                ‚Ä¢ Supply constraints in prime locations`;
            }
            
            generateEducationInsights() {
                return `<h4>üéì Education Infrastructure Analysis</h4><br>
                
                <strong>School Distribution in Kigali:</strong><br>
                üìö <strong>International Schools:</strong> Primarily in Gasabo district<br>
                üè´ <strong>Private Schools:</strong> Well-distributed across all districts<br>
                üéí <strong>Public Schools:</strong> Available in all neighborhoods<br><br>
                
                <strong>Top-Rated International Schools:</strong><br>
                ‚Ä¢ Green Hills Academy (Nyarutarama)<br>
                ‚Ä¢ Kigali International School (Kimihurura)<br>
                ‚Ä¢ Ecole Belge (Kacyiru)<br>
                ‚Ä¢ American International School<br><br>
                
                <strong>Impact on Property Values:</strong><br>
                üìà Properties within 1km of top schools: +15-25% premium<br>
                üöå School transport routes: +8-12% value addition<br>
                üè´ New school developments: 20%+ appreciation potential<br><br>
                
                <strong>Family Investment Strategy:</strong><br>
                ‚Ä¢ Target areas with multiple school options<br>
                ‚Ä¢ Consider future family expansion needs<br>
                ‚Ä¢ Factor in school fees vs property costs<br>
                ‚Ä¢ International curriculum access for expat appeal<br><br>
                
                <strong>Educational Investment Hotspots:</strong><br>
                üéØ <strong>Kimihurura:</strong> Multiple international schools<br>
                üéØ <strong>Nyarutarama:</strong> Premium education cluster<br>
                üéØ <strong>Kacyiru:</strong> Growing educational infrastructure<br>
                üéØ <strong>Remera:</strong> Emerging school developments`;
            }
            
            generateHealthcareInsights() {
                return `<h4>üè• Healthcare Infrastructure & Property Impact</h4><br>
                
                <strong>Major Healthcare Facilities:</strong><br>
                üè• <strong>King Faisal Hospital:</strong> Premier private facility<br>
                üè• <strong>CHUK:</strong> Main public teaching hospital<br>
                üè• <strong>Rwanda Military Hospital:</strong> Specialized care<br>
                üè• <strong>Clinic facilities:</strong> Distributed across districts<br><br>
                
                <strong>Healthcare Access Impact:</strong><br>
                üìç Properties within 2km of major hospitals: +10-15% premium<br>
                üöë Emergency response time factor in luxury segments<br>
                üë®‚Äç‚öïÔ∏è Medical professionals prefer healthcare proximity<br><br>
                
                <strong>Investment Considerations:</strong><br>
                ‚Ä¢ Aging expat population increasing healthcare demand<br>
                ‚Ä¢ Medical tourism growing in Rwanda<br>
                ‚Ä¢ Private healthcare expansion planned<br>
                ‚Ä¢ Properties near medical facilities have stable rental demand<br><br>
                
                <strong>Health-Conscious Buyer Trends:</strong><br>
                üèÉ‚Äç‚ôÇÔ∏è Properties with fitness amenities<br>
                üå± Clean air and low pollution areas<br>
                üíß Water quality and reliable utilities<br>
                üö∂‚Äç‚ôÄÔ∏è Walkable neighborhoods for active lifestyle<br><br>
                
                <strong>Future Healthcare Developments:</strong><br>
                ‚Ä¢ New medical centers planned in Gasabo<br>
                ‚Ä¢ Telemedicine infrastructure improving<br>
                ‚Ä¢ Specialized care facilities expanding<br>
                ‚Ä¢ Medical insurance market growing`;
            }
            
            generateFamilyLivingInsights() {
                return `<h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family-Friendly Living in Kigali</h4><br>
                
                <strong>Family Property Preferences:</strong><br>
                üè† <strong>3-4 Bedrooms:</strong> Most popular for growing families<br>
                üå≥ <strong>Garden Space:</strong> 80% of families prioritize outdoor areas<br>
                üöó <strong>Parking:</strong> Multi-car households standard<br>
                üîí <strong>Security:</strong> Gated communities preferred<br><br>
                
                <strong>Family-Friendly Districts Ranking:</strong><br>
                ü•á <strong>Kimihurura:</strong> Schools, parks, expat community<br>
                ü•à <strong>Nyarutarama:</strong> Luxury amenities, safe environment<br>
                ü•â <strong>Kacyiru:</strong> Government sector, stable community<br>
                4Ô∏è‚É£ <strong>Remera:</strong> Shopping, entertainment options<br><br>
                
                <strong>Child-Friendly Amenities:</strong><br>
                üèä‚Äç‚ôÄÔ∏è Swimming pools and recreational facilities<br>
                üéÆ Playgrounds and safe outdoor spaces<br>
                üõ°Ô∏è 24/7 security and controlled access<br>
                üöå School transport accessibility<br>
                üè• Healthcare facilities proximity<br><br>
                
                <strong>Family Investment Tips:</strong><br>
                ‚Ä¢ Larger properties hold value better<br>
                ‚Ä¢ Community amenities add rental appeal<br>
                ‚Ä¢ Consider future schooling needs<br>
                ‚Ä¢ Factor in household help accommodation<br>
                ‚Ä¢ Plan for teenage privacy requirements<br><br>
                
                <strong>Cost Considerations for Families:</strong><br>
                ‚Ä¢ Larger utility bills for family homes<br>
                ‚Ä¢ Security and maintenance costs<br>
                ‚Ä¢ School fees and transport<br>
                ‚Ä¢ Domestic help and gardening<br>
                ‚Ä¢ Community fees for gated developments`;
            }
            
            generateDevelopmentInsights() {
                return `<h4>üèóÔ∏è Development & Construction Market Insights</h4><br>
                
                <strong>Active Development Areas:</strong><br>
                üöß <strong>Kigali Heights:</strong> Luxury hillside development<br>
                üöß <strong>Vision City:</strong> Integrated mixed-use project<br>
                üöß <strong>Green City Kigali:</strong> Sustainable urban development<br>
                üöß <strong>Gacuriro:</strong> Emerging residential area<br><br>
                
                <strong>Construction Quality Standards:</strong><br>
                üèóÔ∏è International building codes adopted<br>
                üå± Green building certifications growing<br>
                üîß Modern materials and techniques<br>
                ‚ö° Smart home integration standard in luxury<br><br>
                
                <strong>Key Developers to Watch:</strong><br>
                ‚Ä¢ Prime Holdings Rwanda<br>
                ‚Ä¢ Horizon Construction Group<br>
                ‚Ä¢ Kigali Green City Development<br>
                ‚Ä¢ Various international partnerships<br><br>
                
                <strong>Off-Plan Investment Opportunities:</strong><br>
                üí∞ 15-20% discounts vs completed properties<br>
                üìÖ Flexible payment plans available<br>
                üéØ Choose prime locations early<br>
                ‚ö†Ô∏è Developer track record crucial<br><br>
                
                <strong>Construction Timeline Considerations:</strong><br>
                ‚Ä¢ Standard homes: 12-18 months<br>
                ‚Ä¢ Luxury villas: 18-24 months<br>
                ‚Ä¢ Apartment complexes: 24-36 months<br>
                ‚Ä¢ Infrastructure can cause delays<br><br>
                
                <strong>Quality Control Tips:</strong><br>
                ‚úÖ Regular site inspections<br>
                ‚úÖ Material quality verification<br>
                ‚úÖ Completion milestone payments<br>
                ‚úÖ Professional snagging surveys<br>
                ‚úÖ Warranty and aftercare services`;
            }
            
            generateInfrastructureInsights() {
                return `<h4>üõ£Ô∏è Infrastructure Development Impact</h4><br>
                
                <strong>Major Infrastructure Projects:</strong><br>
                üöÑ <strong>Bus Rapid Transit:</strong> Connecting all districts<br>
                ‚úàÔ∏è <strong>Airport Expansion:</strong> International connectivity<br>
                üõ£Ô∏è <strong>Road Networks:</strong> Ongoing upgrades citywide<br>
                üí° <strong>Smart City Initiative:</strong> Digital infrastructure<br><br>
                
                <strong>Transport Infrastructure Impact:</strong><br>
                üìà Properties near BRT routes: +20-30% value increase<br>
                üöó Improved road access: +15-25% appreciation<br>
                ‚úàÔ∏è Airport proximity: Commercial and luxury demand<br>
                üö∂‚Äç‚ôÄÔ∏è Walkability projects: Community value addition<br><br>
                
                <strong>Utility Infrastructure:</strong><br>
                ‚ö° Reliable electricity: 98% coverage achieved<br>
                üíß Clean water access: Expanding to all areas<br>
                üì° Fiber optic internet: High-speed connectivity<br>
                üóëÔ∏è Waste management: Modern systems implemented<br><br>
                
                <strong>Smart City Features:</strong><br>
                üì± Digital payment systems integration<br>
                üö¶ Traffic management technology<br>
                üîí CCTV security networks<br>
                üåê Public WiFi expansion<br><br>
                
                <strong>Investment Strategy by Infrastructure:</strong><br>
                üéØ Target areas with planned improvements<br>
                ‚è∞ Buy before infrastructure completion<br>
                üîç Monitor government development plans<br>
                üìä Analyze connectivity improvements<br><br>
                
                <strong>Future Infrastructure Plans:</strong><br>
                ‚Ä¢ Light rail system feasibility studies<br>
                ‚Ä¢ Green energy grid expansion<br>
                ‚Ä¢ Digital government services<br>
                ‚Ä¢ Regional connectivity improvements`;
            }
            
            generateGeneralMarketResponse() {
                return `<h4>üè† Your Kigali Real Estate Assistant</h4><br>
                
                I'm here to help you navigate Kigali's dynamic property market! As your AI real estate expert, I can provide insights on:<br><br>
                
                <strong>Market Intelligence:</strong><br>
                üìà Current market trends and pricing analysis<br>
                üíº Investment opportunities and ROI projections<br>
                üèòÔ∏è District comparisons and neighborhood profiles<br>
                üèóÔ∏è Development projects and their impact<br><br>
                
                <strong>Property Analysis:</strong><br>
                üéØ Specific property evaluations<br>
                üè´ School and healthcare proximity<br>
                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family-friendly location assessment<br>
                üíé Luxury market insights<br><br>
                
                <strong>Investment Guidance:</strong><br>
                üí∞ Financing options and strategies<br>
                üìä Rental yield calculations<br>
                üîç Due diligence checklists<br>
                ‚öñÔ∏è Risk assessment and mitigation<br><br>
                
                Click on any property marker on the map for detailed analysis, or ask me about specific aspects of Kigali's real estate market. I'm equipped with comprehensive data on pricing, infrastructure, amenities, and investment potential across all districts.<br><br>
                
                <strong>Popular Questions:</strong><br>
                ‚Ä¢ "What are the best investment areas in Kigali?"<br>
                ‚Ä¢ "How do property prices compare between districts?"<br>
                ‚Ä¢ "What rental yields can I expect?"<br>
                ‚Ä¢ "Which areas are best for families?"<br><br>
                
                What would you like to explore in Kigali's property market today?`;
                 this.scrollToBottom();
            }
            
            generateAIResponse(question, property) {
                const messagesContainer = document.getElementById('chatMessages');
                let response = '';
                
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('school') || lowerQuestion.includes('education')) {
                    response = this.generateSchoolResponse(property);
                } else if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                    response = this.generateHealthResponse(property);
                } else if (lowerQuestion.includes('price') || lowerQuestion.includes('cost') || lowerQuestion.includes('investment')) {
                    response = this.generatePriceResponse(property);
                } else if (lowerQuestion.includes('family') || lowerQuestion.includes('children')) {
                    response = this.generateFamilyResponse(property);
                } else {
                    response = this.generateGeneralResponse(property);
                }
                
                messagesContainer.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${response}</div>
                    </div>`;
                
                this.scrollToBottom();
            }
            
            generateSchoolResponse(property) {
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>üéì Education Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbySchools.length > 0) {
                    response += `Great news for families! Found <strong>${this.nearbySchools.length} schools</strong> within 2km:<br><br>`;
                    
                    this.nearbySchools.slice(0, 3).forEach(school => {
                        const walkTime = Math.round(school.distance * 12);
                        response += `üìö <strong>${school.school_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${school.school_status} (${school.curriculum})<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${(school.distance * 1000).toFixed(0)}m (~${walkTime} min walk)<br><br>`;
                    });
                    
                    response += `This property offers excellent educational access for families with children!`;
                } else {
                    response += `No schools found within 2km of this property.<br><br>`;
                    response += `<strong>Recommendations:</strong><br>`;
                    response += `‚Ä¢ Consider school transport services<br>`;
                    response += `‚Ä¢ Look into private school bus routes<br>`;
                    response += `‚Ä¢ Factor in daily commute time for school runs`;
                }
                
                return response;
            }
            
            generateHealthResponse(property) {
                this.clearNearbyMarkers();
                this.showNearbyFacilities(property);
                
                let response = `<h4>üè• Healthcare Analysis for ${property.name}</h4><br>`;
                
                if (this.nearbyHospitals.length > 0) {
                    response += `Excellent healthcare coverage! <strong>${this.nearbyHospitals.length} health facilities</strong> within 3km:<br><br>`;
                    
                    this.nearbyHospitals.slice(0, 3).forEach(hospital => {
                        response += `üè• <strong>${hospital.facility_name}</strong><br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Type: ${hospital.facility_type}<br>`;
                        response += `&nbsp;&nbsp;&nbsp;‚Ä¢ Distance: ${hospital.distance.toFixed(1)}km<br><br>`;
                    });
                    
                    response += `Emergency response time: approximately 5-15 minutes depending on traffic.`;
                } else {
                    response += `Limited healthcare access - no major facilities within 3km.<br><br>`;
                    response += `<strong>Important considerations:</strong><br>`;
                    response += `‚Ä¢ Emergency response may take 20+ minutes<br>`;
                    response += `‚Ä¢ Consider proximity to main roads for ambulance access<br>`;
                    response += `‚Ä¢ Keep emergency contact numbers and first aid supplies ready`;
                }
                
                return response;
            }
            
            generatePriceResponse(property) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                let response = `<h4>üí∞ Investment Analysis for ${property.name}</h4><br>`;
                
                response += `<strong>Current Price:</strong> ${property.price}<br>`;
                response += `<strong>Price per m¬≤:</strong> ${Math.round(priceValue * 1000000 / parseInt(property.area))} RWF/m¬≤<br><br>`;
                
                let investmentScore = 60;
                if (property.district === 'Gasabo') investmentScore += 15;
                else if (property.district === 'Nyarugenge') investmentScore += 10;
                else investmentScore += 5;
                
                investmentScore += Math.min(this.nearbySchools.length * 5, 15);
                investmentScore += Math.min(this.nearbyHospitals.length * 3, 10);
                
                response += `<strong>Investment Score: ${Math.min(investmentScore, 100)}/100</strong><br><br>`;
                
                if (property.status === 'sale') {
                    const estimatedRent = Math.round(priceValue * 0.5);
                    response += `<strong>Rental Potential:</strong><br>`;
                    response += `‚Ä¢ Estimated monthly rent: ${estimatedRent}K RWF<br>`;
                    response += `‚Ä¢ Annual yield: ~6%<br><br>`;
                }
                
                response += `<strong>Value Drivers:</strong><br>`;
                response += `‚Ä¢ ${this.nearbySchools.length} schools nearby<br>`;
                response += `‚Ä¢ ${this.nearbyHospitals.length} health facilities<br>`;
                response += `‚Ä¢ ${property.district} district location<br>`;
                response += `‚Ä¢ Built in ${property.yearBuilt} (${2025 - property.yearBuilt} years old)`;
                
                return response;
            }
            
            generateFamilyResponse(property) {
                let response = `<h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Suitability Analysis</h4><br>`;
                
                let familyScore = 50;
                
                if (property.bedrooms >= 4) familyScore += 20;
                else if (property.bedrooms >= 3) familyScore += 15;
                else if (property.bedrooms >= 2) familyScore += 10;
                
                if (this.nearbySchools.length >= 3) familyScore += 20;
                else if (this.nearbySchools.length >= 1) familyScore += 10;
                
                if (this.nearbyHospitals.length >= 2) familyScore += 10;
                else if (this.nearbyHospitals.length >= 1) familyScore += 5;
                
                response += `<strong>Family Score: ${Math.min(familyScore, 100)}/100</strong><br><br>`;
                
                response += `<strong>Space Assessment:</strong><br>`;
                response += `‚Ä¢ ${property.bedrooms} bedrooms, ${property.bathrooms} bathrooms<br>`;
                response += `‚Ä¢ Total area: ${property.area}<br>`;
                response += `‚Ä¢ Suitable for ${property.bedrooms <= 2 ? 'small families' : property.bedrooms <= 4 ? 'medium families' : 'large families'}<br><br>`;
                
                response += `<strong>Child-Friendly Features:</strong><br>`;
                response += `‚Ä¢ Education: ${this.nearbySchools.length} schools within 2km<br>`;
                response += `‚Ä¢ Healthcare: ${this.nearbyHospitals.length} health facilities within 3km<br>`;
                response += `‚Ä¢ Safety: ${property.amenities && property.amenities.includes('Security') ? 'Secured compound' : 'Check security measures'}<br>`;
                response += `‚Ä¢ Recreation: ${property.amenities && property.amenities.includes('Garden') ? 'Garden space available' : 'Limited outdoor space'}<br><br>`;
                
                if (familyScore >= 80) {
                    response += `<strong>Verdict:</strong> üèÜ Excellent choice for families with children!`;
                } else if (familyScore >= 60) {
                    response += `<strong>Verdict:</strong> üëç Good option for families with some planning.`;
                } else {
                    response += `<strong>Verdict:</strong> üíº Better suited for professionals or couples without children.`;
                }
                
                return response;
            }
            
            generateGeneralResponse(property) {
                let response = `<h4>üè† Complete Property Overview</h4><br>`;
                
                response += `I can provide detailed insights about <strong>${property.name}</strong>:<br><br>`;
                
                response += `<strong>Available Analysis:</strong><br>`;
                response += `‚Ä¢ üéì <strong>Education:</strong> ${this.nearbySchools.length} schools within 2km<br>`;
                response += `‚Ä¢ üè• <strong>Healthcare:</strong> ${this.nearbyHospitals.length} health facilities within 3km<br>`;
                response += `‚Ä¢ üí∞ <strong>Investment potential</strong> and pricing analysis<br>`;
                response += `‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <strong>Family suitability</strong> assessment<br>`;
                response += `‚Ä¢ üöó <strong>Transportation</strong> and accessibility<br><br>`;
                
                response += `<strong>Quick Facts:</strong><br>`;
                response += `‚Ä¢ Location: ${property.district} District<br>`;
                response += `‚Ä¢ Size: ${property.bedrooms}BR, ${property.bathrooms}BA, ${property.area}<br>`;
                response += `‚Ä¢ Year Built: ${property.yearBuilt}<br>`;
                response += `‚Ä¢ Status: ${property.status === 'sale' ? 'For Sale' : 'For Rent'}<br><br>`;
                
                response += `What specific aspect would you like me to analyze in detail?`;
                
                return response;
            }
            
            showTyping() {
                document.getElementById('typingIndicator').classList.add('show');
            }
            
            hideTyping() {
                document.getElementById('typingIndicator').classList.remove('show');
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        }
        
        let propertyIntel = null;
        
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            chatContainer.classList.toggle('collapsed');
            
            if (chatContainer.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
            }
            
            if (propertyIntel) propertyIntel.map.invalidateSize();
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            propertyIntel = new PropertyIntelSystem();
        });
    </script>
</body>
</html>
