<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyIntel Kigali - Enhanced</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Desktop Layout - Chat on Left */
        .chat-container {
            width: 380px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.1);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        /* Mobile Layout - Chat at Bottom */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .chat-container {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                order: 2;
            }
            .map-container {
                height: 60vh;
                order: 1;
            }
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 1.3rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-header small {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
            display: block;
            margin-top: 4px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
            background: rgba(10, 10, 15, 0.3);
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px 15px 15px 4px;
            padding: 12px 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
        }
        
        .message.ai .message-content::before {
            content: '🤖';
            position: absolute;
            left: -25px;
            top: 8px;
            font-size: 1.2rem;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 200, 100, 0.15) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px 15px 4px 15px;
            padding: 12px 15px;
            font-size: 0.9rem;
            margin-left: auto;
            max-width: 80%;
            position: relative;
        }
        
        .message.user .message-content::after {
            content: '👤';
            position: absolute;
            right: -25px;
            top: 8px;
            font-size: 1.2rem;
        }
        
        .chat-input-container {
            padding: 15px;
            background: rgba(10, 10, 15, 0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            max-height: 100px;
        }
        
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        
        .send-btn {
            margin-top: 10px;
            padding: 12px 24px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .property-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .property-marker:hover {
            transform: scale(1.2);
        }
        
        .property-marker.sale {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        .property-marker.rent {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .property-marker.special {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .hospital-marker {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        .hospital-marker:hover {
            transform: scale(1.3);
        }
        
        .location-info {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        .location-info .status-sale { color: #ff6b6b; font-weight: bold; }
        .location-info .status-rent { color: #667eea; font-weight: bold; }
        .location-info .status-special { color: #ffd700; font-weight: bold; }
        
        .hospital-proximity {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .hospital-list {
            margin-top: 10px;
        }
        
        .hospital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hospital-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .hospital-name {
            font-weight: 600;
            color: #00ff88;
        }
        
        .hospital-distance {
            color: #ccc;
            font-size: 0.8rem;
        }
        
        .buffer-hospital {
            fill: rgba(102, 126, 234, 0.15);
            stroke: #667eea;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        .insight-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            font-weight: 600;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #667eea;
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                <i class="fas fa-brain"></i> PropertyIntel Kigali 
                <small>🏠 AI Real Estate Advisor with Health Proximity Analytics</small>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Welcome to PropertyIntel Kigali! 🏠✨<br><br>
                        I'm your AI real estate advisor. Click on any property to get instant insights about:
                        <br>• Hospital proximity (WHO 5km standard)
                        <br>• Property investment potential
                        <br>• Neighborhood analysis
                        <br>• Health facility accessibility
                        <br><br>
                        <strong>Click a property marker to get started!</strong>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                🤖 AI is analyzing...
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask me anything about this property..." rows="1" disabled></textarea>
                <button class="send-btn" id="sendBtn" disabled><i class="fas fa-paper-plane"></i> Send Message</button>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentLocation, currentProperty, bufferLayers = [], facilities = [], hospitalMarkers = [];
        let nearbyHospitals = [];

        // Sample property data with more details
        const properties = [
            { 
                lat: -1.9286, lng: 30.1044, 
                name: 'Sunset Villa', type: 'Villa', 
                price: '120M RWF', status: 'sale',
                bedrooms: 4, bathrooms: 3,
                area: '350m²', yearBuilt: 2020
            },
            { 
                lat: -1.9506, lng: 30.0939, 
                name: 'City View Apartment', type: 'Apartment', 
                price: '45M RWF', status: 'rent',
                bedrooms: 2, bathrooms: 2,
                area: '120m²', yearBuilt: 2018
            },
            { 
                lat: -1.9634, lng: 30.1029, 
                name: 'Green Hills House', type: 'House', 
                price: '65M RWF', status: 'sale',
                bedrooms: 3, bathrooms: 2,
                area: '200m²', yearBuilt: 2019
            },
            { 
                lat: -1.9456, lng: 30.0612, 
                name: 'Golden Premium Villa', type: 'Luxury Villa', 
                price: '250M RWF', status: 'sale',
                bedrooms: 5, bathrooms: 4,
                area: '500m²', yearBuilt: 2021
            }
        ];

        async function loadFacilities() {
            try {
                const response = await fetch('https://gilbert-uwonkunda.github.io/estateKigali/Kigali_Health.json');
                const data = await response.json();
                facilities = data.facilities || [];
                console.log('Loaded facilities:', facilities.length);
            } catch (error) {
                console.error('Failed to load facilities:', error);
                // Fallback data
                facilities = [
                    { facility_name: "King Faisal Hospital", facility_type: "Hospital", lat: -1.9300, long: 30.1200 },
                    { facility_name: "CHUK Hospital", facility_type: "Referral Hospital", lat: -1.9600, long: 30.0800 },
                    { facility_name: "Kigali General Hospital", facility_type: "Hospital", lat: -1.9400, long: 30.1000 },
                    { facility_name: "Rwanda Military Hospital", facility_type: "Military Hospital", lat: -1.9350, long: 30.1100 },
                    { facility_name: "Polyclinic du Plateau", facility_type: "Clinic", lat: -1.9450, long: 30.0950 }
                ];
            }
        }

        function initializeMap() {
            map = L.map('map').setView([-1.9441, 30.0619], 12);
            
            // Enhanced map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            addProperties();
            addHospitals();
            
            map.on('click', handleMapClick);
        }

        function addProperties() {
            properties.forEach(prop => {
                const isSpecial = prop.type.includes('Luxury') || prop.type.includes('Premium');
                const marker = L.marker([prop.lat, prop.lng], {
                    icon: L.divIcon({
                        className: `property-marker ${isSpecial ? 'special' : prop.status}`,
                        html: `<div style="width: 24px; height: 24px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                marker.bindTooltip(
                    `<strong>${prop.name}</strong><br>
                    ${prop.price}<br>
                    ${prop.bedrooms}BR • ${prop.bathrooms}BA • ${prop.area}`, 
                    { direction: 'top', offset: [0, -10] }
                );
                
                marker.on('click', () => selectProperty(prop));
            });
        }

        function addHospitals() {
            hospitalMarkers = [];
            facilities.forEach(facility => {
                if (facility.facility_type.toLowerCase().includes('hospital') || 
                    facility.facility_type.toLowerCase().includes('clinic')) {
                    const marker = L.marker([facility.lat, facility.long], {
                        icon: L.divIcon({
                            className: 'hospital-marker',
                            html: `<div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00ff88, #00cc6a); border: 3px solid white; border-radius: 50%;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    marker.bindTooltip(
                        `<strong>${facility.facility_name}</strong><br>
                        Type: ${facility.facility_type}`, 
                        { direction: 'top', offset: [0, -10] }
                    );
                    
                    hospitalMarkers.push(marker);
                }
            });
        }

        function selectProperty(property) {
            currentProperty = property;
            currentLocation = L.latLng(property.lat, property.lng);
            
            // Enable chat
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // Clear previous analysis
            clearBuffers();
            
            // Analyze hospital proximity
            analyzeHospitalProximity(property);
            
            // Generate AI insights
            generatePropertyInsights(property);
            
            // Center map on property
            map.setView([property.lat, property.lng], 15);
        }

        function analyzeHospitalProximity(property) {
            nearbyHospitals = [];
            
            facilities.forEach(facility => {
                if (facility.facility_type.toLowerCase().includes('hospital') || 
                    facility.facility_type.toLowerCase().includes('clinic')) {
                    const distance = L.latLng(property.lat, property.lng)
                        .distanceTo([facility.lat, facility.long]) / 1000;
                    
                    if (distance <= 5) {
                        nearbyHospitals.push({
                            ...facility,
                            distance: distance
                        });
                        
                        // Add buffer circle
                        const buffer = L.circle([facility.lat, facility.long], {
                            radius: 5000,
                            className: 'buffer-hospital',
                            fillOpacity: 0.15,
                            color: '#667eea',
                            weight: 2,
                            dashArray: '5,5'
                        }).addTo(map);
                        
                        bufferLayers.push(buffer);
                    }
                }
            });
            
            // Sort by distance
            nearbyHospitals.sort((a, b) => a.distance - b.distance);
            
            displayProximityAnalysis(property);
        }

        function displayProximityAnalysis(property) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Property info
            const statusClass = property.type.includes('Luxury') ? 'status-special' : 
                               property.status === 'sale' ? 'status-sale' : 'status-rent';
            
            messagesContainer.innerHTML += `
                <div class="location-info">
                    <strong>🏠 ${property.name}</strong><br>
                    <strong>Type:</strong> ${property.type}<br>
                    <strong>Price:</strong> ${property.price}<br>
                    <strong>Details:</strong> ${property.bedrooms}BR • ${property.bathrooms}BA • ${property.area}<br>
                    <strong>Year Built:</strong> ${property.yearBuilt}<br>
                    <span class="${statusClass}">Status: ${property.status.charAt(0).toUpperCase() + property.status.slice(1)}</span>
                </div>`;
            
            // Hospital proximity analysis
            if (nearbyHospitals.length > 0) {
                let hospitalHtml = `
                    <div class="hospital-proximity">
                        <strong>🏥 Hospital Proximity Analysis</strong><br>
                        <small>WHO Standard: 5km walking distance</small>
                        <div class="hospital-list">`;
                
                nearbyHospitals.forEach(hospital => {
                    hospitalHtml += `
                        <div class="hospital-item" onclick="focusHospital(${hospital.lat}, ${hospital.long})">
                            <div>
                                <div class="hospital-name">${hospital.facility_name}</div>
                                <div style="font-size: 0.75rem; color: #999;">${hospital.facility_type}</div>
                            </div>
                            <div class="hospital-distance">${hospital.distance.toFixed(1)}km</div>
                        </div>`;
                });
                
                hospitalHtml += `</div></div>`;
                messagesContainer.innerHTML += hospitalHtml;
            } else {
                messagesContainer.innerHTML += `
                    <div class="hospital-proximity">
                        <strong>⚠️ Hospital Proximity Alert</strong><br>
                        No hospitals within WHO standard 5km walking distance.<br>
                        <small>Consider transportation accessibility for healthcare needs.</small>
                    </div>`;
            }
            
            scrollToBottom();
        }

        function generatePropertyInsights(property) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Show typing indicator
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                let insights = `
                    <div class="ai-insights">
                        <strong>🤖 AI Property Analysis</strong><br><br>`;
                
                // Health accessibility insight
                if (nearbyHospitals.length > 0) {
                    insights += `<span class="insight-tag">Excellent Health Access</span>`;
                    insights += `<br>✅ ${nearbyHospitals.length} healthcare facilities within 5km WHO standard<br>`;
                } else {
                    insights += `<span class="insight-tag">Health Access Concern</span>`;
                    insights += `<br>⚠️ Limited healthcare accessibility - consider transportation needs<br>`;
                }
                
                // Property type insights
                if (property.type.includes('Luxury') || property.type.includes('Premium')) {
                    insights += `<span class="insight-tag">Premium Property</span>`;
                    insights += `<br>🌟 High-end property with excellent specifications<br>`;
                } else if (property.type === 'Apartment') {
                    insights += `<span class="insight-tag">Urban Living</span>`;
                    insights += `<br>🏙️ City living with convenient amenities<br>`;
                } else {
                    insights += `<span class="insight-tag">Family Home</span>`;
                    insights += `<br>🏡 Great for family living with privacy<br>`;
                }
                
                // Investment potential
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    insights += `<span class="insight-tag">High Value Investment</span>`;
                } else if (priceValue > 50) {
                    insights += `<span class="insight-tag">Mid-Range Investment</span>`;
                } else {
                    insights += `<span class="insight-tag">Entry Level Investment</span>`;
                }
                
                insights += `<br><br><strong>Ask me anything about this property!</strong></div>`;
                
                messagesContainer.innerHTML += insights;
                scrollToBottom();
            }, 2000);
        }

        function focusHospital(lat, lng) {
            map.setView([lat, lng], 17);
        }

        function clearBuffers() {
            bufferLayers.forEach(layer => map.removeLayer(layer));
            bufferLayers = [];
        }

        function handleMapClick(e) {
            // Handle clicks on empty map areas
            if (!currentProperty) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            Please click on a property marker (colored circles) to get detailed analysis and proximity insights! 🏠
                        </div>
                    </div>`;
                scrollToBottom();
            }
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || !currentProperty) return;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `
                <div class="message user">
                    <div class="message-content">${message}</div>
                </div>`;
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Show typing and generate AI response
            showTyping();
            setTimeout(() => {
                hideTyping();
                generateAIResponse(message, currentProperty);
            }, 1500);
            
            scrollToBottom();
        }

        function generateAIResponse(question, property) {
            const messagesContainer = document.getElementById('chatMessages');
            let response = '';
            
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('hospital') || lowerQuestion.includes('health') || lowerQuestion.includes('medical')) {
                if (nearbyHospitals.length > 0) {
                    response = `Great question about healthcare access! 🏥<br><br>This property has excellent healthcare accessibility with ${nearbyHospitals.length} facilities within the WHO 5km standard:<br><br>`;
                    nearbyHospitals.slice(0, 3).forEach(h => {
                        response += `• <strong>${h.facility_name}</strong> (${h.facility_type}) - ${h.distance.toFixed(1)}km<br>`;
                    });
                    response += `<br>This significantly adds to the property's value and livability! ✨`;
                } else {
                    response = `Healthcare accessibility is a concern for this property. 🚨<br><br>No hospitals within the WHO recommended 5km walking distance. You'd need to consider:<br>• Private transportation<br>• Emergency response times<br>• Regular healthcare access<br><br>This might affect property value and family suitability.`;
                }
            } else if (lowerQuestion.includes('investment') || lowerQuestion.includes('value') || lowerQuestion.includes('profit')) {
                const priceValue = parseInt(property.price.replace(/[^0-9]/g, ''));
                if (priceValue > 100) {
                    response = `This is a premium investment opportunity! 💰<br><br>At ${property.price}, you're looking at the luxury market segment. Key factors:<br>• High-end specifications (${property.area}, ${property.bedrooms}BR)<br>• ${nearbyHospitals.length > 0 ? 'Excellent healthcare access ✅' : 'Limited healthcare access ⚠️'}<br>• Built in ${property.yearBuilt} - relatively new<br><br>Expected appreciation: 8-12% annually for premium properties in Kigali.`;
                } else {
                    response = `Solid investment potential! 📈<br><br>At ${property.price}, this offers good entry-level investment value:<br>• ${property.area} living space<br>• ${nearbyHospitals.length > 0 ? 'Good healthcare proximity' : 'Consider healthcare access'}<br>• ${property.yearBuilt} construction<br><br>Expected growth: 6-10% annually in this market segment.`;
                }
            } else if (lowerQuestion.includes('neighborhood') || lowerQuestion.includes('area') || lowerQuestion.includes('location')) {
                response = `Great location question!
